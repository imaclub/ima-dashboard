<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMA Dashboard — Tour de Contrôle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bordeaux: #581527;
      --bordeaux-light: #7a2d42;
      --bordeaux-dark: #3d0e1b;
      --bordeaux-10: rgba(88,21,39,0.1);
      --bordeaux-20: rgba(88,21,39,0.2);
      --blanc: #FFFFFF;
      --gris-50: #f9fafb; --gris-100: #f3f4f6; --gris-200: #e5e7eb;
      --gris-300: #d1d5db; --gris-400: #9ca3af; --gris-500: #6b7280;
      --gris-600: #4b5563; --gris-700: #374151; --gris-800: #1f2937; --gris-900: #111827;
      --vert: #059669; --vert-light: #d1fae5;
      --rouge: #dc2626; --rouge-light: #fee2e2;
      --orange: #d97706; --orange-light: #fef3c7;
      --bleu: #2563eb; --bleu-light: #dbeafe;
      --sidebar-w: 256px;
    }
    body { font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--gris-50); color:var(--gris-900); line-height:1.5; -webkit-font-smoothing:antialiased; }
    ::-webkit-scrollbar{width:5px} ::-webkit-scrollbar-track{background:transparent} ::-webkit-scrollbar-thumb{background:var(--gris-300);border-radius:3px}

    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{width:var(--sidebar-w);background:var(--bordeaux);color:var(--blanc);position:fixed;top:0;left:0;bottom:0;display:flex;flex-direction:column;z-index:50}
    .sidebar-logo{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;gap:2px}
    .sidebar-logo h1{font-size:32px;font-weight:300;letter-spacing:6px}
    .sidebar-logo span{font-size:10px;opacity:.5;letter-spacing:2px;text-transform:uppercase}
    .sidebar-nav{flex:1;padding:16px 10px;overflow-y:auto}
    .nav-sec{margin-bottom:20px}
    .nav-sec-title{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.35);padding:0 12px;margin-bottom:6px;font-weight:600}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;transition:all .15s;font-size:13px;color:rgba(255,255,255,.65);font-weight:400;margin-bottom:1px}
    .nav-item:hover{background:rgba(255,255,255,.08);color:var(--blanc)}
    .nav-item.active{background:rgba(255,255,255,.14);color:var(--blanc);font-weight:500}
    .nav-item svg{width:17px;height:17px;opacity:.75;flex-shrink:0}
    .nav-item.active svg{opacity:1}
    .sidebar-foot{padding:14px 18px;border-top:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:10px}
    .avatar{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600}
    .uname{font-size:13px;font-weight:500}
    .urole{font-size:10px;opacity:.5}

    /* Main */
    .main{margin-left:var(--sidebar-w);flex:1;min-height:100vh}
    .header{background:var(--blanc);border-bottom:1px solid var(--gris-200);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40}
    .header-l{display:flex;align-items:center;gap:14px}
    .header-l h2{font-size:18px;font-weight:600}
    .header-l .bc{font-size:12px;color:var(--gris-400)}
    .header-r{display:flex;align-items:center;gap:14px}
    .loc{display:flex;align-items:center;gap:6px;background:var(--gris-100);padding:7px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;border:1px solid var(--gris-200)}
    .loc:hover{border-color:var(--bordeaux)}
    .loc-dot{width:7px;height:7px;border-radius:50%;background:var(--vert)}
    .per{display:flex;background:var(--gris-100);border-radius:7px;padding:2px;border:1px solid var(--gris-200)}
    .per-btn{padding:5px 12px;border-radius:5px;font-size:11px;font-weight:500;cursor:pointer;border:none;background:transparent;color:var(--gris-500);font-family:inherit}
    .per-btn.active{background:var(--blanc);color:var(--bordeaux);box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .page{padding:22px 28px}

    /* Cards */
    .card{background:var(--blanc);border-radius:12px;border:1px solid var(--gris-200);margin-bottom:16px;overflow:hidden}
    .card-h{padding:18px 22px 0;display:flex;justify-content:space-between;align-items:flex-start}
    .card-t{font-size:14px;font-weight:600;color:var(--gris-800)}
    .card-st{font-size:11px;color:var(--gris-400);margin-top:2px}
    .card-b{padding:14px 22px 18px}

    /* KPI */
    .kpi-g{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
    .kpi{background:var(--blanc);border:1px solid var(--gris-200);border-radius:12px;padding:18px;transition:all .2s}
    .kpi:hover{border-color:var(--bordeaux-20);box-shadow:0 4px 12px rgba(88,21,39,.06)}
    .kpi-label{font-size:11px;font-weight:500;color:var(--gris-500);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
    .kpi-val{font-size:26px;font-weight:700;line-height:1.2}
    .kpi-chg{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:500;margin-top:6px;padding:2px 8px;border-radius:20px}
    .kpi-chg.pos{color:var(--vert);background:var(--vert-light)}
    .kpi-chg.neg{color:var(--rouge);background:var(--rouge-light)}
    .kpi-chg.neu{color:var(--orange);background:var(--orange-light)}

    /* Charts grid */
    .cg{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:20px}
    .cg .fw{grid-column:1/-1}

    /* Bar chart CSS */
    .bars{display:flex;align-items:flex-end;gap:8px;height:180px;padding-top:10px}
    .bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
    .bar-stack{width:100%;display:flex;flex-direction:column;justify-content:flex-end;height:160px;gap:1px}
    .bar-seg{border-radius:3px 3px 0 0;transition:height .5s ease;min-height:0;position:relative}
    .bar-seg:hover{opacity:.85}
    .bar-lbl{font-size:10px;color:var(--gris-500);font-weight:500}
    .bar-val{font-size:9px;color:var(--gris-400);text-align:center}

    /* Line chart CSS */
    .line-chart{position:relative;height:180px}
    .line-chart svg{width:100%;height:100%}

    /* Donut */
    .donut-wrap{display:flex;align-items:center;justify-content:center;gap:24px;padding:10px 0}
    .donut{position:relative;width:140px;height:140px}
    .donut svg{transform:rotate(-90deg)}
    .donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .donut-center .dv{font-size:22px;font-weight:700}
    .donut-center .dl{font-size:10px;color:var(--gris-500)}
    .donut-legend{display:flex;flex-direction:column;gap:8px}
    .donut-legend-item{display:flex;align-items:center;gap:8px;font-size:12px}
    .donut-legend-dot{width:10px;height:10px;border-radius:3px}

    /* Cost cards */
    .cost-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
    .cost-c{background:var(--blanc);border:1px solid var(--gris-200);border-radius:12px;padding:20px;text-align:center}
    .cost-c .cl{font-size:12px;color:var(--gris-500);margin-bottom:6px;font-weight:500}
    .cost-c .cv{font-size:32px;font-weight:700;color:var(--bordeaux)}
    .cost-c .ct{font-size:11px;color:var(--gris-400);margin-top:4px}
    .pbar{height:6px;background:var(--gris-100);border-radius:3px;overflow:hidden;margin-top:8px}
    .pfill{height:100%;border-radius:3px;transition:width .5s ease}

    /* Tables */
    .tbl{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:10px 14px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--gris-500);border-bottom:1px solid var(--gris-200);background:var(--gris-50)}
    td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--gris-100);color:var(--gris-700)}
    tr:hover td{background:var(--gris-50)}

    /* Badges */
    .badge{display:inline-flex;align-items:center;padding:2px 9px;border-radius:20px;font-size:10px;font-weight:500}
    .b-ok{background:var(--vert-light);color:var(--vert)}
    .b-err{background:var(--rouge-light);color:var(--rouge)}
    .b-warn{background:var(--orange-light);color:var(--orange)}
    .b-info{background:var(--bleu-light);color:var(--bleu)}
    .b-ima{background:var(--bordeaux-10);color:var(--bordeaux)}

    /* Tabs */
    .tabs{display:flex;border-bottom:1px solid var(--gris-200);margin-bottom:20px}
    .tab{padding:10px 18px;font-size:13px;font-weight:500;color:var(--gris-500);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
    .tab:hover{color:var(--gris-700)}
    .tab.active{color:var(--bordeaux);border-bottom-color:var(--bordeaux)}

    /* Alert items */
    .alert-i{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-radius:8px;margin-bottom:6px;font-size:12px}
    .alert-i.a-err{background:var(--rouge-light)}
    .alert-i.a-warn{background:var(--orange-light)}
    .alert-i.a-info{background:var(--bleu-light)}
    .alert-i .at{font-weight:500;font-size:13px}
    .alert-i .as{font-size:11px;opacity:.7;margin-top:2px}

    /* Reservation item */
    .resa{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--gris-100)}
    .resa:last-child{border:none}
    .resa-l{display:flex;align-items:center;gap:10px}
    .resa-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--blanc)}
    .resa-name{font-size:13px;font-weight:500}
    .resa-det{font-size:11px;color:var(--gris-400)}
    .resa-r{text-align:right}
    .resa-time{font-size:14px;font-weight:600;color:var(--gris-700)}
    .resa-pax{font-size:11px;color:var(--gris-400)}

    /* Notif */
    .notif{position:relative;cursor:pointer;padding:6px}
    .notif::after{content:'3';position:absolute;top:0;right:0;width:15px;height:15px;border-radius:50%;background:var(--rouge);color:white;font-size:8px;display:flex;align-items:center;justify-content:center;font-weight:700}

    /* Login */
    .login{min-height:100vh;display:flex;background:var(--bordeaux)}
    .login-c{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px}
    .login-logo{font-size:64px;font-weight:300;letter-spacing:12px;color:var(--blanc);margin-bottom:6px}
    .login-tag{font-size:12px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.45);margin-bottom:40px}
    .login-form{width:100%;max-width:360px;background:var(--blanc);border-radius:14px;padding:36px}
    .login-form h3{font-size:18px;font-weight:600;margin-bottom:20px}
    .fg{margin-bottom:16px}
    .fl{display:block;font-size:11px;font-weight:500;color:var(--gris-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
    .fi{width:100%;padding:10px 14px;border:1px solid var(--gris-200);border-radius:8px;font-size:14px;font-family:inherit;outline:none;transition:all .15s}
    .fi:focus{border-color:var(--bordeaux);box-shadow:0 0 0 3px var(--bordeaux-10)}
    .login-btn{width:100%;padding:11px;background:var(--bordeaux);color:var(--blanc);border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;letter-spacing:.5px;transition:all .15s}
    .login-btn:hover{background:var(--bordeaux-light)}

    /* Anim */
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .fin{animation:fadeIn .3s ease}

    /* Modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:100}
    .modal{background:var(--blanc);border-radius:14px;padding:28px;width:480px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
    .modal h3{font-size:17px;font-weight:600;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center}
    .modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--gris-400);padding:4px 8px}
    .modal-close:hover{color:var(--gris-700)}
    .fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;border:none;transition:all .15s}
    .btn-primary{background:var(--bordeaux);color:var(--blanc)}
    .btn-primary:hover{background:var(--bordeaux-light)}
    .btn-secondary{background:var(--gris-100);color:var(--gris-700);border:1px solid var(--gris-200)}
    .btn-secondary:hover{background:var(--gris-200)}
    .btn-sm{padding:6px 12px;font-size:11px}

    /* Tips table */
    .tips-grid{overflow-x:auto}
    .tips-grid table th,.tips-grid table td{padding:8px 10px;font-size:12px;text-align:center;white-space:nowrap}
    .tips-grid table th{font-size:10px}
    .tips-grid table td input{width:55px;padding:4px 6px;border:1px solid var(--gris-200);border-radius:5px;font-size:12px;text-align:center;font-family:inherit;outline:none}
    .tips-grid table td input:focus{border-color:var(--bordeaux);box-shadow:0 0 0 2px var(--bordeaux-10)}
    .tips-grid .day-header{background:var(--bordeaux);color:white;font-weight:600;font-size:11px}
    .tips-grid .total-row td{background:var(--gris-50);font-weight:700;border-top:2px solid var(--gris-300)}
    .tips-grid .penalty-cell{color:var(--rouge);font-weight:600}
    .tips-grid .bonus-cell{color:var(--vert);font-weight:600}
    .presence-dot{width:20px;height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;font-weight:700;transition:all .15s}
    .presence-dot.present{background:var(--vert-light);color:var(--vert)}
    .presence-dot.absent{background:var(--rouge-light);color:var(--rouge)}

    /* Select */
    .fi-select{width:100%;padding:10px 14px;border:1px solid var(--gris-200);border-radius:8px;font-size:14px;font-family:inherit;outline:none;background:var(--blanc);transition:all .15s;appearance:none;cursor:pointer}
    .fi-select:focus{border-color:var(--bordeaux);box-shadow:0 0 0 3px var(--bordeaux-10)}

    /* Pennylane Integration */
    .toggle-group{display:flex;gap:8px;align-items:center}
    .toggle-btn{padding:6px 14px;border-radius:6px;border:1px solid var(--gris-200);background:var(--blanc);color:var(--gris-600);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s}
    .toggle-btn.active{background:var(--bordeaux);color:var(--blanc);border-color:var(--bordeaux)}
    .toggle-btn:hover{border-color:var(--bordeaux)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--gris-200);border-top-color:var(--bordeaux);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status-indicator{width:10px;height:10px;border-radius:50%;display:inline-block}
    .status-indicator.connected{background:var(--vert)}
    .status-indicator.disconnected{background:var(--rouge)}
    .pw-toggle{position:relative;display:inline-flex;align-items:center}
    .pw-toggle-btn{background:none;border:none;cursor:pointer;padding:4px;color:var(--gris-500);margin-left:4px}
    .pw-toggle-btn:hover{color:var(--gris-700)}
    .input-with-btn{display:flex;gap:8px}
    .input-with-btn input{flex:1}
    .input-with-btn button{min-width:120px}
    .error-msg{color:var(--rouge);font-size:11px;margin-top:4px}
    .success-msg{color:var(--vert);font-size:11px;margin-top:4px}

    @media(max-width:1100px){.cg{grid-template-columns:1fr}.kpi-g{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useMemo}=React;

// ===== SVG ICONS =====
const I={
  Dash:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>,
  Fin:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
  Cost:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
  Staff:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  Stock:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>,
  CRM:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  POS:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>,
  Gear:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
  Bell:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
  Up:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
  Down:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
  Chev:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>,
  Pin:()=><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
  Warn:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  Cash:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><circle cx="9" cy="10" r="1"/><path d="M15 10h.01"/></svg>,
  Tips:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
};

// ===== FORMATTERS =====
const fmt=n=>new Intl.NumberFormat('fr-FR').format(n);
const eur=n=>new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n);

// ===== SUPPLIER MAPPING =====
// Professional restaurant cost categories with grouping
const COST_GROUPS={
  'Coûts Directs (Prime Cost)':{
    color:'var(--bordeaux)',cats:['Food','Bar','Staff'],
    desc:'Matières premières + masse salariale'
  },
  'Charges d\'Exploitation':{
    color:'var(--orange)',cats:['Hygiène & Entretien','Énergie & Fluides','Matériel & Équipement','Travaux & Maintenance','Blanchisserie'],
    desc:'Coûts opérationnels du restaurant'
  },
  'Charges Générales (G&A)':{
    color:'var(--bleu)',cats:['Loyer & Charges','Communication & Marketing','Administratif & Juridique','Transport & Véhicules','Assurances','IT & Logiciels','Divers'],
    desc:'Frais généraux et administratifs'
  },
  'Hors Exploitation':{
    color:'var(--gris-500)',cats:['Compte courant associé','Investissements','Non classé'],
    desc:'Opérations hors exploitation courante'
  }
};

const ALL_CATEGORIES=Object.values(COST_GROUPS).flatMap(g=>g.cats);
const CAT_COLORS={
  'Food':'#059669','Bar':'#581527','Staff':'#2563eb',
  'Hygiène & Entretien':'#d97706','Énergie & Fluides':'#dc2626','Matériel & Équipement':'#7c3aed',
  'Travaux & Maintenance':'#b45309','Blanchisserie':'#0891b2',
  'Loyer & Charges':'#475569','Communication & Marketing':'#c026d3','Administratif & Juridique':'#64748b',
  'Transport & Véhicules':'#374151','Assurances':'#6b7280','IT & Logiciels':'#4f46e5','Divers':'#9ca3af',
  'Compte courant associé':'#374151','Investissements':'#1e293b','Non classé':'#dc2626'
};

// Get the group name for a category
function getCatGroup(cat){
  for(const[group,info]of Object.entries(COST_GROUPS)){
    if(info.cats.includes(cat))return group;
  }
  return'Hors Exploitation';
}

const SupplierMap={
  CATEGORIES:ALL_CATEGORIES,

  _getMap(){
    try{return JSON.parse(localStorage.getItem('ima_supplier_map_v2')||'{}');}catch(e){return{};}
  },
  _saveMap(map){localStorage.setItem('ima_supplier_map_v2',JSON.stringify(map));},

  getCategory(supplierId){
    const map=this._getMap();
    return map[supplierId]||'Non classé';
  },

  setCategory(supplierId,category){
    const map=this._getMap();
    map[supplierId]=category;
    this._saveMap(map);
  },

  getAll(){return this._getMap();},

  extractName(invoice){
    const label=invoice.label||'';
    // Try to match: "Facture SUPPLIER_NAME - INVOICE_NUMBER (label généré)"
    const match=label.match(/^(?:Facture|Avoir)\s+(.+?)\s+-\s+(?:AVOIR\s+)?(?:VTE-)?[\w\/\-\.]+\s*(?:\(label|\-\s*[\d,\.]+\s*CHF)/i);
    if(match)return match[1].trim();
    // Simpler fallback
    const m2=label.match(/^(?:Facture|Avoir)\s+(.+?)\s+-\s+/i);
    if(m2)return m2[1].trim();
    return label.replace(/^(Facture|Avoir)\s+/i,'').replace(/\s*\(label.*$/,'').trim()||'Inconnu';
  },

  initDefaults(){
    const map=this._getMap();
    const defaults={
      '135128272':'Food','225921410':'Food',
      '135131297':'Bar',
      '138286809':'Travaux & Maintenance','213706779':'Travaux & Maintenance',
      '135132417':'Hygiène & Entretien','150618374':'Hygiène & Entretien',
      '157926754':'Transport & Véhicules',
      '148604506':'Matériel & Équipement',
      '135731681':'Communication & Marketing',
      '138599892':'Food',
      '135731679':'Compte courant associé',
    };
    let changed=false;
    for(const[id,cat]of Object.entries(defaults)){
      if(!map[id]){map[id]=cat;changed=true;}
    }
    if(changed)this._saveMap(map);
    return map;
  },

  categorize(invoices){
    const result={};
    ALL_CATEGORIES.forEach(c=>{result[c]=[];});
    invoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      const cat=this.getCategory(sid);
      if(!result[cat])result[cat]=[];
      result[cat].push(inv);
    });
    return result;
  },

  getTotals(invoices){
    const totals={};
    ALL_CATEGORIES.forEach(c=>{totals[c]=0;});
    invoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      const cat=this.getCategory(sid);
      totals[cat]=(totals[cat]||0)+parseFloat(inv.amount||0);
    });
    return totals;
  },

  getGroupTotals(totals){
    const groupTotals={};
    for(const[group,info]of Object.entries(COST_GROUPS)){
      groupTotals[group]=info.cats.reduce((s,c)=>s+(totals[c]||0),0);
    }
    return groupTotals;
  }
};

SupplierMap.initDefaults();

// ===== STAFF REGISTRY =====
const TIP_CATEGORIES={
  salle:{
    MANAGERS:{label:'Managers',defaultPoints:5,color:'var(--bordeaux)'},
    FLOOR:{label:'Floor',defaultPoints:4,color:'var(--orange)'},
    COMMIS:{label:'Commis',defaultPoints:2,color:'var(--bleu)'},
    BAR:{label:'Bar',defaultPoints:4,color:'#7c3aed'},
    HOTESSE:{label:'Hôtesse / Com',defaultPoints:1,color:'var(--gris-500)'}
  },
  cuisine:{
    CHEF:{label:'Chef & Sous-chefs',defaultPoints:2,color:'var(--vert)'}
  }
};

const StaffRegistry={
  _getAll(){
    try{return JSON.parse(localStorage.getItem('ima_staff_v1')||'[]');}catch(e){return[];}
  },
  _saveAll(list){localStorage.setItem('ima_staff_v1',JSON.stringify(list));},

  getAll(){return this._getAll();},
  getActive(){return this._getAll().filter(e=>e.active!==false);},
  getById(id){return this._getAll().find(e=>e.id===id);},

  getBySectionAndCategory(section,tipCategory){
    return this.getActive().filter(e=>e.section===section&&e.tipCategory===tipCategory);
  },
  getBySection(section){
    return this.getActive().filter(e=>e.section===section);
  },

  getTipsEligible(){return this.getActive().filter(e=>e.tips);},

  getResponsables(){return this.getActive().filter(e=>['Chef de cuisine','Resp. salle','Chef barman','Directeur','Manager'].includes(e.poste)||e.tipCategory==='MANAGERS');},

  add(employee){
    const all=this._getAll();
    const newEmp={
      id:Date.now(),
      nom:employee.nom||'',
      poste:employee.poste||'',
      section:employee.section||'salle',
      tipCategory:employee.tipCategory||'FLOOR',
      points:employee.points||TIP_CATEGORIES[employee.section||'salle']?.[employee.tipCategory||'FLOOR']?.defaultPoints||3,
      contrat:employee.contrat||'CDI',
      tel:employee.tel||'',
      dateEntree:employee.dateEntree||new Date().toLocaleDateString('fr-FR'),
      tips:employee.tips!==false,
      active:true,
      coutBrut:employee.coutBrut||0,
      heures:employee.heures||0,
      extras:employee.extras||0,
      ...employee
    };
    all.push(newEmp);
    this._saveAll(all);
    return newEmp;
  },

  update(id,updates){
    const all=this._getAll();
    const idx=all.findIndex(e=>e.id===id);
    if(idx>=0){all[idx]={...all[idx],...updates};this._saveAll(all);}
    return all[idx];
  },

  remove(id){
    const all=this._getAll().filter(e=>e.id!==id);
    this._saveAll(all);
  },

  deactivate(id){this.update(id,{active:false});},

  initDefaults(){
    // No default employees in production
  }
};

StaffRegistry.initDefaults();

// ===== TRIVEC SERVICE =====
const TrivecService={
  _key:'ima_trivec_data_v1',
  _getData(){try{return JSON.parse(localStorage.getItem(this._key)||'{}');}catch(e){return{};}},
  _saveData(d){localStorage.setItem(this._key,JSON.stringify(d));},

  // Parse "Suivi d'activité Journalier" Excel
  parseSuiviJournalier(file){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=(e)=>{
        try{
          const wb=XLSX.read(e.target.result,{type:'array'});
          const ws=wb.Sheets[wb.SheetNames[0]];
          const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:null});

          // Find date
          let dateStr='';
          for(const row of rows){if(row[0]&&typeof row[0]==='string'&&row[0].match(/\d{2}\/\d{2}\/\d{4}/)){dateStr=row[0].split(' - ')[0].trim();break;}}

          // Parse Ventes par Centre
          let ventes={total:0,restaurant:0,club:0,bar:0,food10:0,food20:0,drink10:0,drink20:0};
          let paiements={especes:0,cb:0,amex:0,aucun:0,sevenroom:0,total:0};
          let internes={total:0,details:[]};
          let couverts={restaurant:{total:0,avgCover:0},club:{total:0,avgCover:0},bar:{total:0,avgCover:0}};
          let shifts=[];

          let section='';
          for(let i=0;i<rows.length;i++){
            const r=rows[i];
            const c0=r[0]!=null?String(r[0]).trim():'';

            if(c0==='Ventes par Centre')section='ventes';
            else if(c0==='Paiements')section='paiements';
            else if(c0==='Comptes internes')section='internes';
            else if(c0==='Analyse Couverts')section='couverts';

            if(section==='ventes'){
              if(c0==='Grand Total'){
                ventes.total=Number(r[2])||0;
                ventes.restaurant=Number(r[4])||0;
                ventes.club=Number(r[6])||0;
                ventes.bar=Number(r[8])||0;
              }
              if(c0==='10'){
                const g1=r[1]!=null?String(r[1]).trim():'';
                // TVA 10%
                if(!g1){
                  ventes.food10=Number(r[2])||0;
                }
              }
              if(c0==='20'){
                ventes.drink20=Number(r[2])||0;
              }
              // Sub-categories under TVA
              if(!c0&&r[1]){
                const g1=String(r[1]).trim();
                if(g1==='NOURRITURE'&&section==='ventes'){
                  // Nourriture line
                }
                if(g1==='BOISSONS SS ALCOOL'){
                  ventes.drink10=Number(r[2])||0;
                }
                if(g1==='BOISSONS ALCOOLISEES'){
                  // Already captured in drink20
                }
              }
            }

            if(section==='paiements'){
              if(c0==='Especes')paiements.especes=Number(r[2])||0;
              else if(c0==='CB')paiements.cb=Number(r[2])||0;
              else if(c0==='Amex')paiements.amex=Number(r[2])||0;
              else if(c0==='Aucun Paiement')paiements.aucun=Number(r[2])||0;
              else if(c0==='SevenRoom')paiements.sevenroom=Number(r[2])||0;
              else if(c0==='Grand Total')paiements.total=Number(r[2])||0;
            }

            if(section==='internes'){
              if(c0==='Internal'){internes.total=Number(r[2])||0;}
              else if(!c0&&r[1]&&typeof r[1]==='string'&&r[1].trim().startsWith('Comp')){
                internes.details.push({nom:String(r[1]).trim(),montant:Number(r[2])||0});
              }
              else if(!c0&&r[1]&&typeof r[1]==='string'&&r[1].trim().startsWith('Conso')){
                internes.details.push({nom:String(r[1]).trim(),montant:Number(r[2])||0});
              }
            }

            if(section==='couverts'){
              if(c0==='Sales'){
                couverts.restaurant={total:Number(r[4])||0,avgCover:Number(r[5])||0};
                couverts.club={total:Number(r[6])||0,avgCover:Number(r[7])||0};
                couverts.bar={total:Number(r[8])||0,avgCover:Number(r[9])||0};
              }
              // Shifts
              if(!c0&&r[1]&&typeof r[1]==='string'){
                const shiftName=String(r[1]).trim();
                if(['DEJ','18H-23H','CLUB'].includes(shiftName)){
                  shifts.push({
                    shift:shiftName,
                    restaurant:{covers:Number(r[4])||0,avg:Number(r[5])||0},
                    club:{covers:Number(r[6])||0,avg:Number(r[7])||0},
                    bar:{covers:Number(r[8])||0,avg:Number(r[9])||0}
                  });
                }
              }
            }
          }

          const dayData={
            date:dateStr,
            parsedAt:new Date().toISOString(),
            ventes,paiements,internes,couverts,shifts,
            caTotal:ventes.total,
            ticketMoyen:couverts.restaurant.avgCover
          };

          // Save to localStorage by date
          const allData=this._getData();
          if(!allData.jours)allData.jours={};
          allData.jours[dateStr]=dayData;
          allData.lastImport=new Date().toISOString();
          this._saveData(allData);

          resolve(dayData);
        }catch(err){reject(err);}
      };
      reader.readAsArrayBuffer(file);
    });
  },

  // Parse "Rapport Assortiments de Produits" Excel
  parseAssortiments(file){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=(e)=>{
        try{
          const wb=XLSX.read(e.target.result,{type:'array'});
          const ws=wb.Sheets[wb.SheetNames[0]];

          // Direct cell access to handle merged cells properly
          const cell=(r,c)=>{const ref=XLSX.utils.encode_cell({r:r-1,c:c});const v=ws[ref];return v?v.v:null;};
          const cellStr=(r,c)=>{const v=cell(r,c);return v!=null?String(v).trim():'';}
          const cellNum=(r,c)=>{const v=cell(r,c);return typeof v==='number'?v:Number(v)||0;};

          // Find date
          let dateStr='';
          for(let r=1;r<=10;r++){for(let c=0;c<=12;c++){const v=cellStr(r,c);if(v.match(/\d{2}\/\d{2}\/\d{4}/)){dateStr=v.split(' - ')[0].trim();break;}}if(dateStr)break;}

          // Find max row
          const range=XLSX.utils.decode_range(ws['!ref']||'A1');
          const maxRow=range.e.r+1;

          // Parse product hierarchy using direct cell access
          // Structure: C=cat1, D=cat2, E=cat3, F=product name, G=qty, H=price
          let products=[];
          let currentCat1='',currentCat2='',currentCat3='';

          for(let r=11;r<=maxRow;r++){
            const colA=cellStr(r,0);
            if(colA==='Sales'||colA==='Grand Total')continue;

            const c2=cellStr(r,2);if(c2&&c2!=='BOISSONS'&&c2.length>1)currentCat1=c2;
            const c3=cellStr(r,3);if(c3)currentCat2=c3;
            const c4=cellStr(r,4);if(c4)currentCat3=c4;

            const prodName=cellStr(r,5);
            if(prodName){
              const qty=cellNum(r,6);
              const prix=cellNum(r,7);
              if(qty>0||prix>0){
                products.push({
                  nom:prodName,
                  categorie1:currentCat1,
                  categorie2:currentCat2,
                  categorie3:currentCat3,
                  quantite:qty,
                  prix:prix
                });
              }
            }
          }

          // Aggregate by category
          const byCat={};
          products.forEach(p=>{
            if(!byCat[p.categorie1])byCat[p.categorie1]={qty:0,total:0,items:[]};
            byCat[p.categorie1].qty+=p.quantite;
            byCat[p.categorie1].total+=p.prix;
            byCat[p.categorie1].items.push(p);
          });

          const assortData={date:dateStr,parsedAt:new Date().toISOString(),products,byCat,totalProducts:products.length};

          const allData=this._getData();
          if(!allData.assortiments)allData.assortiments={};
          allData.assortiments[dateStr]=assortData;
          this._saveData(allData);

          resolve(assortData);
        }catch(err){reject(err);}
      };
      reader.readAsArrayBuffer(file);
    });
  },

  // Get all stored day data
  getAllDays(){
    const d=this._getData();
    return d.jours||{};
  },

  // Get data for a specific date
  getDay(dateStr){
    const d=this._getData();
    return(d.jours||{})[dateStr]||null;
  },

  // Get latest day data
  getLatestDay(){
    const jours=this.getAllDays();
    const dates=Object.keys(jours).sort((a,b)=>{
      const pa=a.split('/').reverse().join('');
      const pb=b.split('/').reverse().join('');
      return pb.localeCompare(pa);
    });
    return dates.length>0?jours[dates[0]]:null;
  },

  // Get aggregated data for current month
  getMonthData(month,year){
    const jours=this.getAllDays();
    let totalCA=0,totalCouverts=0,days=0,totalEspeces=0,totalCB=0,totalAmex=0;
    let caRestaurant=0,caClub=0,caBar=0;

    for(const[dateStr,data]of Object.entries(jours)){
      const parts=dateStr.split('/');
      if(parts.length===3){
        const m=parseInt(parts[1]);
        const y=parseInt(parts[2]);
        if((!month||m===month)&&(!year||y===year)){
          totalCA+=data.ventes?.total||0;
          totalCouverts+=(data.couverts?.restaurant?.total||0)+(data.couverts?.club?.total||0)+(data.couverts?.bar?.total||0);
          totalEspeces+=data.paiements?.especes||0;
          totalCB+=data.paiements?.cb||0;
          totalAmex+=data.paiements?.amex||0;
          caRestaurant+=data.ventes?.restaurant||0;
          caClub+=data.ventes?.club||0;
          caBar+=data.ventes?.bar||0;
          days++;
        }
      }
    }

    return{totalCA,totalCouverts,days,totalEspeces,totalCB,totalAmex,caRestaurant,caClub,caBar,
      ticketMoyen:totalCouverts>0?totalCA/totalCouverts:0};
  },

  // Get assortiment data
  getAssortiment(dateStr){
    const d=this._getData();
    return(d.assortiments||{})[dateStr]||null;
  },

  getLastImport(){
    const d=this._getData();
    return d.lastImport||null;
  },

  isConnected(){
    const d=this._getData();
    return Object.keys(d.jours||{}).length>0;
  },

  getDayCount(){
    return Object.keys(this.getAllDays()).length;
  },

  clearAll(){
    localStorage.removeItem(this._key);
  }
};

// ===== RECIPE COSTS (from tableau cost IMA.xlsx - cost HT per portion) =====
const RecipeCosts={
  // MEZZE / ENTREES (from Excel "tableau cost IMA")
  'Moutabal':1.20,'Fatteh':0.94,'Feta & Dukkah':1.81,'Feta & Dukkah ENFANT':1.81,
  'Falafels':1.23,'Muhammra':0.80,'Houmous wagyu':3.46,
  'Houmous Wagyu & Labneh Zaatar':4.50,'Labneh wagyu':2.61,'Labney Wagyu':2.61,
  'Aubergines au Wagyu':4.00,'Harira du Chef':2.68,'Salade Epinard':1.49,
  'Salade Fattouche':2.22,"IMA'artichoke":2.90,'Mousseline . B':1.47,
  // ENTREES with combos
  'labneh zaatar':1.04,'hummus paprika':1.29,
  'Labneh wagyu & hummus paprika':3.90,'labneh zaatar & hummus wagyu':4.50,
  // Latkes
  'Latkes':18.07,
  // PLATS
  "Poulet R\u00f4ti aux Cl\u00e9mentines":4.08,'Poulpe Aux Epices':9.41,
  "Daurade \u00e0 La Rose":7.04,'Daurade a la rose':7.04,
  'Shish taouk':3.08,'Shish taouk ENFANT':3.08,'Shish-Taouk':3.08,
  'Kefta Wagyu':6.38,'Tomahawk Black angus':63.22,
  "Epaule d'Agneau":29.30,'Poisson du jour':36.71,
  "Man'ouch\u00e9 \u00e0 L'Agneau":3.85,
  'choux fleur roti':3.02,
  // Caviar
  'Caviar 30gr':29.69,'Caviar 50gr':49.54,'Caviar 125gr':122.49,
  // SIDES
  'Patate douce':0.56,"Pur\u00e9e Patate .D":0.56,'Riz au Safran':0.74,
  "Compot\u00e9 Aubergine":0.90,"Compot\u00e9 Aub\u00e9":0.90,
  "Salade \u00c9pinard SIDE":0.74,
  // DESSERTS
  'Mousse chocolat':5.16,'Mille Feuille':2.64,'Mille feuille':2.64,
  'Glace pistache':1.85,'Glace Achta':1.93,
  'fruit givr\u00e9':5.70,
  // PAINS
  'Pain Libanais':0.26,'Pain Pita':0.26,'Pain Yemenite':0.30,'Bread basket':0.50,
  // COMBOS MEZZE (estimated from component costs avg ~1.20/item)
  'Mezze par 3':3.50,'Mezze par 5':5.80,'Mezze par 7':8.00,
  '2 Assiette':2.40,'3 Assiettes':3.60,'4 Assiettes':4.80,
  '5 Assiettes':6.00,'8 Assiettes':9.60,'2 Boles':2.40,'5 Boles':6.00,
  // MENUS
  'MENU BORSAT':12.00,'MENU ENFANT':4.00,'MENU Solaise':10.00,
  // SOUPES
  'Soupe pistaches':5.24,
  // NON-FOOD
  'Saignant':0,'TIPS':0,'BAR':0,"Carafe d'eau":0.10
};
// Global food cost ratio from Excel = 18.0% (I60)
const FOOD_COST_GLOBAL_TARGET=0.18;

// ===== INVENTORY SERVICE =====
const InventoryService={
  _dbData:[["Food","Légumes","Ail kg",6.46],["Food","Légumes","Aneth bte",0.7],["Food","Légumes","Aubergine kg",1.94],["Food","Légumes","Betterave cuite kg",2.42],["Food","Légumes","Carotte kg",1.38],["Food","Légumes","Celeris pc",1.46],["Food","Légumes","Cerfeuil bte",0.73],["Food","Légumes","Choux blanc kg",1.86],["Food","Légumes","Ciboulette bte",0.57],["Food","Légumes","Citron beldi 3kg",5.97],["Food","Légumes","Citron Jaune kg",2.59],["Food","Légumes","Clementine corse kg",6.56],["Food","Légumes","Concombre pc",1.34],["Food","Légumes","Coriandre bte",0.59],["Food","Légumes","courgette",1.7],["Food","Légumes","Dattes medjool kg",17.95],["Food","Légumes","Eau de fleur doranger terga 600 ml",15.5],["Food","Légumes","Eau de rose terga 300 ml",11.6],["Food","Légumes","Echalotte banane kg",1.62],["Food","Légumes","Estragon bte",0.74],["Food","Légumes","Fenouil kg",2.59],["Food","Légumes","Figues fraiche kg",4.84],["Food","Légumes","Gingembre fais kg",3.55],["Food","Légumes","Grenade fraiche pc",4.84],["Food","Légumes","Laurier bte",0.81],["Food","Légumes","Menthe fraiche bte",0.54],["Food","Légumes","Mini choux fleur pc",2.42],["Food","Légumes","Mini concombre pc",4.84],["Food","Légumes","Oignons jaune kg",0.81],["Food","Légumes","Oignons nouveau pc",2.1],["Food","Légumes","Oignons rouge kg",2.1],["Food","Légumes","Orange a jus kg",1.62],["Food","Légumes","Patate douce kg",1.1],["Food","Légumes","PDT CHARLOTTE Grosse (latkes) kg",1.3],["Food","Légumes","Persil bte",0.54],["Food","Légumes","Piment frais kg",8.07],["Food","Légumes","Piment vert frais kg",4.84],["Food","Légumes","Poireaux pc",1.54],["Food","Légumes","Poivron jaune pc",3.07],["Food","Légumes","Poivron rouge pc",3.23],["Food","Légumes","Pomme grany smith pc",2.34],["Food","Légumes","Pousse d'epinard kg",6.78],["Food","Légumes","Radis rond bte",1.13],["Food","Légumes","Romaine pc",2.75],["Food","Légumes","Thym bte",0.76],["Food","Légumes","Tomate kg",1.78],["Food","Légumes","Zaatar / 350 gr bermudes mds",9.9],["Food","Épices","4 epices",21.2],["Food","Épices","amande effillé kg",11.83],["Food","Épices","amande emondee kg",11.56],["Food","Épices","anis 125 gr",4.53],["Food","Épices","canelle en poudre 500 gr",9.74],["Food","Épices","cannelle en baton 500 gr",10.7],["Food","Épices","cardamome graine 105 gr",10.61],["Food","Épices","cardamome poudre 140 gr",11.08],["Food","Épices","clou de girofle 110 gr",5.74],["Food","Épices","coriandre en poudre 250 gr",2.08],["Food","Épices","cranberry kg",11.81],["Food","Épices","cumin en grain 250 gr",5.22],["Food","Épices","cumin poudre 500 gr",9.57],["Food","Épices","curry madras 500 gr",4.09],["Food","Épices","fenugrec 240 gr",5.22],["Food","Épices","gingembre en poudre 500 gr",5.91],["Food","Épices","gomme arabic en poudre",27.5],["Food","Épices","graine de fenouil 250 gr",5.22],["Food","Épices","melasse de grenade",11.42],["Food","Épices","menthe seché 9 GR",3.15],["Food","Épices","muscade poudre",25.44],["Food","Épices","nigelle 110 gr",5.02],["Food","Épices","paprika doux 480 gr",7.37],["Food","Épices","paprika fumé 500 gr",5.27],["Food","Épices","pate de tamarin 454 gr",3.37],["Food","Épices","persil seché KG",8.6],["Food","Épices","petale de rose",8.5],["Food","Épices","pignon de pin",30.83],["Food","Épices","piment flocons fort 110 gr",3.69],["Food","Épices","Piment fort entier 200 gr",6.65],["Food","Épices","piment poudre fort",5.6],["Food","Épices","Pois chiche sec kg",3.27],["Food","Épices","poivre blanc moulu",13.45],["Food","Épices","poivre noir",14.4],["Food","Épices","poudre ail 500gr",7.26],["Food","Épices","poudre oignon 120 gr",3.98],["Food","Épices","ras el hanout en poudre 500 gr",4.22],["Food","Épices","riz basmati parfumé AAA kg",3.5],["Food","Épices","salep en poudre",14.0],["Food","Épices","sesame kg",6.34],["Food","Épices","sesame noir kg",7.49],["Food","Épices","sirop de datte 250 gr",5.48],["Food","Épices","sumac 550gr",10.46],["Food","Épices","tahini 900 gr",7.97],["Food","Économat","Bicarbonate de soude",8.66],["Food","Économat","Boulgour fin",6.6],["Food","Économat","capres 4/4",5.4],["Food","Économat","cassonade",2.77],["Food","Économat","chocolat 70 % valrohana  3kg",130.0],["Food","Économat","concentré de tomate 4/4",2.86],["Food","Économat","farine de mais 5k",1.4],["Food","Économat","farine t45",1.54],["Food","Économat","farine T65",1.42],["Food","Économat","fleur de sel",14.91],["Food","Économat","gelatine feuille KG",31.47],["Food","Économat","graine de coriandre",9.92],["Food","Économat","graine de tournesol",6.09],["Food","Économat","Graisse de canard 5/1",18.66],["Food","Économat","gros malossol 2,65 kg",9.13],["Food","Économat","gros sel",0.48],["Food","Économat","huile de tournesol",2.11],["Food","Économat","lait conncentré pc",4.5],["Food","Économat","lentilles blondes",4.39],["Food","Économat","levure chimique",8.24],["Food","Économat","maizena 700 gr",4.59],["Food","Économat","melasse de datte",18.0],["Food","Économat","miel fleurs",4.66],["Food","Économat","moutarde en grain",2.9],["Food","Économat","noisette",20.21],["Food","Économat","noix",7.23],["Food","Économat","pois chiche en boite cuit 4/4",1.62],["Food","Économat","poudre de lait 750 gr",8.28],["Food","Économat","raisin sec blond",5.27],["Food","Économat","sauce soja",7.08],["Food","Économat","sel fin",0.48],["Food","Économat","semoule",4.3],["Food","Économat","sirop de grenadine",6.61],["Food","Économat","Sucre",1.41],["Food","Économat","Vanille gousse 100 gr",20.44],["Food","Économat","Vermicelle 500 gr",2.01],["Food","Économat","Vin de shaoxing",4.57],["Food","Économat","Vinaigre blanc 1,5l",0.94],["Food","Économat","Vinaigre de cidre",3.1],["Food","Économat","Moutarde de dijon 5 kg",4.85],["Food","Économat","Vinaigre de xeres",6.95],["Food","Économat","Pépin de raisin",13.95],["Food","Poisson","Filet de daurade 600/800 royale corse",37.15],["Food","Poisson","bar entier 1.2 kg",22.8],["Food","Poisson","Cabillaud",9.0],["Food","Poisson","Saumon",9.0],["Food","Poisson","Caviar oscietre royale 30/50/125gr",950.0],["Food","Poisson","Caviar declassé 30 gr",650.0],["Food","Poisson","Caviar shrenki shadi 30/50/125gr",900.0],["Food","Poisson","Blinis mini pkt de 16pc",1.7],["Food","Poisson","Aiile de poulet",5.3],["Food","Poisson","Carcasse de poulet",2.9],["Food","Poisson","Haut de cuisse avec peau sans os",12.8],["Food","Poisson","Collier d'agneau",12.8],["Food","Poisson","Epaule d' agneau crue avec os",18.45],["Food","Poisson","Epaule d' agneau crue sans os",25.9],["Food","Poisson","COEUR DE RUMSTEAK-WAGYU-Australie",29.5],["Food","Poisson","EPAULE D'AGNEAU francais",16.0],["Food","Poisson","tomahawk usa black angus (train entier)",45.0],["Food","Poisson","tomahawk wagyu 4/5",68.0],["Food","Poisson","Audrey /06 77 10 22 08",11.5],["Food","Poisson","Beurre doux kg",7.14],["Food","Poisson","Blanc doeuf L",6.66],["Food","Poisson","Creme isigny kg",8.7],["Food","Poisson","Creme liquide 35 %",8.31],["Food","Poisson","Jaune d'oeuf L",1.31],["Food","Poisson","Labneh 500 gr",5.0],["Food","Poisson","Lait entier L",0.25],["Food","Poisson","Oeuf entier LIQUIDE L",3.54],["Food","Poisson","Oeuf frais gros PC",4.48],["Food","Traiteur","Artichauts pensato bte 2,6 kg",21.34],["Food","Traiteur","Cerise amarena",14.05],["Food","Traiteur","Condiment balsamique noir L",15.28],["Food","Traiteur","Condiment balsamique rosé L",13.68],["Food","Traiteur","Feta top grecque kg / 3kg",13.46],["Food","Traiteur","Huile d olive  extra vierge 5 L picuda",7.98],["Food","Traiteur","Huile de friture top italienne",2.14],["Food","Traiteur","Labneh 5 kg",4.51],["Food","Traiteur","Mascarpone",8.11],["Food","Traiteur","Noisette",4.58],["Food","Traiteur","Pain libanis 10 pc",0.9],["Food","Traiteur","Pain pita pkt 10 pc",2.57],["Food","Traiteur","Parmesan rapé",23.5],["Food","Traiteur","Pate de pistache",39.0],["Food","Traiteur","Pate de pistache kadiif Kg",18.5],["Food","Traiteur","Pistache entiere decortiqué",33.6],["Food","Traiteur","Pistache pepites sicilles",36.14],["Food","Traiteur","Pois chiche en boite cuit 400 gr /12",2.47],["Food","Traiteur","Poulpe",31.34],["Food","Traiteur","Tahini TAHINA 907GR*10 - AL YAMAN",9.0],["Food","Traiteur","Tomate san marzano",2.52],["Food","Traiteur","Vinaigre rosé",28.56],["Food","Traiteur","Yaourth grec kg",4.36],["Food","Traiteur","Figue de barbarie Jaune 18/20",26.93],["Food","Traiteur","Figue 35/38",39.3],["Food","Traiteur","DATTES 80/85",36.39],["Food","Traiteur","Passion 42/45",36.39],["Food","Traiteur","Noix 89 / 92",26.93],["Food","Traiteur","Citron Vert 30/32",2.28],["Food","Traiteur","Pates penne / spaghetti/linguine",3.8],["Food","Traiteur","Riz",2.96],["Food","Traiteur","Lasagne feuille surg/10k",4.21],["Food","Traiteur","Gnocchis pdt",3.58],["Food","Traiteur","Pizzas 5 fromage / champignon jambon",6.9],["Food","Traiteur","Pizzas margarita",13.75],["Food","Truffe/Boulangerie","HALLOTES",2.4],["Food","Truffe/Boulangerie","FEUILLETÉ ZAATAR",18.0],["Food","Truffe/Boulangerie","PAIN DE MIE BRIOCHE",14.0],["Vin Blanc","2021","Jean Cavaillé Seyssel « Cep Noir – Vieilles Vignes »",8.21],["Vin Blanc","2022","Dom. Fabien FélixChignin Bergeron 971",16.0],["Vin Blanc","2022","Dom. des Ardoisieres Argile",15.05],["Vin Blanc","2024","Dom. Francis Blanchet Pouilly Fumé « Calcite »",11.87],["Vin Blanc","2023","Dom. Paul Corneau POUILLY FUME PAUL CORNEAU",13.95],["Vin Blanc","2023","Vincent DelaporteSancerre et fils Blanc \"Silex\" 18,2",18.2],["Vin Blanc","2019","Dom. Serge Dagueneau Pouilly-Fume & filles\"Les Filles\"",29.5],["Vin Blanc","2019","Vincent Gaudry Sancerre \"Pour Vous\"",56.7],["Vin Blanc","2023","Vincent DelaporteSancerre et fils Blanc \"Mont Damnes\"",50.0],["Vin Blanc","2024","Famille Perrin Coudoulet de Belle Époqueaucastel",17.0],["Vin Blanc","2023","Dom. du Monteillet Saint Joseph blanc",18.99],["Vin Blanc","2024","Hermitage Les Alexandrins",27.0],["Vin Blanc","2023","Louis Chèze Condrieu « Pagus Luminis »",26.24],["Vin Blanc","2022","CONDRIEU BIO \"Les Terrasses du Palat\"",31.9],["Vin Blanc","2024","Château neuf du pape Château - Fam. de Baucastel Perrin",69.0],["Vin Blanc","2022","Dom. Jacques Dury Rully 1er Cru \"Meix Cadot\"",19.5],["Vin Blanc","2023","Dom. Chavy-Chouet Maranges \"Les Meurées\"",23.4],["Vin Blanc","2023","Dom. Roland Lavantureux Chablis 1er cru \"Fourchaume\"",26.0],["Vin Blanc","2022","Dom. F. JeanniardPERNAND-VERGELESSES",24.5],["Vin Blanc","2022","Dom. Ballot-MillotMeursault 45,5",23.0],["Vin Blanc","2022","Dom. Roux SAINT-AUBIN « Vieille Vignes »",26.9],["Vin Blanc","2022","Dom. Bachelet Chassagne Montrachet",45.03],["Vin Blanc","2021","Dom. Borgeot PULIGNY MONTRACHET Grands Champs",63.0],["Vin Blanc","2022","Coffinet-DuvernayChassagne-Montrachet 1er cru \"Fairendes\"",71.5],["Vin Blanc","2020","Dom. V. Girardin MEURSAULT NARVAUX",57.5],["Vin Blanc","2020","Dom. Pierre Girardin Corton Charlemagne",200.0],["Vin Blanc","2019","Dom. Latour CRIOT BATARD MONTRACHET Gd Crû 279",279.0],["Vin Blanc","2020","Dom. Roland Lavantureux Chablis Vieilles Vignes",37.3],["Vin Blanc","2023","Dom. Chavy-Chouet Meursault "Clos des corvees de citeau" Monopole",145.0],["Vin Blanc","2023","Dom. Chavy-Chouet Puligny-Montrachet "Les Enseigneres"",145.0],["Vin Blanc","2016","Sauternes CARMES DE RIEUSSEC",16.0],["Vin Blanc","2024","Dom. des Tourelles Vallé de la Békaa",8.15],["Vin Blanc","2024","Sudtirol Alto AdigePinot Grigio Colterenzio",9.55],["Vin rosé","2024","Château Minuty Rose & Or",14.08],["Vin rosé","2024","Château Minuty Cuvée",281.0],["Vin rosé","2024","Château Minuty Cuvée",281.0],["Vin rouge","2023","Mondeuse F. Trosset Cuvée Avalanche",10.45],["Vin rouge","2024","Mondeuse Cru Arbin « Les Chemins de Lourdens »",12.95],["Vin rouge","2023","Jean Cavaillé Persan Bio « Les Chemins de Miolans »",16.07],["Vin rouge","2018","Dom. des Ardoisieres Améthyste",50.05],["Vin rouge","2023","Dom. des Tayaux Sancerre «Jean-Marc et Romain Pastou»",11.52],["Vin rouge","2023","Vincent DelaporteSancerre et fils Rouge \"Silex\"",18.5],["Vin rouge","2020","Vincent DelaporteSancerre et fils Rouge \"Silex\"",37.5],["Vin rouge","2022","Les alexandrins Crozes Hermitage",9.4],["Vin rouge","2023","Dom. du MurinaisCROZES-HERMITAGE BIO Les Aigrettes",11.75],["Vin rouge","2021","Famille Perrin Coudoulet de Beaucastel 16",16.0],["Vin rouge","2023","Dom. du Monteillet Saint Joseph",16.85],["Vin rouge","2022","Dom. Jean-Luc Jamet Côte du Rhone \"L'Enclave\"",18.2],["Vin rouge","2022","Combier Crozes Hermitage - Clos des Grives",32.5],["Vin rouge","2016","Dom. Jean-Luc Jamet Cote Rotie \"Terrasses\"",49.4],["Vin rouge","2021","Maison Chapoutier CÔTE ROTIE Les Bécasses",49.9],["Vin rouge","2016","Famille Perrin Château de Beaucastel",80.0],["Vin rouge","2020","J.M Gerin Cote Rotie \"Champin le seigneur\"",75.6],["Vin rouge","2016","Dom. de la Janasse Chateauneuf du Pape \"Vieilles Vignes\"",123.0],["Vin rouge","2022","Famille Perrin - Château Châteauneuf de Beaucastel du pape 121",121.0],["Vin rouge","2020","Dom. Chambris Haute cote de nuit",12.6],["Vin rouge","2021","Dom. Arnaud Baillot Côte de Nuits Villages",16.9],["Vin rouge","2021","Dom. Lucien Muzard Santenay & Fils 1er cru \"Maladiere\"",24.7],["Vin rouge","2019","Maison Louis Jadot MERCUREY « 1er Crû Fortoul »",25.05],["Vin rouge","2017","Dom. F. Magnien MOREY SAINT-DENIS - BIO « Coeur d'Argile »",33.0],["Vin rouge","2021","Dom. Hudelot Baillet Chambolle Musigny Vieilles Vignes",43.3],["Vin rouge","2022","Dom. Arnaud Baillot Gevrey Chambertin",45.5],["Vin rouge","2018","Dom. V. Girardin CHASSAGNE MONTRACHET 1er Cru La Boudriotte 41,1",41.1],["Vin rouge","2022","Y. Clerget Pommard \"Chanlins\"",44.2],["Vin rouge","2022","Violot-GuillemardBaune 1er Cru \"Clos des Mouches\" 9",1.0],["Vin rouge","2021","Dom. Arnaud Baillot Vosne-Romanee 1er Cru \"Les Chaumes\"",117.0],["Vin rouge","2021","Y. Clerget Corton Grand Cru \"Le Rognet\"",123.5],["Vin rouge","2018","Château de la TourCLOS VOUGEOT Grand Cru 130",130.0],["Vin rouge","2020","Dom. Pierre Girardin Vosne-Romanee 1er cru \"Les Suchots\"",136.5],["Vin rouge","2021","Dom. Lucien Muzard Santenay & Fils 1er cru \"Maladiere\"",50.7],["Vin rouge","2022","Y.Clerget Volnay \"Les Petits Poisot\"",84.5],["Vin rouge","2021","Dom. Arnaud Baillot Gevrey ChamBelle Époquertin",91.0],["Vin rouge","2022","Y.Clerget Pommard \"Chanlins\" 91",91.0],["Vin rouge","2017","Dom. de la PousseVolnay d'Or 1er cru « Clos de la Bousse d'Or »",135.0],["Vin rouge","2019","ST EMILION Baron de Boutisse Grand cru",12.35],["Vin rouge","2020","ST EMILION Château Fleur de Lisse",18.5],["Vin rouge","2018","ST EMILION Le Dragon de Quintus Grand Cru",35.0],["Vin rouge","2016","ST EMILION Château Canon la Gaffeliere Grand Cru",70.0],["Vin rouge","2017","ST EMILION CHATEAU ANGELUS GRAND CRU 297",297.0],["Vin rouge","2014","PESSAC-LEOGNANCHATEAU FIEUZAL",29.0],["Vin rouge","2018","PESSAC-LEOGNANCHATEAU PAPE CLEMENT",76.0],["Vin rouge","2014","SAINT-JULIEN LES FIEFS DE LAGRANGE",19.0],["Vin rouge","2011","SAINT-JULIEN CLOS DU MARQUIS",44.0],["Vin rouge","2014","SAINT-JULIEN CHATEAU TALBOT",55.0],["Vin rouge","2017","SAINT-JULIEN CHATEAU LEOVILLE POYFERRE",61.6],["Vin rouge","2016","SAINT-JULIEN CHATEAU BEYCHEVELLE",115.0],["Vin rouge","2017","SAINT-JULIEN CHATEAU DUCRU-BEAUCAILLOU",142.0],["Vin rouge","2019","HAUT-MEDOC CHÂTEAU CANTEMERLE",21.5],["Vin rouge","2016","HAUT-MEDOC CHATEAU LA LAGUNE",35.0],["Vin rouge","2018","PAUILLAC Château Lacoste Borie",20.1],["Vin rouge","2011","PAUILLAC CHATEAU LYNCH BAGES",102.0],["Vin rouge","2015","POMEROL FUGUE DE NENIN",22.8],["Vin rouge","2017","POMEROL CHATEAU GAZIN",64.0],["Vin rouge","2017","POMEROL CHATEAU LA CONSEILLANTE",130.0],["Vin rouge","2017","MARGAUX LES HAUTS DU TERTRE",17.0],["Vin rouge","2020","MARGAUX Château Prieure-Lichine 4ème Cru Classé",31.1],["Vin rouge","2020","MARGAUX CHATEAU GISCOURS",45.0],["Vin rouge","2020","MARGAUX Château Cantenac Brown",49.0],["Vin rouge","2008","MARGAUX CHATEAU RAUZAN-SEGLA",96.0],["Vin rouge","2013","MARGAUX CHATEAU PALMER 200",200.0],["Vin rouge","","SAINT-ESTEPHE Château Clauzet",19.1],["Vin rouge","2017","SAINT-ESTEPHE LA DAME DE MONTROSE",29.0],["Vin rouge","2021","SAINT-ESTEPHE CHATEAU CALON SEGUR",97.0],["Vin rouge","2014","SAINT-ESTEPHE COS D'ESTOURNEL",121.0],["Vin rouge","2022","Dom. des Tourelles Vallée de la Békaa",8.15],["Vin rouge","2023","Dom. Buglioni Valpolicella Imperfetto",11.95],["Vin rouge","2019","Trediberri Barolo - cuvée Berri",28.6],["Spiritueux","ARMAGNAC","Armagnac By Joy 1975",30.0],["Spiritueux","BIERRE","Noam",1.81],["Spiritueux","BIERRE","Corona 0.0",1.74],["Spiritueux","BIERRE","Corona",1.53],["Spiritueux","CHAMPAGNE","baron rotshield kasher",83.89],["Spiritueux","CHAMPAGNE","prosseco",6.15],["Spiritueux","CHAMPAGNE","French bloom extra brut sans alcool",25.5],["Spiritueux","CHAMPAGNE","Dom perignon luminous 3L",2150.0],["Spiritueux","CHAMPAGNE","Dom Perignon luminous 75cl",168.58],["Spiritueux","CHAMPAGNE","Veuve Cliquot brut 75cl",38.82],["Spiritueux","CHAMPAGNE","Veuve Cliquot rose 75 cl",46.65],["Spiritueux","CHAMPAGNE","Cristal 75cl",249.92],["Spiritueux","COGNAC","Martell VSOP",62.98],["Spiritueux","COGNAC","Martell XO",174.46],["Spiritueux","COGNAC","Henessy VS",24.84],["Spiritueux","EAU-DE-VIE","Calvados Beaujour",20.33],["Spiritueux","EAU-DE-VIE","Poire William",29.13],["Spiritueux","GIN","Tanqueray London Dry",9.76],["Spiritueux","GIN","Tanqueray No. Ten",24.13],["Spiritueux","GIN","Tanqueray Flor De Sevilla",17.71],["Spiritueux","GIN","Tanqueray Blackcurrant Royale",17.71],["Spiritueux","GIN","Roku Gin /Japan",21.52],["Spiritueux","GIN","Monkey 47",31.93],["Spiritueux","GIN","Hendrick's",21.5],["Spiritueux","GIN","Hendrick's",73.64],["Spiritueux","GIN","adamus gin",37.63],["Spiritueux","LIQUEUR","Get 27",15.16],["Spiritueux","LIQUEUR","Get 31",16.15],["Spiritueux","LIQUEUR","Amaretto Adriatico",25.69],["Spiritueux","LIQUEUR","Bailey's",10.73],["Spiritueux","LIQUEUR","Génépi à l'ancienne",25.0],["Spiritueux","LIQUEUR","Ricard",7.34],["Spiritueux","LIQUEUR","Jaegermeister",8.82],["Spiritueux","LIQUEUR","Chartreuse Jaune",38.63],["Spiritueux","LIQUEUR","Aperol",15.64],["Spiritueux","LIQUEUR","Fernet Menta/Branca",15.3],["Spiritueux","LIQUEUR","Frangelico",12.86],["Spiritueux","LIQUEUR","Sambuca",4.75],["Spiritueux","LIQUEUR","Amaretto Disarono",18.69],["Spiritueux","LIQUEUR","Campari",17.65],["Spiritueux","LIQUEUR","Jaegermeister",20.84],["Spiritueux","LIQUEUR","martini blanc",11.12],["Spiritueux","LIQUEUR","martini rosso",11.12],["Spiritueux","LIQUEUR","khalua",15.89],["Spiritueux","LIQUEUR","suze",9.17],["Spiritueux","LIQUEUR","cointreau",11.71],["Spiritueux","LIQUEUR","liqueure limoncello bib",65.53],["Spiritueux","LIQUEUR","liqueure sureau bib",59.09],["Spiritueux","LIQUEUR","Ypioca",19.75],["Spiritueux","RHUM","Havana Club Especial",8.84],["Spiritueux","RHUM","Havana Club 7 ans",16.77],["Spiritueux","RHUM","Zacapa Solera Gran Reserva",39.9],["Spiritueux","RHUM","Zacapa Centenario XO",85.94],["Spiritueux","RHUM","Bumbu The Original",22.37],["Spiritueux","RHUM","Havana Blanc",8.19],["Spiritueux","RHUM","Don Papa baroko",29.13],["Spiritueux","TEQUILA","Don Julio 1942",168.93],["Spiritueux","TEQUILA","Don Julio 1942",507.37],["Spiritueux","TEQUILA","Don Julio Reposado",30.4],["Spiritueux","TEQUILA","Don Julio Rosado",142.54],["Spiritueux","TEQUILA","Don julio 70 Cristalino",59.76],["Spiritueux","TEQUILA","Casamigos Blanco",27.43],["Spiritueux","TEQUILA","Casamigos Reposado",31.76],["Spiritueux","TEQUILA","Casamigos Anejo",33.68],["Spiritueux","TEQUILA","Casamigos Mezcal Joven",48.89],["Spiritueux","TEQUILA","Codigo Blanco",34.11],["Spiritueux","TEQUILA","Codigo Reposado",40.7],["Spiritueux","TEQUILA","Codigo Reposado",117.71],["Spiritueux","TEQUILA","Codigo Anejo",116.95],["Spiritueux","TEQUILA","Codigo Rosa",40.46],["Spiritueux","TEQUILA","Codigo Origen",373.56],["Spiritueux","TEQUILA","Adiccion Blanco",75.0],["Spiritueux","TEQUILA","Adiccion Reposado",109.0],["Spiritueux","TEQUILA","Adiccion Anejo",150.0],["Spiritueux","TEQUILA","Adiccion Mezcal",95.0],["Spiritueux","TEQUILA","818 reposado",47.02],["Spiritueux","TEQUILA","818 Anejo",55.79],["Spiritueux","TEQUILA","818 Eight Reserve",224.79],["Spiritueux","TEQUILA","Don Julio Blanco",26.11],["Spiritueux","TEQUILA","Patron el cielo",207.53],["Spiritueux","TEQUILA","Jose Cuervo",11.14],["Spiritueux","TEQUILA","Adelita tequila",260.1],["Spiritueux","TEQUILA","Del maguey mezcal",30.62],["Spiritueux","TEQUILA","Bandida mezcal",185.0],["Spiritueux","TEQUILA","Bandida mezcal café",185.0],["Spiritueux","TEQUILA","Mezcal mahani",32.48],["Spiritueux","TEQUILA","Volcan blanco",28.02],["Spiritueux","VODKA","Silver Gecko",10.5],["Spiritueux","VODKA","Belvédere",23.37],["Spiritueux","VODKA","Belvédere 1.5 L",65.3],["Spiritueux","VODKA","Belvédere ten",130.7],["Spiritueux","VODKA","Belvédere ten",379.19],["Spiritueux","VODKA","Beluga Noble",40.09],["Spiritueux","VODKA","Beluga Noble",80.51],["Spiritueux","VODKA","Beluga Noble",315.29],["Spiritueux","VODKA","Grey goos Altius",129.56],["Spiritueux","VODKA","Beluga gold line",122.63],["Spiritueux","VODKA","Beluga gold line",216.87],["Spiritueux","VODKA","Belevedere dirty brew",24.59],["Spiritueux","VODKA","Ciroc peche",21.71],["Spiritueux","VODKA","Ciroc mango",21.71],["Spiritueux","VODKA","Ciroc red berry",21.71],["Spiritueux","WHISKY","Johnie Walker RED Label",8.0],["Spiritueux","WHISKY","Johnie Walker Black Label",16.92],["Spiritueux","WHISKY","Jack Daniel's",15.14],["Spiritueux","WHISKY","Oban 14 years old",47.8],["Spiritueux","WHISKY","Chivas 12",23.37],["Spiritueux","WHISKY","Johnie Walker Blue Label",137.49],["Spiritueux","WHISKY","Talisker 10 years old",33.29],["Spiritueux","WHISKY","Bulleit Rye",17.52],["Spiritueux","WHISKY","Bulleit bourbon",14.53],["Spiritueux","WHISKY","Lagavulin 16 ans",61.1]],
  _key:'ima_price_db_v1',
  _defaultDB(){return this._dbData;},
  _getCustom(){const d=localStorage.getItem(this._key);return d?JSON.parse(d):[];},
  _saveCustom(d){localStorage.setItem(this._key,JSON.stringify(d));},
  _toObj(x){return{p:x[0],s:x[1],n:x[2],x:x[3]};},
  _rawAll(){const def=this._defaultDB(),cust=this._getCustom(),map=new Map(def.map(x=>[x[2].toLowerCase(),x]));cust.forEach(x=>{map.set(x[2].toLowerCase(),x);});return Array.from(map.values());},
  getAll(){return this._rawAll().map(x=>this._toObj(x));},
  search(q){const lq=q.toLowerCase();return this.getAll().filter(x=>x.n.toLowerCase().includes(lq));},
  getByCategory(c){return this.getAll().filter(x=>x.p===c);},
  getSubCategories(c){const items=this.getByCategory(c),subs=new Set(items.map(x=>x.s));return Array.from(subs);},
  getPrix(n){const ln=n.toLowerCase(),all=this._rawAll(),item=all.find(x=>x[2].toLowerCase()===ln);return item?item[3]:null;},
  updatePrix(n,p,s){const cust=this._getCustom(),idx=cust.findIndex(x=>x[2].toLowerCase()===n.toLowerCase());if(idx>=0){cust[idx][3]=p;}else{const def=this._defaultDB(),dItem=def.find(x=>x[2].toLowerCase()===n.toLowerCase());if(dItem){cust.push([dItem[0],dItem[1],dItem[2],p]);}else{cust.push(['Custom','Custom',n,p]);}}this._saveCustom(cust);},
  getStats(){const all=this.getAll(),cats={};all.forEach(x=>{cats[x.p]=(cats[x.p]||0)+1;});return{totalProducts:all.length,byCategory:cats,lastUpdate:new Date().toISOString()};},
  isLoaded(){return true;},
  // Detect serving format from Trivec product name
  // Returns: {format:'btl'|'mag'|'verre'|'shot'|'coupe'|'unit', clean:string, multiplier:number}
  // multiplier: how many purchase-price units this represents
  // btl = 1 (full bottle), mag = 2 (double bottle), verre/shot/coupe = 1/17 of a bottle
  detectFormat(trivecName){
    if(!trivecName)return{format:'unit',clean:trivecName||'',multiplier:1};
    const tn=trivecName.trim();
    const upper=tn.toUpperCase();
    let format='unit',multiplier=1;
    // Detect prefix format
    if(/^\s*(Btl\.?)\s+/i.test(tn)){format='btl';multiplier=1;}
    else if(/^\s*(Mag\.?|Mag)\s+/i.test(tn)){format='mag';multiplier=2;}
    else if(/^\s*(Vr\.?)\s+/i.test(tn)){format='verre';multiplier=1/17;}
    else if(/^\s*(Shot)\s+/i.test(tn)){format='shot';multiplier=1/17;}
    else if(/^\s*(Coupe)\s+/i.test(tn)){format='coupe';multiplier=1/17;}
    // Detect suffix/content hints for magnums
    else if(/\bMag\b/i.test(tn)&&!(/\bimage\b/i.test(tn))){format='mag';multiplier=2;}
    // For wine bottles (VIN BTL category) without prefix, assume full bottle
    // For cocktails, assume verre
    // Clean: remove prefixes and trailing *
    let clean=tn.replace(/^\s*(Btl\.?|Vr\.?|Mag\.?|Shot|Acc\.?|Coupe)\s+/i,'').replace(/\*+$/,'').replace(/\s*(ENFANT|SIDE)$/i,'').trim();
    return{format,clean,multiplier};
  },
  // Match a Trivec product name to an inventory item (fuzzy)
  // Returns: {item, format, multiplier, costPerUnit} or null
  matchTrivecFull(trivecName){
    if(!trivecName)return null;
    const fmt=this.detectFormat(trivecName);
    const clean=fmt.clean;
    const ln=clean.toLowerCase();
    if(!ln||ln.length<2)return null;
    const all=this.getAll();
    const noise=new Set(['par','au','aux','la','le','les','du','de','des','.','rg','blc','btl','vr','rge','cru','1er','verre','ex','divers','alcool','blanc','rouge','rose','sans','brut','grand','belle','epoque','noble','reserve','special','edition','cuvee','cuvée','vieilles','vignes','premier']);
    const stripAcc=s=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const lnNorm=stripAcc(ln);
    // For magnums: try to find the magnum-specific product first (1.5L, 1.5 L, Mag)
    let m=null;
    if(fmt.format==='mag'){
      // Try to find magnum-specific product (1.5L) - require a strong brand word match (5+ chars)
      const magWords=ln.split(/\s+/).filter(w=>w.length>=5&&!noise.has(w));
      m=all.find(x=>{const xn=x.n.toLowerCase();return(xn.includes('1.5')||xn.includes('1,5'))&&magWords.some(w=>xn.includes(w));});
      if(m)return{item:m,format:fmt.format,multiplier:1,costPerUnit:m.x}; // Found magnum price directly
    }
    // Exact match (cleaned name)
    m=all.find(x=>x.n.toLowerCase()===ln);
    if(m)return{item:m,format:fmt.format,multiplier:fmt.multiplier,costPerUnit:m.x*fmt.multiplier};
    // Contains match (min 5 chars)
    m=all.find(x=>{const xn=x.n.toLowerCase();return xn.length>=5&&(ln.includes(xn)||stripAcc(xn)===lnNorm);});
    if(m)return{item:m,format:fmt.format,multiplier:fmt.multiplier,costPerUnit:m.x*fmt.multiplier};
    m=all.find(x=>{const xn=x.n.toLowerCase();return ln.length>=5&&xn.includes(ln);});
    if(m)return{item:m,format:fmt.format,multiplier:fmt.multiplier,costPerUnit:m.x*fmt.multiplier};
    // Word-based scoring
    const words=ln.split(/[\s\/\-\.\,\(\)]+/).filter(w=>w.length>2&&!noise.has(w));
    if(words.length===0)return null;
    const dishWords=new Set(['menu','mezze','salade','glace','mousse','harira','houmous','kefta','shish','taouk','mille','feuille','poisson','jour','daurade','bread','carafe','eau','compoté','mousseline','falafels','fatteh','moutabal','muhammra','cocktail','sour','spritz','martini','espresso','mojito','negroni','mule','island','labneh','labney','wagyu','rôti','puree','purée','divers','tips','forfait']);
    const isDish=words.some(w=>dishWords.has(w));
    const scored=all.map(x=>{
      const xn=x.n.toLowerCase();
      const xnNorm=stripAcc(xn);
      const xWords=xn.split(/[\s\/\-\.\,\(\)]+/).filter(w=>w.length>2&&!noise.has(w));
      let sc=0,brandMatch=false;
      words.forEach(w=>{
        const wNorm=stripAcc(w);
        if(xWords.some(xw=>xw===w||stripAcc(xw)===wNorm)){sc+=2;if(w.length>=5)brandMatch=true;}
        else if(w.length>=5&&(xn.includes(w)||xnNorm.includes(wNorm)))sc+=1;
      });
      return{item:x,sc,brandMatch};
    }).filter(x=>x.sc>0).sort((a,b)=>b.sc-a.sc||(b.brandMatch?1:0)-(a.brandMatch?1:0));
    if(isDish){
      if(scored.length>0&&scored[0].sc>=words.length*1.5&&scored[0].brandMatch){
        m=scored[0].item;return{item:m,format:fmt.format,multiplier:fmt.multiplier,costPerUnit:m.x*fmt.multiplier};
      }
      return null;
    }
    if(scored.length>0&&scored[0].brandMatch&&scored[0].sc>=2){
      m=scored[0].item;return{item:m,format:fmt.format,multiplier:fmt.multiplier,costPerUnit:m.x*fmt.multiplier};
    }
    if(scored.length>0&&scored[0].sc>=Math.max(3,words.length)){
      m=scored[0].item;return{item:m,format:fmt.format,multiplier:fmt.multiplier,costPerUnit:m.x*fmt.multiplier};
    }
    return null;
  },
  // Backward compat wrapper
  matchTrivec(trivecName){
    const r=this.matchTrivecFull(trivecName);
    return r?r.item:null;
  },
  // Determine if a Trivec categorie1 is Food or Bar
  trivecToFoodBar(cat1){
    if(!cat1)return'other';
    const c=cat1.toUpperCase();
    if(c.includes('FOOD')||c.includes('NOURRITURE')||c.includes('ENTRÉE')||c.includes('PLAT')||c.includes('DESSERT')||c.includes('SALADE')||c.includes('MENU'))return'food';
    if(c.includes('VIN')||c.includes('CHAMPAGNE')||c.includes('ALCOOL')||c.includes('COCKTAIL')||c.includes('BIÈRE')||c.includes('BIERE')||c.includes('BOISSON')||c.includes('SPIRIT')||c.includes('APERITIF')||c.includes('DIGESTIF')||c.includes('SOFT'))return'bar';
    return'other';
  },
  // Format labels for display
  formatLabel(fmt){return{btl:'Bouteille',mag:'Magnum',verre:'Verre (1/17)',shot:'Shot (1/17)',coupe:'Coupe (1/17)',unit:'Unité'}[fmt]||fmt;},
  // Calculate COGS from Trivec sales × purchase prices
  // Food: uses RecipeCosts (from fiches recettes/tableau cost) per portion
  // Bar: uses format-aware bottle/verre pricing from inventory
  calculateCOGS(trivecProducts){
    let foodCOGS=0,barCOGS=0,foodCA=0,barCA=0,matched=0,unmatched=0;
    let foodMatched=0,foodUnmatched=0,barMatched=0,barUnmatched=0;
    const details=[];
    (trivecProducts||[]).forEach(tp=>{
      const type=this.trivecToFoodBar(tp.categorie1);
      let costPerUnit=null,format='unit',multiplier=1,prixAchatBase=null,invMatch=null,source='';
      if(type==='food'){
        // FOOD: use RecipeCosts lookup (cost HT per portion from Excel)
        const recipeCost=RecipeCosts[tp.nom];
        if(recipeCost!==undefined&&recipeCost>0){
          costPerUnit=recipeCost;
          source='recette';
        }else{
          // Fallback: try inventory match for raw ingredients sold directly
          const fullMatch=this.matchTrivecFull(tp.nom);
          if(fullMatch){invMatch=fullMatch.item;costPerUnit=fullMatch.costPerUnit;format=fullMatch.format;multiplier=fullMatch.multiplier;source='inventaire';}
        }
        prixAchatBase=costPerUnit;
        const cost=costPerUnit?costPerUnit*tp.totalQty:0;
        foodCA+=tp.totalPrix;
        if(costPerUnit){foodCOGS+=cost;foodMatched++;}else{foodUnmatched++;}
      }else if(type==='bar'){
        // BAR: use format-aware inventory matching (btl/mag/verre pricing)
        const fullMatch=this.matchTrivecFull(tp.nom);
        if(fullMatch){invMatch=fullMatch.item;costPerUnit=fullMatch.costPerUnit;format=fullMatch.format;multiplier=fullMatch.multiplier;prixAchatBase=invMatch.x;source='inventaire';}
        const cost=costPerUnit?costPerUnit*tp.totalQty:0;
        barCA+=tp.totalPrix;
        if(costPerUnit){barCOGS+=cost;barMatched++;}else{barUnmatched++;}
      }
      if(costPerUnit)matched++;else unmatched++;
      details.push({nom:tp.nom,cat1:tp.categorie1,type,qty:tp.totalQty,ca:tp.totalPrix,prixAchat:prixAchatBase,costPerUnit,cost:costPerUnit?costPerUnit*tp.totalQty:0,format,multiplier,matched:!!costPerUnit,invItem:invMatch,source});
    });
    return{
      foodCOGS,barCOGS,foodCA,barCA,
      foodCostPct:foodCA>0?Math.round(foodCOGS/foodCA*1000)/10:null,
      barCostPct:barCA>0?Math.round(barCOGS/barCA*1000)/10:null,
      primeCostPct:(foodCA+barCA)>0?Math.round((foodCOGS+barCOGS)/(foodCA+barCA)*1000)/10:null,
      matched,unmatched,total:matched+unmatched,
      foodMatched,foodUnmatched,barMatched,barUnmatched,
      details
    };
  },
  // Price history stored in localStorage
  _historyKey:'ima_price_history_v1',
  _getHistory(){try{return JSON.parse(localStorage.getItem(this._historyKey)||'{}');}catch(e){return{};}},
  _saveHistory(h){localStorage.setItem(this._historyKey,JSON.stringify(h));},
  // Update price with history tracking
  updatePrixWithHistory(productName,newPrix,source,date){
    const hist=this._getHistory();
    const key=productName.toLowerCase();
    if(!hist[key])hist[key]=[];
    hist[key].push({prix:newPrix,source:source||'manual',date:date||new Date().toISOString().slice(0,10)});
    // Keep last 20 entries per product
    if(hist[key].length>20)hist[key]=hist[key].slice(-20);
    this._saveHistory(hist);
    // Also update the custom price DB
    this.updatePrix(productName,newPrix,source);
  },
  getPriceHistory(productName){
    const hist=this._getHistory();
    return hist[productName.toLowerCase()]||[];
  },
  // Sync from Pennylane invoice line items
  // invoicesWithLines: array of full invoice objects with line_items/invoice_lines
  syncFromPennylane(invoicesWithLines){
    const results={added:[],updated:[],skipped:[],errors:[]};
    const supplierMap=SupplierMap.getAll();
    invoicesWithLines.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      const supplierCat=sid?SupplierMap.getCategory(sid):'Non classé';
      // Determine if this is a Food or Bar supplier
      let invCat='other';
      if(supplierCat==='Food')invCat='Food';
      else if(supplierCat==='Bar')invCat='bar_detect';
      const invDate=inv.date||new Date().toISOString().slice(0,10);
      const supplierName=SupplierMap.extractName?SupplierMap.extractName(inv):(inv.supplier?.name||'Inconnu');
      // Process line items
      const lines=inv.line_items||inv.invoice_lines||inv.lines||[];
      lines.forEach(line=>{
        const label=line.label||line.description||line.product_label||'';
        if(!label||label.length<2)return;
        const qty=parseFloat(line.quantity)||1;
        const unitPriceRaw=parseFloat(line.raw_currency_unit_price||line.unit_price||0);
        const lineTotal=parseFloat(line.currency_amount||line.amount||0);
        // Calculate unit price: prefer raw_currency_unit_price, fallback to total/qty
        const unitPrice=unitPriceRaw>0?unitPriceRaw:(qty>0?Math.abs(lineTotal/qty):0);
        if(unitPrice<=0){results.skipped.push({label,reason:'prix=0'});return;}
        // Try to match with existing product
        const existing=this.matchTrivec(label);
        if(existing){
          // Update existing product price
          const oldPrix=existing.x;
          const pctChange=oldPrix>0?Math.abs((unitPrice-oldPrix)/oldPrix*100):100;
          this.updatePrixWithHistory(existing.n,unitPrice,'pennylane:'+supplierName,invDate);
          if(pctChange>1){
            results.updated.push({label,matched:existing.n,oldPrix,newPrix:unitPrice,pctChange:Math.round(pctChange),supplier:supplierName});
          }else{
            results.skipped.push({label,reason:'prix identique'});
          }
        }else{
          // New product — determine category
          let cat=invCat==='Food'?'Food':'Spiritueux';
          // Try to guess from label
          const lbl=label.toUpperCase();
          if(lbl.includes('VIN ')||lbl.includes('BLANC')||lbl.includes('CHABLIS')||lbl.includes('SANCERRE')||lbl.includes('MEURSAULT')||lbl.includes('POUILLY'))cat='Vin Blanc';
          else if(lbl.includes('ROUGE')||lbl.includes('BORDEAUX')||lbl.includes('POMMARD')||lbl.includes('MARGAUX')||lbl.includes('PAUILLAC'))cat='Vin rouge';
          else if(lbl.includes('ROSÉ')||lbl.includes('ROSE')||lbl.includes('MINUTY'))cat='Vin rosé';
          else if(lbl.includes('CHAMPAGNE')||lbl.includes('PROSECCO')||lbl.includes('VEUVE')||lbl.includes('CRISTAL')||lbl.includes('DOM PERIGNON'))cat='Spiritueux';
          else if(lbl.includes('VODKA')||lbl.includes('GIN')||lbl.includes('RHUM')||lbl.includes('RUM')||lbl.includes('TEQUILA')||lbl.includes('WHISKY')||lbl.includes('COGNAC'))cat='Spiritueux';
          else if(invCat==='Food')cat='Food';
          // Add to custom DB
          const subCat=supplierName;
          const cust=this._getCustom();
          cust.push([cat,subCat,label,unitPrice]);
          this._saveCustom(cust);
          this.updatePrixWithHistory(label,unitPrice,'pennylane:'+supplierName+' (nouveau)',invDate);
          results.added.push({label,cat,subCat,prix:unitPrice,supplier:supplierName});
        }
      });
    });
    return results;
  },
  // Get sync stats
  getSyncStats(){
    const hist=this._getHistory();
    const entries=Object.entries(hist);
    const pennylaneUpdates=entries.filter(([k,v])=>v.some(h=>h.source?.startsWith('pennylane')));
    const manualUpdates=entries.filter(([k,v])=>v.some(h=>h.source==='manual'));
    return{totalTracked:entries.length,pennylaneUpdates:pennylaneUpdates.length,manualUpdates:manualUpdates.length};
  }
};

// ===== PENNYLANE SERVICE =====
const PennylaneService={
  getToken:()=>localStorage.getItem('ima_pennylane_token'),
  setToken:(token)=>localStorage.setItem('ima_pennylane_token',token),
  clearToken:()=>localStorage.removeItem('ima_pennylane_token'),
  _companyInfo:null,
  _cache:{},

  async request(endpoint,params={}){
    const token=this.getToken();
    const queryString=new URLSearchParams(params).toString();
    const url=`/api/pennylane?endpoint=${encodeURIComponent(endpoint)}${queryString?'&'+queryString:''}`;

    try{
      const headers={'Accept':'application/json'};
      if(token) headers['Authorization']=`Bearer ${token}`;
      const response=await fetch(url,{method:'GET',headers});
      const data=await response.json();
      if(!response.ok){
        throw new Error(data.message||data.error||`Erreur API: ${response.status}`);
      }
      return data;
    }catch(e){
      console.error('Pennylane API error:',e);
      throw e;
    }
  },

  async testConnection(){
    try{
      const data=await this.request('/me');
      this._companyInfo=data;
      return{success:true,company:data};
    }catch(e){
      return{success:false,error:e.message};
    }
  },

  // Fetch ALL supplier invoices with pagination, optional date filter
  async getAllSupplierInvoices({dateFrom,dateTo,maxPages=10}={}){
    const cacheKey=`inv_${dateFrom}_${dateTo}`;
    if(this._cache[cacheKey]&&Date.now()-this._cache[cacheKey].ts<300000)return this._cache[cacheKey].data;

    let allInvoices=[];
    let cursor=null;
    let page=0;
    try{
      while(page<maxPages){
        const params={per_page:100};
        if(dateFrom)params['filter[date]']=`>=${dateFrom}`;
        if(dateTo)params['filter[date]']=`<=${dateTo}`;
        if(cursor)params.cursor=cursor;
        const response=await this.request('/supplier_invoices',params);
        const items=response.items||response.supplier_invoices||response.data||[];
        allInvoices=allInvoices.concat(items);
        if(!response.has_more||!response.next_cursor)break;
        cursor=response.next_cursor;
        page++;
      }
    }catch(e){console.error('Failed to fetch all invoices:',e);}
    // Discover new suppliers
    const map=SupplierMap.getAll();
    allInvoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      if(sid&&!map[sid]){
        SupplierMap.setCategory(sid,'Non classé');
      }
    });
    this._cache[cacheKey]={data:allInvoices,ts:Date.now()};
    return allInvoices;
  },

  async getSupplierInvoices(params={}){
    try{
      const response=await this.request('/supplier_invoices',{per_page:25,...params});
      return response.items||response.supplier_invoices||response.data||[];
    }catch(e){
      console.error('Failed to fetch supplier invoices:',e);
      return[];
    }
  },

  async getCustomerInvoices(params={}){
    try{
      const response=await this.request('/customer_invoices',{per_page:25,...params});
      return response.items||response.customer_invoices||response.data||[];
    }catch(e){
      console.error('Failed to fetch customer invoices:',e);
      return[];
    }
  },

  // Fetch a single invoice with full line_items detail
  async getInvoiceDetail(invoiceId){
    try{
      const response=await this.request(`/supplier_invoices/${invoiceId}`);
      return response.supplier_invoice||response;
    }catch(e){
      console.error('Failed to fetch invoice detail:',e);
      return null;
    }
  },

  // Fetch line items for multiple invoices (with rate limiting)
  async getInvoicesWithLines(invoiceIds,onProgress){
    const results=[];
    for(let i=0;i<invoiceIds.length;i++){
      const detail=await this.getInvoiceDetail(invoiceIds[i]);
      if(detail)results.push(detail);
      if(onProgress)onProgress(i+1,invoiceIds.length);
      // Rate limit: 200ms between requests
      if(i<invoiceIds.length-1)await new Promise(r=>setTimeout(r,200));
    }
    return results;
  },

  async getCategories(){
    try{
      const response=await this.request('/categories');
      return response.categories||response.data||[];
    }catch(e){
      console.error('Failed to fetch categories:',e);
      return[];
    }
  },

  async getMe(){
    try{
      const data=await this.request('/me');
      this._companyInfo=data;
      return data;
    }catch(e){
      return null;
    }
  },

  getCompanyInfo(){return this._companyInfo;}
};

// ===== CSS BAR CHART =====
function BarChart({data,keys,colors,height=180,labels}){
  const max=Math.max(...data.map(d=>keys.reduce((s,k)=>s+(d[k]||0),0)));
  return(
    <div style={{display:'flex',alignItems:'flex-end',gap:6,height,paddingTop:10}}>
      {data.map((d,i)=>(
        <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:3}}>
          <div style={{fontSize:9,color:'var(--gris-400)',fontWeight:500}}>{eur(keys.reduce((s,k)=>s+(d[k]||0),0))}</div>
          <div style={{width:'100%',display:'flex',flexDirection:'column',justifyContent:'flex-end',height:height-30,gap:1}}>
            {keys.map((k,ki)=>{
              const h=max>0?((d[k]||0)/max)*(height-40):0;
              return <div key={ki} style={{height:h,background:colors[ki],borderRadius:ki===0?'4px 4px 0 0':'0',minHeight:d[k]?2:0}} title={`${labels?labels[ki]:k}: ${eur(d[k]||0)}`}/>;
            })}
          </div>
          <div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500}}>{d.label}</div>
        </div>
      ))}
    </div>
  );
}

// ===== CSS HORIZONTAL BAR =====
function HBar({data,maxVal,color='var(--bordeaux)'}){
  return(
    <div style={{display:'flex',flexDirection:'column',gap:10}}>
      {data.map((d,i)=>(
        <div key={i} style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:90,fontSize:12,fontWeight:500,color:'var(--gris-700)',textAlign:'right'}}>{d.label}</div>
          <div style={{flex:1,height:22,background:'var(--gris-100)',borderRadius:4,overflow:'hidden',position:'relative'}}>
            <div style={{height:'100%',width:`${(d.value/maxVal)*100}%`,background:color,borderRadius:4,transition:'width .5s ease'}}/>
          </div>
          <div style={{width:70,fontSize:12,fontWeight:600,textAlign:'right'}}>{d.display||eur(d.value)}</div>
        </div>
      ))}
    </div>
  );
}

// ===== DONUT CHART =====
function Donut({segments,size=130,thickness=20,centerLabel,centerValue}){
  const r=(size-thickness)/2;
  const c=2*Math.PI*r;
  let offset=0;
  return(
    <div className="donut" style={{width:size,height:size}}>
      <svg width={size} height={size}>
        {segments.map((s,i)=>{
          const dash=(s.value/100)*c;
          const o=offset;
          offset+=dash;
          return <circle key={i} cx={size/2} cy={size/2} r={r} fill="none" stroke={s.color} strokeWidth={thickness} strokeDasharray={`${dash} ${c-dash}`} strokeDashoffset={-o}/>;
        })}
      </svg>
      <div className="donut-center">
        <div className="dv">{centerValue}</div>
        <div className="dl">{centerLabel}</div>
      </div>
    </div>
  );
}

// ===== SPARKLINE =====
function Spark({data,color='var(--bordeaux)',w=120,h=32}){
  const max=Math.max(...data);const min=Math.min(...data);const range=max-min||1;
  const pts=data.map((v,i)=>`${(i/(data.length-1))*w},${h-((v-min)/range)*h}`).join(' ');
  return(<svg width={w} height={h}><polyline points={pts} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>);
}

// ===== DATA =====
// Real data comes from Pennylane, Trivec, SevenRooms APIs
const revData=[];
const weekData=[];
const costTrend=[];
const barTrend=[];
const staffTrend=[];
const mockPL=[];
const staff=[];
const stockAlerts=[];
const resas=[];
const posItems=[];
const suppliers=[];

// ===== USER MANAGEMENT =====
const UserManager={
  _getUsers(){
    try{return JSON.parse(localStorage.getItem('ima_users')||'[]');}catch(e){return[];}
  },
  _saveUsers(users){localStorage.setItem('ima_users',JSON.stringify(users));},
  getAll(){return this._getUsers();},

  authenticate(email,password){
    const users=this._getUsers();
    const user=users.find(u=>u.email.toLowerCase()===email.toLowerCase()&&u.password===password&&u.active!==false);
    if(user){
      user.lastLogin=new Date().toISOString();
      this._saveUsers(users);
      localStorage.setItem('ima_current_user',JSON.stringify({id:user.id,nom:user.nom,email:user.email,role:user.role}));
      return user;
    }
    return null;
  },

  getCurrentUser(){
    try{return JSON.parse(localStorage.getItem('ima_current_user')||'null');}catch(e){return null;}
  },

  logout(){localStorage.removeItem('ima_current_user');},

  addUser({nom,email,role,password}){
    const users=this._getUsers();
    if(users.find(u=>u.email.toLowerCase()===email.toLowerCase()))return{error:'Cet email existe déjà'};
    const newUser={id:Date.now(),nom,email:email.toLowerCase(),role:role||'Viewer',password:password||Math.random().toString(36).slice(-8),active:true,createdAt:new Date().toISOString(),invitedBy:this.getCurrentUser()?.nom||'Système'};
    users.push(newUser);
    this._saveUsers(users);
    return{success:true,user:newUser};
  },

  removeUser(id){
    const users=this._getUsers().filter(u=>u.id!==id);
    this._saveUsers(users);
  },

  updateUser(id,updates){
    const users=this._getUsers();
    const idx=users.findIndex(u=>u.id===id);
    if(idx>=0){users[idx]={...users[idx],...updates};this._saveUsers(users);}
  },

  initDefaults(){
    if(this._getUsers().length>0)return;
    this.addUser({nom:'Nicolas Spielmann',email:'nicolas@ima-club.com',role:'Admin',password:'N39suy**93'});
  }
};
UserManager.initDefaults();

// ===== LOGIN =====
function Login({onLogin}){
  const[email,setEmail]=useState('');
  const[password,setPassword]=useState('');
  const[error,setError]=useState('');

  const handleLogin=()=>{
    if(!email||!password){setError('Veuillez remplir tous les champs');return;}
    const user=UserManager.authenticate(email,password);
    if(user){
      setError('');
      onLogin(user);
    }else{
      setError('Email ou mot de passe incorrect');
    }
  };

  const handleKeyDown=(e)=>{if(e.key==='Enter')handleLogin();};

  return(
    <div className="login">
      <div className="login-c">
        <div className="login-logo">IMa</div>
        <div className="login-tag">Tour de contrôle</div>
        <div className="login-form">
          <h3>Connexion</h3>
          <div className="fg"><label className="fl">Email</label><input className="fi" type="email" value={email} onChange={e=>setEmail(e.target.value)} onKeyDown={handleKeyDown} placeholder="votre@email.com"/></div>
          <div className="fg"><label className="fl">Mot de passe</label><input className="fi" type="password" value={password} onChange={e=>setPassword(e.target.value)} onKeyDown={handleKeyDown} placeholder="••••••••"/></div>
          {error&&<div className="error-msg" style={{marginBottom:10}}>{error}</div>}
          <button className="login-btn" onClick={handleLogin}>Se connecter</button>
          <p style={{fontSize:10,color:'var(--gris-400)',textAlign:'center',marginTop:14}}>dashboard-ima.com</p>
        </div>
      </div>
    </div>
  );
}

// ===== DASHBOARD =====
function Dashboard(){
  const team=StaffRegistry.getActive();
  const tipsEligible=StaffRegistry.getTipsEligible();
  const trivecMonth=TrivecService.getMonthData();
  const latestDay=TrivecService.getLatestDay();
  const hasTrivec=TrivecService.isConnected();
  return(<div className="fin">
    {!hasTrivec&&<div style={{background:'var(--bleu-light)',border:'1px solid var(--bleu)',borderRadius:10,padding:16,marginBottom:20,fontSize:13,color:'var(--bleu)'}}>
      <strong>Bienvenue sur le tableau de bord IMA.</strong> Les données s'afficheront automatiquement lorsque vos services seront connectés. Rendez-vous dans <strong>Administration</strong> pour configurer Pennylane, Trivec et SevenRooms.
    </div>}
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">CA du mois</div><div className="kpi-val" style={{color:hasTrivec?'var(--gris-900)':'var(--gris-300)'}}>{hasTrivec?trivecMonth.totalCA.toLocaleString('fr-FR')+'€':'—'}</div><div className={`kpi-chg ${hasTrivec?'pos':'neu'}`}>{hasTrivec?`${trivecMonth.days} jour(s) importé(s)`:'En attente Trivec'}</div></div>
      <div className="kpi"><div className="kpi-label">Couverts</div><div className="kpi-val" style={{color:hasTrivec?'var(--gris-900)':'var(--gris-300)'}}>{hasTrivec?trivecMonth.totalCouverts.toLocaleString('fr-FR'):'—'}</div><div className={`kpi-chg ${hasTrivec?'pos':'neu'}`}>{hasTrivec?`TM: ${Math.round(trivecMonth.ticketMoyen)}€`:'En attente Trivec'}</div></div>
      <div className="kpi"><div className="kpi-label">Effectif actif</div><div className="kpi-val">{team.length}</div><div className="kpi-chg neu">{tipsEligible.length} bénéf. tips</div></div>
      <div className="kpi"><div className="kpi-label">Pennylane</div><div className="kpi-val" style={{fontSize:16}}>{PennylaneService.getToken()?'Connecté':'Non configuré'}</div><div className={`kpi-chg ${PennylaneService.getToken()?'pos':'neg'}`}>{PennylaneService.getToken()?'API active':'Voir Administration'}</div></div>
    </div>
    <div className="cg">
      <div className="card">
        <div className="card-h"><div><div className="card-t">Évolution du CA</div><div className="card-st">Données Trivec</div></div>{hasTrivec?<span className="badge b-ok">Connecté</span>:<span className="badge b-warn">Non connecté</span>}</div>
        <div className="card-b">
          {hasTrivec?(()=>{
            const days=TrivecService.getAllDays();
            const sorted=Object.entries(days).sort((a,b)=>{const pa=a[0].split('/').reverse().join('');const pb=b[0].split('/').reverse().join('');return pa.localeCompare(pb);});
            const maxCA=Math.max(...sorted.map(([,d])=>d.caTotal||0),1);
            return<div>
              <div style={{display:'flex',gap:2,alignItems:'flex-end',height:120,marginBottom:12}}>
                {sorted.map(([date,d])=>{
                  const h=Math.max(4,((d.caTotal||0)/maxCA)*100);
                  return<div key={date} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2}} title={`${date}: ${(d.caTotal||0).toLocaleString('fr-FR')}€`}>
                    <div style={{width:'100%',maxWidth:32,height:h+'%',background:'var(--bordeaux)',borderRadius:'4px 4px 0 0',minHeight:4,transition:'height .3s'}}/>
                    <div style={{fontSize:8,color:'var(--gris-400)',transform:'rotate(-45deg)',transformOrigin:'center',whiteSpace:'nowrap'}}>{date.substring(0,5)}</div>
                  </div>;
                })}
              </div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,fontSize:11,textAlign:'center',borderTop:'1px solid var(--gris-100)',paddingTop:10}}>
                <div><div style={{color:'var(--gris-500)'}}>Restaurant</div><div style={{fontWeight:700}}>{trivecMonth.caRestaurant.toLocaleString('fr-FR')}€</div></div>
                <div><div style={{color:'var(--gris-500)'}}>Club</div><div style={{fontWeight:700}}>{trivecMonth.caClub.toLocaleString('fr-FR')}€</div></div>
                <div><div style={{color:'var(--gris-500)'}}>Bar</div><div style={{fontWeight:700}}>{trivecMonth.caBar.toLocaleString('fr-FR')}€</div></div>
              </div>
            </div>;
          })():<div style={{padding:40,textAlign:'center',color:'var(--gris-400)'}}>
            <div style={{fontSize:32,marginBottom:8}}>📊</div>
            <div style={{fontWeight:500}}>Importez les fichiers Trivec dans Administration</div>
            <div style={{fontSize:11,marginTop:4}}>Le graphique d'évolution du CA s'affichera automatiquement</div>
          </div>}
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Réservations du jour</div><div className="card-st">Données SevenRooms</div></div><span className="badge b-warn">Non connecté</span></div>
        <div className="card-b" style={{padding:40,textAlign:'center',color:'var(--gris-400)'}}>
          <div style={{fontSize:32,marginBottom:8}}>📋</div>
          <div style={{fontWeight:500}}>Connectez SevenRooms pour voir les réservations</div>
          <div style={{fontSize:11,marginTop:4}}>Les réservations du jour apparaîtront ici</div>
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Coûts Pennylane</div><div className="card-st">Factures fournisseurs</div></div>{PennylaneService.getToken()?<span className="badge b-ok">Connecté</span>:<span className="badge b-warn">Non connecté</span>}</div>
        <div className="card-b" style={{padding:40,textAlign:'center',color:'var(--gris-400)'}}>
          {PennylaneService.getToken()?
            <div><div style={{fontWeight:500,color:'var(--vert)'}}>Pennylane connecté</div><div style={{fontSize:11,marginTop:4}}>Consultez Finance & P&L et Food & Bar Cost pour les détails</div></div>:
            <div><div style={{fontSize:32,marginBottom:8}}>💰</div><div style={{fontWeight:500}}>Configurez Pennylane dans Administration</div></div>
          }
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Équipe</div></div></div>
        <div className="card-b">
          {team.length>0?<div>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8,fontSize:12,color:'var(--gris-500)'}}>
              <span>Salle: {team.filter(e=>e.section==='salle').length}</span>
              <span>Cuisine: {team.filter(e=>e.section==='cuisine').length}</span>
              <span>Tips: {tipsEligible.length}</span>
            </div>
            {team.slice(0,5).map(e=>(<div key={e.id} style={{padding:'6px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:12}}>
              <span style={{fontWeight:500}}>{e.nom}</span>
              <span className="badge b-ima" style={{fontSize:9}}>{e.poste}</span>
            </div>))}
            {team.length>5&&<div style={{textAlign:'center',fontSize:11,color:'var(--gris-400)',marginTop:8}}>+{team.length-5} autres</div>}
          </div>:<div style={{textAlign:'center',padding:20,color:'var(--gris-400)',fontSize:12}}>Ajoutez votre équipe dans Staff & RH</div>}
        </div>
      </div>
    </div>
  </div>);
}

// ===== FINANCE =====
function Finance(){
  const[allInvoices,setAllInvoices]=useState([]);
  const[loading,setLoading]=useState(false);
  const[loaded,setLoaded]=useState(false);
  const[expandedGroup,setExpandedGroup]=useState('Coûts Directs (Prime Cost)');

  useEffect(()=>{
    if(PennylaneService.getToken()){
      setLoading(true);
      PennylaneService.getAllSupplierInvoices({maxPages:5})
        .then(invoices=>{
          setAllInvoices(invoices);
          setLoaded(true);
        })
        .finally(()=>setLoading(false));
    }
  },[]);

  const totals=useMemo(()=>SupplierMap.getTotals(allInvoices),[allInvoices]);
  const groupTotals=useMemo(()=>SupplierMap.getGroupTotals(totals),[totals]);
  const totalCosts=Object.values(totals).reduce((s,v)=>s+v,0);

  // CA from Trivec data
  const trivecMonth=useMemo(()=>TrivecService.getMonthData(),[]);
  const caFood=trivecMonth.caRestaurant||0;
  const caBar=(trivecMonth.caClub||0)+(trivecMonth.caBar||0);
  const caTotal=trivecMonth.totalCA||0;

  // Calculate EBITDA
  const staffCosts=totals['Staff']||0;
  const primeCostTotal=(totals['Food']||0)+(totals['Bar']||0)+staffCosts;
  const primeCostPct=caTotal>0?(primeCostTotal/caTotal)*100:0;
  const ebitda=caTotal-totalCosts;

  // Build P&L table data
  const plData=[];
  plData.push({type:'revenue',label:'CA Restaurant',amount:trivecMonth.caRestaurant||0,pct:caTotal>0?100*((trivecMonth.caRestaurant||0)/caTotal):0,isSubsection:false,isBold:true,color:'var(--vert)'});
  plData.push({type:'revenue',label:'CA Club',amount:trivecMonth.caClub||0,pct:caTotal>0?100*((trivecMonth.caClub||0)/caTotal):0,isSubsection:false,isBold:false,color:'var(--bordeaux)'});
  plData.push({type:'revenue',label:'CA Bar',amount:trivecMonth.caBar||0,pct:caTotal>0?100*((trivecMonth.caBar||0)/caTotal):0,isSubsection:false,isBold:false,color:'var(--orange)'});
  plData.push({type:'spacer'});

  for(const[groupName,groupInfo]of Object.entries(COST_GROUPS)){
    const groupTotal=groupTotals[groupName]||0;
    if(groupTotal===0)continue;
    plData.push({type:'group',label:groupName,amount:-groupTotal,pct:-100*(groupTotal/caTotal),groupName,color:groupInfo.color,isBold:true});
    const catsWithData=groupInfo.cats.filter(c=>(totals[c]||0)!==0);
    for(const cat of catsWithData){
      const catTotal=totals[cat]||0;
      plData.push({type:'category',label:cat,amount:-catTotal,pct:-100*(catTotal/caTotal),indent:true,color:CAT_COLORS[cat]});
    }
  }

  plData.push({type:'spacer'});
  plData.push({type:'total',label:'EBITDA',amount:ebitda,pct:100*(ebitda/caTotal),isSubsection:false,isBold:true,color:ebitda>0?'var(--vert)':'var(--rouge)'});

  // Donut data - cost proportions
  const donutSegments=[];
  const colors=['#581527','#7a2d42','#a04560','#c46880','#059669'];
  let colorIdx=0;
  for(const[groupName,groupInfo]of Object.entries(COST_GROUPS)){
    const groupTotal=groupTotals[groupName]||0;
    if(groupTotal>0){
      const pct=100*(groupTotal/totalCosts);
      donutSegments.push({value:pct,color:colors[colorIdx%colors.length]});
      colorIdx++;
    }
  }

  return(<div className="fin">
    {!PennylaneService.getToken()&&<div style={{background:'var(--orange-light)',border:'1px solid var(--orange)',borderRadius:8,padding:14,marginBottom:16,color:'var(--orange)',fontSize:13}}>
      <strong>Configuration requise :</strong> Veuillez configurer votre token Pennylane dans les paramètres pour afficher les données réelles des coûts.
    </div>}

    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">CA Total</div><div className="kpi-val">{eur(caTotal)}</div><div className="kpi-chg pos"><I.Up/> +11.9%</div></div>
      <div className="kpi"><div className="kpi-label">Coûts totaux</div><div className="kpi-val">{eur(totalCosts)}</div><div className="kpi-chg neu">{allInvoices.length} factures</div></div>
      <div className="kpi"><div className="kpi-label">EBITDA</div><div className="kpi-val" style={{color:ebitda>0?'var(--vert)':'var(--rouge)'}}>{eur(ebitda)}</div><div className={`kpi-chg ${ebitda>0?'pos':'neg'}`}>{ebitda>0?'Marge positive':'Déficit'}</div></div>
      <div className="kpi"><div className="kpi-label">Prime Cost %</div><div className="kpi-val">{primeCostPct.toFixed(1)}%</div><div className="kpi-chg neu">Food+Bar+Staff</div></div>
    </div>

    {loading&&<div style={{textAlign:'center',padding:40}}><div className="spinner" style={{width:24,height:24}}/><div style={{marginTop:10,fontSize:13,color:'var(--gris-500)'}}>Chargement Pennylane...</div></div>}

    {!loading&&<div>
    <div className="card" style={{marginBottom:16}}>
      <div className="card-h"><div><div className="card-t">Compte de résultat — Février 2026</div><div className="card-st">CA estimé + Coûts Pennylane</div></div><span className="badge b-ima">Pennylane</span></div>
      <div className="card-b"><div className="tbl"><table>
        <thead><tr><th>Poste</th><th style={{textAlign:'right'}}>Montant</th><th style={{textAlign:'right'}}>% CA</th><th style={{width:180}}>Répartition</th></tr></thead>
        <tbody>
          {plData.map((row,i)=>{
            if(row.type==='spacer')return <tr key={`spacer-${i}`} style={{height:8}}><td colSpan={4}/></tr>;
            if(row.type==='revenue'||row.type==='group'||row.type==='category'||row.type==='total'){
              const isBold=row.isBold;
              const fontSize=row.isBold?14:13;
              return <tr key={i} style={{fontWeight:isBold?700:400,background:row.type==='total'?'var(--gris-50)':'transparent',borderTop:row.type==='total'?'2px solid var(--gris-300)':'none'}}>
                <td style={{paddingLeft:row.indent?40:14,fontSize}}>{row.label}{row.type==='revenue'&&<span className="badge b-warn" style={{marginLeft:8,fontSize:9}}>Estimé</span>}</td>
                <td style={{textAlign:'right',color:row.color,fontSize}}>{eur(row.amount)}</td>
                <td style={{textAlign:'right'}}>{Math.abs(row.pct).toFixed(1)}%</td>
                <td><div className="pbar"><div className="pfill" style={{width:`${Math.abs(row.pct)*1.5}%`,background:row.color}}/></div></td>
              </tr>;
            }
            return null;
          })}
        </tbody>
      </table></div></div>
    </div>

    <div className="cg" style={{marginTop:16}}>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Répartition des charges</div><div className="card-st">{allInvoices.length} factures Pennylane</div></div></div>
        <div className="card-b">
          {donutSegments.length>0?<div className="donut-wrap">
            <Donut segments={donutSegments} size={150} thickness={22} centerValue={`${(totalCosts/caTotal*100).toFixed(0)}%`} centerLabel="Coûts"/>
            <div className="donut-legend">
              {Object.entries(COST_GROUPS).map(([groupName,groupInfo],i)=>{
                const gt=groupTotals[groupName]||0;
                if(gt===0)return null;
                return <div key={groupName} className="donut-legend-item">
                  <div className="donut-legend-dot" style={{background:colors[i%colors.length]}}/>
                  {groupName} — {(100*(gt/totalCosts)).toFixed(1)}%
                </div>;
              })}
            </div>
          </div>:<div style={{padding:20,textAlign:'center',color:'var(--gris-400)'}}>Aucune donnée Pennylane</div>}
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Évolution CA Food vs Bar</div></div></div>
        <div className="card-b"><BarChart data={revData} keys={['food','bar']} colors={['#581527','#c46880']} labels={['Food','Bar']} height={220}/></div>
      </div>
    </div>

    <div className="card">
      <div className="card-h"><div><div className="card-t">Détail des charges par groupe</div><div className="card-st">Cliquez pour voir les catégories détaillées</div></div></div>
      <div className="card-b">
        {Object.entries(COST_GROUPS).map(([groupName,groupInfo])=>{
          const gt=groupTotals[groupName]||0;
          if(gt===0)return null;
          const catsWithData=groupInfo.cats.filter(c=>(totals[c]||0)!==0);
          return <div key={groupName} style={{marginBottom:12}}>
            <div style={{cursor:'pointer',padding:'10px 14px',background:'var(--gris-50)',borderRadius:8,display:'flex',justifyContent:'space-between',alignItems:'center'}} onClick={()=>setExpandedGroup(expandedGroup===groupName?null:groupName)}>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <div style={{width:4,height:28,borderRadius:2,background:groupInfo.color}}/>
                <div style={{fontWeight:600,color:'var(--gris-800)'}}>{groupName}</div>
                <span className="badge b-ima" style={{fontSize:9}}>{catsWithData.length} cat.</span>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:12}}>
                <div style={{textAlign:'right'}}>
                  <div style={{fontSize:14,fontWeight:700,color:groupInfo.color}}>{eur(gt)}</div>
                  <div style={{fontSize:9,color:'var(--gris-400)'}}>{(100*(gt/totalCosts)).toFixed(1)}% des coûts</div>
                </div>
                <I.Chev style={{transform:expandedGroup===groupName?'rotate(180deg)':'rotate(0deg)',transition:'transform .2s'}}/>
              </div>
            </div>
            {expandedGroup===groupName&&<div style={{marginTop:8,paddingLeft:14}}>
              {catsWithData.map(cat=>{
                const ct=totals[cat]||0;
                return <div key={cat} style={{padding:'8px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <div style={{width:8,height:8,borderRadius:2,background:CAT_COLORS[cat]||'var(--gris-400)'}}/>
                    <span style={{fontWeight:500}}>{cat}</span>
                    <span className="badge b-ima" style={{fontSize:8}}>{(allInvoices.filter(inv=>{
                      const sid=String(inv.supplier?.id||'');
                      return SupplierMap.getCategory(sid)===cat;
                    })).length} fact.</span>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:14}}>
                    <span style={{fontSize:11,color:'var(--gris-500)'}}>{(100*(ct/totalCosts)).toFixed(1)}%</span>
                    <span style={{fontWeight:700,minWidth:70,textAlign:'right'}}>{eur(ct)}</span>
                  </div>
                </div>;
              })}
            </div>}
          </div>;
        })}
      </div>
    </div>
    </div>}
  </div>);
}

// ===== COSTS =====
function Costs(){
  const[tab,setTab]=useState('overview');
  const[allInvoices,setAllInvoices]=useState([]);
  const[loading,setLoading]=useState(false);
  const[loaded,setLoaded]=useState(false);
  const[supplierNames,setSupplierNames]=useState({});
  const[editingSupplier,setEditingSupplier]=useState(null);
  const[mapVersion,setMapVersion]=useState(0);
  const[expandedCat,setExpandedCat]=useState(null);
  const[filterCat,setFilterCat]=useState('Tous');
  const[syncing,setSyncing]=useState(false);
  const[syncProgress,setSyncProgress]=useState('');
  const[syncResults,setSyncResults]=useState(null);

  useEffect(()=>{
    if(PennylaneService.getToken()){
      setLoading(true);
      PennylaneService.getAllSupplierInvoices({maxPages:5})
        .then(invoices=>{
          setAllInvoices(invoices);
          const names={};
          invoices.forEach(inv=>{
            const sid=String(inv.supplier?.id||'');
            if(sid&&!names[sid])names[sid]=SupplierMap.extractName(inv);
          });
          setSupplierNames(names);
          setLoaded(true);
        })
        .finally(()=>setLoading(false));
    }
  },[]);

  const categorized=useMemo(()=>SupplierMap.categorize(allInvoices),[allInvoices,mapVersion]);
  const totals=useMemo(()=>SupplierMap.getTotals(allInvoices),[allInvoices,mapVersion]);
  const groupTotals=useMemo(()=>SupplierMap.getGroupTotals(totals),[totals]);
  const totalAll=Object.values(totals).reduce((s,v)=>s+v,0);
  const foodTotal=totals['Food']||0;
  const barTotal=totals['Bar']||0;
  const primeCost=(foodTotal+barTotal+(totals['Staff']||0));

  const supplierGroups=useMemo(()=>{
    const groups={};
    allInvoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      if(!sid)return;
      if(!groups[sid])groups[sid]={id:sid,name:supplierNames[sid]||'Inconnu',total:0,totalHT:0,count:0,cat:SupplierMap.getCategory(sid)};
      groups[sid].total+=parseFloat(inv.amount||0);
      groups[sid].totalHT+=parseFloat(inv.currency_amount_before_tax||0);
      groups[sid].count++;
    });
    return Object.values(groups).sort((a,b)=>Math.abs(b.total)-Math.abs(a.total));
  },[allInvoices,supplierNames,mapVersion]);

  const handleCategoryChange=(supplierId,newCat)=>{
    SupplierMap.setCategory(supplierId,newCat);
    setMapVersion(v=>v+1);
    setEditingSupplier(null);
  };

  // Helper: render invoice table for a category
  const InvoiceTable=({catName,invoices,color})=>{
    const sorted=invoices.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const totalTTC=invoices.reduce((s,i)=>s+parseFloat(i.amount||0),0);
    const totalHT=invoices.reduce((s,i)=>s+parseFloat(i.currency_amount_before_tax||0),0);
    return(<div className="card" style={{marginBottom:14}}>
      <div className="card-h">
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:4,height:28,borderRadius:2,background:color||'var(--bordeaux)'}}/>
          <div><div className="card-t">{catName}</div><div className="card-st">{invoices.length} facture{invoices.length>1?'s':''} — Total: {eur(totalTTC)}</div></div>
        </div>
        <span className="badge b-ima">Pennylane</span>
      </div>
      <div className="card-b"><div className="tbl"><table>
        <thead><tr><th>Fournisseur</th><th>N° Facture</th><th>Date</th><th style={{textAlign:'right'}}>HT</th><th style={{textAlign:'right'}}>TTC</th><th>Statut</th></tr></thead>
        <tbody>{sorted.map((inv,i)=>(
          <tr key={inv.id||i}>
            <td style={{fontWeight:500}}>{SupplierMap.extractName(inv)}</td>
            <td style={{fontSize:12}}>{inv.invoice_number||'—'}</td>
            <td style={{fontSize:12}}>{inv.date||'—'}</td>
            <td style={{textAlign:'right'}}>{eur(parseFloat(inv.currency_amount_before_tax||0))}</td>
            <td style={{textAlign:'right',fontWeight:600}}>{eur(parseFloat(inv.amount||0))}</td>
            <td><span className={`badge ${inv.payment_status==='paid'?'b-ok':'b-warn'}`}>{inv.payment_status==='paid'?'Payée':'À traiter'}</span></td>
          </tr>))}</tbody>
        <tfoot><tr style={{fontWeight:700,background:'var(--gris-50)',borderTop:'2px solid var(--gris-300)'}}>
          <td>TOTAL</td><td/><td/>
          <td style={{textAlign:'right'}}>{eur(totalHT)}</td>
          <td style={{textAlign:'right',color:color||'var(--bordeaux)',fontSize:15}}>{eur(totalTTC)}</td><td/>
        </tr></tfoot>
      </table></div></div>
    </div>);
  };

  return(<div className="fin">
    <div className="tabs">
      <div className={`tab ${tab==='overview'?'active':''}`} onClick={()=>setTab('overview')}>Vue d'ensemble</div>
      <div className={`tab ${tab==='food'?'active':''}`} onClick={()=>setTab('food')}>Food</div>
      <div className={`tab ${tab==='bar'?'active':''}`} onClick={()=>setTab('bar')}>Bar</div>
      <div className={`tab ${tab==='charges'?'active':''}`} onClick={()=>setTab('charges')}>Charges</div>
      <div className={`tab ${tab==='ratios'?'active':''}`} onClick={()=>setTab('ratios')}>Ratios & COGS</div>
      <div className={`tab ${tab==='fournisseurs'?'active':''}`} onClick={()=>setTab('fournisseurs')}>Tous les fournisseurs</div>
      <div className={`tab ${tab==='mapping'?'active':''}`} onClick={()=>setTab('mapping')}>Mapping</div>
    </div>

    {loading&&<div style={{textAlign:'center',padding:40}}><div className="spinner" style={{width:24,height:24}}/><div style={{marginTop:10,fontSize:13,color:'var(--gris-500)'}}>Chargement Pennylane...</div></div>}

    {!loading&&loaded&&<div>
    {/* KPI */}
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">Achats Food</div><div className="kpi-val" style={{color:'#059669'}}>{eur(foodTotal)}</div><div className="kpi-chg pos">{(categorized['Food']||[]).length} factures</div></div>
      <div className="kpi"><div className="kpi-label">Achats Bar</div><div className="kpi-val" style={{color:'#581527'}}>{eur(barTotal)}</div><div className="kpi-chg pos">{(categorized['Bar']||[]).length} factures</div></div>
      <div className="kpi"><div className="kpi-label">Total charges</div><div className="kpi-val">{eur(totalAll)}</div><div className="kpi-chg neu">{allInvoices.length} factures</div></div>
      <div className="kpi"><div className="kpi-label">Non classé</div><div className="kpi-val" style={{color:(totals['Non classé']||0)>0?'var(--rouge)':'var(--vert)'}}>{eur(totals['Non classé']||0)}</div>
        <div className="kpi-chg neg">{supplierGroups.filter(s=>s.cat==='Non classé').length} fournisseurs</div></div>
    </div>

    {/* ===== TAB: OVERVIEW ===== */}
    {tab==='overview'&&<div>
      {/* Cost groups summary */}
      {Object.entries(COST_GROUPS).map(([groupName,groupInfo])=>{
        const groupTotal=groupInfo.cats.reduce((s,c)=>s+(totals[c]||0),0);
        if(groupTotal===0&&groupName==='Hors Exploitation')return null;
        const catsWithData=groupInfo.cats.filter(c=>(totals[c]||0)!==0);
        return(<div className="card" key={groupName} style={{marginBottom:14}}>
          <div className="card-h" style={{cursor:'pointer'}} onClick={()=>setExpandedCat(expandedCat===groupName?null:groupName)}>
            <div style={{display:'flex',alignItems:'center',gap:10}}>
              <div style={{width:4,height:36,borderRadius:2,background:groupInfo.color}}/>
              <div>
                <div className="card-t">{groupName}</div>
                <div className="card-st">{groupInfo.desc} — {catsWithData.length} catégorie{catsWithData.length>1?'s':''}</div>
              </div>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:14}}>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:22,fontWeight:700,color:groupInfo.color}}>{eur(groupTotal)}</div>
                <div style={{fontSize:11,color:'var(--gris-400)'}}>{totalAll>0?((groupTotal/totalAll)*100).toFixed(1):0}% du total</div>
              </div>
              <I.Chev/>
            </div>
          </div>
          {(expandedCat===groupName||groupName.includes('Prime'))&&<div className="card-b" style={{paddingTop:0}}>
            {catsWithData.map(cat=>{
              const catInvoices=categorized[cat]||[];
              const catTotal=totals[cat]||0;
              const catHT=catInvoices.reduce((s,i)=>s+parseFloat(i.currency_amount_before_tax||0),0);
              return(<div key={cat} style={{padding:'10px 0',borderBottom:'1px solid var(--gris-100)'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}} onClick={()=>setExpandedCat(expandedCat===cat?groupName:cat)}>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <div style={{width:10,height:10,borderRadius:3,background:CAT_COLORS[cat]||'var(--gris-400)'}}/>
                    <div style={{fontWeight:500,fontSize:13}}>{cat}</div>
                    <span className="badge b-ima" style={{fontSize:9}}>{catInvoices.length} fact.</span>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:14}}>
                    <div style={{fontSize:11,color:'var(--gris-500)'}}>HT: {eur(catHT)}</div>
                    <div style={{fontWeight:700,fontSize:14}}>{eur(catTotal)}</div>
                    <div style={{width:100}}><div className="pbar"><div className="pfill" style={{width:`${totalAll>0?Math.min(Math.abs(catTotal/totalAll)*100*3,100):0}%`,background:CAT_COLORS[cat]||'var(--gris-400)'}}/></div></div>
                  </div>
                </div>
                {expandedCat===cat&&<div style={{marginTop:8}}><div className="tbl"><table style={{fontSize:12}}>
                  <thead><tr><th>Fournisseur</th><th>Date</th><th style={{textAlign:'right'}}>HT</th><th style={{textAlign:'right'}}>TTC</th></tr></thead>
                  <tbody>{catInvoices.sort((a,b)=>new Date(b.date)-new Date(a.date)).map((inv,i)=>(
                    <tr key={inv.id||i}><td>{SupplierMap.extractName(inv)}</td><td>{inv.date}</td>
                    <td style={{textAlign:'right'}}>{eur(parseFloat(inv.currency_amount_before_tax||0))}</td>
                    <td style={{textAlign:'right',fontWeight:600}}>{eur(parseFloat(inv.amount||0))}</td></tr>
                  ))}</tbody>
                </table></div></div>}
              </div>);
            })}
            {catsWithData.length===0&&<div style={{padding:10,color:'var(--gris-400)',fontSize:12}}>Aucune facture dans ce groupe</div>}
          </div>}
        </div>);
      })}

      {/* Répartition bar chart */}
      <div className="card">
        <div className="card-h"><div><div className="card-t">Répartition des charges</div></div></div>
        <div className="card-b">
          <HBar data={ALL_CATEGORIES.filter(c=>(totals[c]||0)!==0).map(c=>({
            label:c,value:Math.abs(totals[c]||0),display:eur(totals[c]||0)
          })).sort((a,b)=>b.value-a.value)}
            maxVal={Math.max(...ALL_CATEGORIES.map(c=>Math.abs(totals[c]||0)))||1}
            color="var(--bordeaux)"/>
        </div>
      </div>
    </div>}

    {/* ===== TAB: FOOD ===== */}
    {tab==='food'&&<div>
      <InvoiceTable catName="Achats Food" invoices={categorized['Food']||[]} color="#059669"/>
      {(categorized['Food']||[]).length===0&&<div className="alert-i a-warn"><I.Warn/><div><div className="at">Aucune facture Food</div><div className="as">Classez vos fournisseurs dans l'onglet Mapping</div></div></div>}
    </div>}

    {/* ===== TAB: BAR ===== */}
    {tab==='bar'&&<div>
      <InvoiceTable catName="Achats Bar" invoices={categorized['Bar']||[]} color="#581527"/>
      {(categorized['Bar']||[]).length===0&&<div className="alert-i a-warn"><I.Warn/><div><div className="at">Aucune facture Bar</div><div className="as">Classez vos fournisseurs dans l'onglet Mapping</div></div></div>}
    </div>}

    {/* ===== TAB: CHARGES ===== */}
    {tab==='charges'&&<div>
      {Object.entries(COST_GROUPS).filter(([g])=>!g.includes('Prime')).map(([groupName,groupInfo])=>{
        const catsWithData=groupInfo.cats.filter(c=>(categorized[c]||[]).length>0);
        if(catsWithData.length===0)return null;
        return catsWithData.map(cat=>(
          <InvoiceTable key={cat} catName={cat} invoices={categorized[cat]||[]} color={CAT_COLORS[cat]}/>
        ));
      })}
    </div>}

    {/* ===== TAB: RATIOS & COGS ===== */}
    {tab==='ratios'&&(()=>{
      const data=TrivecService._getData();
      const assorts=data.assortiments||{};
      const pMap={};
      for(const[ds,assort]of Object.entries(assorts)){
        (assort.products||[]).forEach(p=>{
          const k=p.nom;
          if(!pMap[k])pMap[k]={nom:p.nom,categorie1:p.categorie1,categorie2:p.categorie2,categorie3:p.categorie3,totalQty:0,totalPrix:0,jours:[]};
          pMap[k].totalQty+=p.quantite;pMap[k].totalPrix+=p.prix;
        });
      }
      const trivecProds=Object.values(pMap);
      const cogs=InventoryService.calculateCOGS(trivecProds);
      const foodPct=cogs.foodCostPct;const barPct=cogs.barCostPct;
      return<div>
        {/* KPIs */}
        <div className="kpi-g">
          <div className="kpi"><div className="kpi-label">Food Cost</div><div className="kpi-val" style={{color:foodPct!==null?(foodPct<=28?'var(--vert)':'var(--rouge)'):'var(--gris-300)'}}>{foodPct!==null?foodPct+'%':'—'}</div><div className={`kpi-chg ${foodPct!==null&&foodPct<=28?'pos':'neg'}`}>Objectif: ≤ 28%</div></div>
          <div className="kpi"><div className="kpi-label">Bar Cost</div><div className="kpi-val" style={{color:barPct!==null?(barPct<=20?'var(--vert)':'var(--rouge)'):'var(--gris-300)'}}>{barPct!==null?barPct+'%':'—'}</div><div className={`kpi-chg ${barPct!==null&&barPct<=20?'pos':'neg'}`}>Objectif: ≤ 20%</div></div>
          <div className="kpi"><div className="kpi-label">COGS Food</div><div className="kpi-val">{eur(cogs.foodCOGS)}</div><div className="kpi-chg neu">CA Food: {eur(cogs.foodCA)}</div></div>
          <div className="kpi"><div className="kpi-label">COGS Bar</div><div className="kpi-val">{eur(cogs.barCOGS)}</div><div className="kpi-chg neu">CA Bar: {eur(cogs.barCA)}</div></div>
        </div>

        {/* Matching quality */}
        <div className="alert-i a-info" style={{marginBottom:14}}>
          <I.Info/><div><div className="at">Couverture du matching: {cogs.total>0?Math.round(cogs.matched/cogs.total*100):0}%</div><div className="as">{cogs.matched} produits matchés sur {cogs.total} — {cogs.unmatched} sans prix d'achat</div></div>
        </div>

        {/* Sync Pennylane button */}
        <div className="card" style={{marginBottom:14}}>
          <div className="card-h">
            <div><div className="card-t">Synchronisation Pennylane → Base prix</div><div className="card-st">Récupère les lignes de factures fournisseurs et met à jour les prix d'achat</div></div>
            {!syncing?<button className="btn btn-primary" onClick={async()=>{
              if(!PennylaneService.getToken()){setSyncResults({error:'Pennylane non connecté. Configurez le token dans Administration.'});return;}
              setSyncing(true);setSyncProgress('Chargement des factures...');setSyncResults(null);
              try{
                const invoices=await PennylaneService.getAllSupplierInvoices({maxPages:5});
                const foodBarInv=invoices.filter(inv=>{const sid=String(inv.supplier?.id||'');const cat=SupplierMap.getCategory(sid);return cat==='Food'||cat==='Bar';});
                if(foodBarInv.length===0){setSyncResults({error:'Aucune facture Food/Bar trouvée. Classez vos fournisseurs dans l\'onglet Mapping.'});setSyncing(false);return;}
                setSyncProgress(`Récupération détails: 0/${foodBarInv.length} factures...`);
                const ids=foodBarInv.map(i=>i.id).filter(Boolean);
                const detailed=await PennylaneService.getInvoicesWithLines(ids,(done,total)=>{
                  setSyncProgress(`Récupération détails: ${done}/${total} factures...`);
                });
                setSyncProgress('Analyse des lignes...');
                const results=InventoryService.syncFromPennylane(detailed);
                setSyncResults(results);
              }catch(e){setSyncResults({error:e.message});}
              setSyncing(false);
            }}>Synchroniser les prix</button>:
            <div style={{display:'flex',alignItems:'center',gap:8}}><div className="spinner" style={{width:16,height:16}}/><span style={{fontSize:12,color:'var(--gris-500)'}}>{syncProgress}</span></div>}
          </div>
          {syncResults&&<div className="card-b">
            {syncResults.error?<div className="alert-i a-warn"><I.Warn/><div><div className="at">{syncResults.error}</div></div></div>:
            <div>
              <div style={{display:'flex',gap:16,marginBottom:10,fontSize:13}}>
                <span style={{color:'var(--vert)',fontWeight:600}}>+{syncResults.added.length} nouveaux</span>
                <span style={{color:'var(--bleu)',fontWeight:600}}>{syncResults.updated.length} mis à jour</span>
                <span style={{color:'var(--gris-400)'}}>{syncResults.skipped.length} inchangés</span>
              </div>
              {syncResults.added.length>0&&<div style={{marginBottom:8}}>
                <div style={{fontSize:11,fontWeight:600,marginBottom:4,color:'var(--vert)'}}>Produits ajoutés:</div>
                {syncResults.added.slice(0,10).map((a,i)=><div key={i} style={{fontSize:11,padding:'2px 0',borderBottom:'1px solid var(--gris-100)'}}><span className="badge b-ok" style={{fontSize:8,marginRight:6}}>NOUVEAU</span>{a.label} — <strong>{a.prix.toFixed(2)}€</strong> <span style={{color:'var(--gris-400)'}}>({a.cat} via {a.supplier})</span></div>)}
                {syncResults.added.length>10&&<div style={{fontSize:10,color:'var(--gris-400)',marginTop:4}}>... et {syncResults.added.length-10} autres</div>}
              </div>}
              {syncResults.updated.length>0&&<div>
                <div style={{fontSize:11,fontWeight:600,marginBottom:4,color:'var(--bleu)'}}>Prix mis à jour:</div>
                {syncResults.updated.slice(0,10).map((u,i)=><div key={i} style={{fontSize:11,padding:'2px 0',borderBottom:'1px solid var(--gris-100)'}}><span className="badge b-info" style={{fontSize:8,marginRight:6}}>MÀJ</span>{u.label} → {u.matched}: <span style={{textDecoration:'line-through',color:'var(--gris-400)'}}>{u.oldPrix.toFixed(2)}€</span> → <strong>{u.newPrix.toFixed(2)}€</strong> <span style={{color:u.pctChange>10?'var(--rouge)':'var(--gris-400)'}}>({u.pctChange>0?'+':''}{u.pctChange}%)</span></div>)}
                {syncResults.updated.length>10&&<div style={{fontSize:10,color:'var(--gris-400)',marginTop:4}}>... et {syncResults.updated.length-10} autres</div>}
              </div>}
            </div>}
          </div>}
        </div>

        {/* Visual bars Food vs Bar */}
        <div className="cg">
          <div className="card">
            <div className="card-h"><div><div className="card-t">Décomposition Food Cost</div><div className="card-st">Coût des matières / CA Food</div></div><span className="badge" style={{background:foodPct!==null&&foodPct<=28?'var(--vert-light)':'var(--rouge-light)',color:foodPct!==null&&foodPct<=28?'var(--vert)':'var(--rouge)'}}>{foodPct!==null?foodPct+'%':'N/A'}</span></div>
            <div className="card-b">
              <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                <div style={{width:80,fontSize:12,fontWeight:500}}>Coût</div>
                <div style={{flex:1,height:24,background:'var(--gris-100)',borderRadius:6,overflow:'hidden'}}>
                  <div style={{height:'100%',width:`${cogs.foodCA>0?Math.min(cogs.foodCOGS/cogs.foodCA*100,100):0}%`,background:'#059669',borderRadius:6,transition:'width .5s'}}/>
                </div>
                <div style={{width:80,textAlign:'right',fontSize:12,fontWeight:600}}>{eur(cogs.foodCOGS)}</div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:12}}>
                <div style={{width:80,fontSize:12,fontWeight:500}}>CA</div>
                <div style={{flex:1,height:24,background:'var(--gris-100)',borderRadius:6,overflow:'hidden'}}>
                  <div style={{height:'100%',width:'100%',background:'var(--vert)',opacity:0.3,borderRadius:6}}/>
                </div>
                <div style={{width:80,textAlign:'right',fontSize:12,fontWeight:600}}>{eur(cogs.foodCA)}</div>
              </div>
            </div>
          </div>
          <div className="card">
            <div className="card-h"><div><div className="card-t">Décomposition Bar Cost</div><div className="card-st">Coût des matières / CA Bar</div></div><span className="badge" style={{background:barPct!==null&&barPct<=20?'var(--vert-light)':'var(--rouge-light)',color:barPct!==null&&barPct<=20?'var(--vert)':'var(--rouge)'}}>{barPct!==null?barPct+'%':'N/A'}</span></div>
            <div className="card-b">
              <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                <div style={{width:80,fontSize:12,fontWeight:500}}>Coût</div>
                <div style={{flex:1,height:24,background:'var(--gris-100)',borderRadius:6,overflow:'hidden'}}>
                  <div style={{height:'100%',width:`${cogs.barCA>0?Math.min(cogs.barCOGS/cogs.barCA*100,100):0}%`,background:'var(--bordeaux)',borderRadius:6,transition:'width .5s'}}/>
                </div>
                <div style={{width:80,textAlign:'right',fontSize:12,fontWeight:600}}>{eur(cogs.barCOGS)}</div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:12}}>
                <div style={{width:80,fontSize:12,fontWeight:500}}>CA</div>
                <div style={{flex:1,height:24,background:'var(--gris-100)',borderRadius:6,overflow:'hidden'}}>
                  <div style={{height:'100%',width:'100%',background:'var(--bordeaux)',opacity:0.3,borderRadius:6}}/>
                </div>
                <div style={{width:80,textAlign:'right',fontSize:12,fontWeight:600}}>{eur(cogs.barCA)}</div>
              </div>
            </div>
          </div>
        </div>

        {/* Detail table: products with worst margins */}
        <div className="card" style={{marginTop:14}}>
          <div className="card-h"><div><div className="card-t">Détail par produit — Marge sur coût matière</div><div className="card-st">Croisement ventes Trivec × prix d'achat inventaire</div></div><span className="badge b-ima">{cogs.matched} produits matchés</span></div>
          <div className="card-b"><div className="tbl"><table>
            <thead><tr>
              <th style={{textAlign:'left',minWidth:180}}>Produit</th>
              <th style={{textAlign:'left'}}>Type</th>
              <th style={{textAlign:'center'}}>Format</th>
              <th style={{textAlign:'right'}}>Qté</th>
              <th style={{textAlign:'right'}}>CA</th>
              <th style={{textAlign:'right'}}>Prix achat btl</th>
              <th style={{textAlign:'right'}}>Coût/unité</th>
              <th style={{textAlign:'right'}}>COGS total</th>
              <th style={{textAlign:'center'}}>Marge %</th>
            </tr></thead>
            <tbody>
              {cogs.details.filter(d=>d.matched).sort((a,b)=>{
                const ma=a.ca>0?(1-a.cost/a.ca):1;
                const mb=b.ca>0?(1-b.cost/b.ca):1;
                return ma-mb;
              }).slice(0,150).map((d,i)=>{
                const marge=d.ca>0?Math.round((1-d.cost/d.ca)*100):0;
                const fmtColors={btl:'var(--vert)',mag:'var(--bleu)',verre:'var(--orange)',shot:'var(--orange)',coupe:'var(--orange)',unit:'var(--gris-500)'};
                const fmtLabels={btl:'Btl',mag:'Mag',verre:'1/17',shot:'1/17',coupe:'1/17',unit:'—'};
                return<tr key={i}>
                  <td style={{textAlign:'left',fontWeight:500,fontSize:12}}>{d.nom}</td>
                  <td style={{textAlign:'left'}}><span className={`badge ${d.type==='food'?'b-ok':'b-ima'}`} style={{fontSize:9}}>{d.type==='food'?'Food':'Bar'}</span></td>
                  <td style={{textAlign:'center'}}><span className="badge" style={{fontSize:8,background:fmtColors[d.format]||'var(--gris-100)',color:'white'}}>{fmtLabels[d.format]||d.format}</span></td>
                  <td style={{textAlign:'right'}}>{d.qty}</td>
                  <td style={{textAlign:'right',fontWeight:500}}>{Math.round(d.ca).toLocaleString('fr-FR')}€</td>
                  <td style={{textAlign:'right',color:'var(--gris-500)',fontSize:11}}>{d.prixAchat?.toLocaleString('fr-FR',{minimumFractionDigits:2})}€</td>
                  <td style={{textAlign:'right',color:'var(--bordeaux)',fontWeight:600}}>{d.costPerUnit?.toFixed(2)}€</td>
                  <td style={{textAlign:'right',fontWeight:600}}>{Math.round(d.cost).toLocaleString('fr-FR')}€</td>
                  <td style={{textAlign:'center'}}><span className={`badge ${marge>70?'b-ok':marge>50?'b-info':marge>30?'b-warn':'b-err'}`} style={{fontSize:10}}>{marge}%</span></td>
                </tr>;
              })}
            </tbody>
          </table></div>
          {cogs.unmatched>0&&<div style={{padding:10,fontSize:11,color:'var(--gris-400)',borderTop:'1px solid var(--gris-100)'}}>⚠ {cogs.unmatched} produit(s) Trivec sans correspondance dans le référentiel prix d'achat — non inclus dans le calcul COGS</div>}
          </div>
        </div>
      </div>;
    })()}

    {/* ===== TAB: ALL INVOICES ===== */}
    {tab==='fournisseurs'&&<div>
      <div style={{display:'flex',gap:6,marginBottom:14,flexWrap:'wrap'}}>
        <button className={`btn btn-sm ${filterCat==='Tous'?'btn-primary':'btn-secondary'}`} onClick={()=>setFilterCat('Tous')}>Tous ({allInvoices.length})</button>
        {ALL_CATEGORIES.filter(c=>(categorized[c]||[]).length>0).map(c=>(
          <button key={c} className={`btn btn-sm ${filterCat===c?'btn-primary':'btn-secondary'}`} onClick={()=>setFilterCat(c)}
            style={{borderLeft:`3px solid ${CAT_COLORS[c]||'var(--gris-400)'}`}}>{c} ({(categorized[c]||[]).length})</button>
        ))}
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">{filterCat==='Tous'?'Toutes les factures':filterCat}</div><div className="card-st">Données Pennylane</div></div><span className="badge b-ima">Live</span></div>
        <div className="card-b"><div className="tbl"><table>
          <thead><tr><th>Fournisseur</th><th>Catégorie</th><th>N°</th><th>Date</th><th style={{textAlign:'right'}}>HT</th><th style={{textAlign:'right'}}>TTC</th><th>Statut</th></tr></thead>
          <tbody>{(filterCat==='Tous'?allInvoices:(categorized[filterCat]||[])).sort((a,b)=>new Date(b.date)-new Date(a.date)).map((inv,i)=>{
            const sid=String(inv.supplier?.id||'');
            const cat=SupplierMap.getCategory(sid);
            return(<tr key={inv.id||i}>
              <td style={{fontWeight:500}}>{SupplierMap.extractName(inv)}</td>
              <td><span style={{display:'inline-block',padding:'2px 8px',borderRadius:4,fontSize:10,fontWeight:500,background:CAT_COLORS[cat]||'var(--gris-400)',color:'white'}}>{cat}</span></td>
              <td style={{fontSize:11}}>{inv.invoice_number||'—'}</td>
              <td style={{fontSize:12}}>{inv.date||'—'}</td>
              <td style={{textAlign:'right',fontSize:12}}>{eur(parseFloat(inv.currency_amount_before_tax||0))}</td>
              <td style={{textAlign:'right',fontWeight:600}}>{eur(parseFloat(inv.amount||0))}</td>
              <td><span className={`badge ${inv.payment_status==='paid'?'b-ok':'b-warn'}`}>{inv.payment_status==='paid'?'Payée':'À traiter'}</span></td>
            </tr>);})}</tbody>
        </table></div></div>
      </div>
    </div>}

    {/* ===== TAB: MAPPING ===== */}
    {tab==='mapping'&&<div>
      {supplierGroups.filter(s=>s.cat==='Non classé').length>0&&<div className="alert-i a-err" style={{marginBottom:14}}><I.Warn/><div><div className="at">{supplierGroups.filter(s=>s.cat==='Non classé').length} fournisseur(s) non classé(s)</div><div className="as">Cliquez sur "Modifier" pour assigner une catégorie. Les fournisseurs non classés apparaissent en haut.</div></div></div>}

      {/* Group by cost group */}
      {Object.entries(COST_GROUPS).map(([groupName,groupInfo])=>{
        const groupSuppliers=supplierGroups.filter(s=>groupInfo.cats.includes(s.cat));
        if(groupSuppliers.length===0&&groupName!=='Hors Exploitation')return null;
        const suppliersToShow=groupName==='Hors Exploitation'?
          supplierGroups.filter(s=>groupInfo.cats.includes(s.cat)):groupSuppliers;
        if(suppliersToShow.length===0)return null;
        return(<div className="card" key={groupName} style={{marginBottom:14}}>
          <div className="card-h"><div>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <div style={{width:4,height:20,borderRadius:2,background:groupInfo.color}}/>
              <div className="card-t">{groupName}</div>
            </div>
            <div className="card-st">{suppliersToShow.length} fournisseur(s)</div>
          </div></div>
          <div className="card-b"><div className="tbl"><table>
            <thead><tr><th style={{textAlign:'left'}}>Fournisseur</th><th>Catégorie</th><th style={{textAlign:'right'}}>Total TTC</th><th style={{textAlign:'center'}}>Factures</th><th style={{width:200}}>Action</th></tr></thead>
            <tbody>{suppliersToShow.sort((a,b)=>a.cat==='Non classé'?-1:b.cat==='Non classé'?1:Math.abs(b.total)-Math.abs(a.total)).map(s=>(
              <tr key={s.id} style={{background:s.cat==='Non classé'?'rgba(220,38,38,.04)':'transparent'}}>
                <td style={{fontWeight:500}}>{s.name}</td>
                <td><span style={{display:'inline-block',padding:'2px 8px',borderRadius:4,fontSize:10,fontWeight:600,background:CAT_COLORS[s.cat]||'var(--gris-400)',color:'white'}}>{s.cat}</span></td>
                <td style={{textAlign:'right',fontWeight:600}}>{eur(s.total)}</td>
                <td style={{textAlign:'center'}}>{s.count}</td>
                <td>
                  {editingSupplier===s.id?
                    <div style={{display:'flex',gap:3,flexWrap:'wrap'}}>
                      {ALL_CATEGORIES.map(cat=>(
                        <button key={cat} onClick={()=>handleCategoryChange(s.id,cat)}
                          style={{fontSize:9,padding:'3px 6px',borderRadius:4,border:'1px solid var(--gris-200)',background:s.cat===cat?CAT_COLORS[cat]||'var(--bordeaux)':'white',
                            color:s.cat===cat?'white':'var(--gris-700)',cursor:'pointer',fontFamily:'inherit',fontWeight:s.cat===cat?600:400}}>
                          {cat}
                        </button>
                      ))}
                    </div>
                    :<button className="btn btn-sm btn-secondary" onClick={()=>setEditingSupplier(s.id)}>Modifier</button>
                  }
                </td>
              </tr>))}</tbody>
          </table></div></div>
        </div>);
      })}
    </div>}
    </div>}

    {!loading&&!loaded&&<div className="alert-i a-warn"><I.Warn/><div><div className="at">Connexion Pennylane requise</div><div className="as">Configurez votre token API dans Administration → Configuration Pennylane</div></div></div>}
  </div>);
}

// ===== STAFF =====
function StaffPage(){
  const[tab,setTab]=useState('equipe');
  const[showModal,setShowModal]=useState(false);
  const[editingId,setEditingId]=useState(null);
  const emptyEmp={nom:'',poste:'Serveur',section:'salle',tipCategory:'FLOOR',points:4,contrat:'CDI',tel:'',dateEntree:new Date().toLocaleDateString('fr-FR'),tips:true,coutBrut:0,heures:0,extras:0};
  const[newEmp,setNewEmp]=useState(emptyEmp);
  const[ver,setVer]=useState(0);
  const team=StaffRegistry.getActive();
  const tipsTeam=StaffRegistry.getTipsEligible();

  const handleAddOrSave=()=>{
    if(!newEmp.nom)return;
    if(editingId){
      StaffRegistry.update(editingId,newEmp);
      setEditingId(null);
    }else{
      StaffRegistry.add(newEmp);
    }
    setNewEmp({...emptyEmp});
    setVer(v=>v+1);
    setTab('equipe');
  };

  const handleEditEmployee=(emp)=>{
    setEditingId(emp.id);
    setNewEmp({nom:emp.nom,poste:emp.poste,section:emp.section||'salle',tipCategory:emp.tipCategory||'FLOOR',points:emp.points||3,contrat:emp.contrat||'CDI',tel:emp.tel||'',dateEntree:emp.dateEntree||'',tips:emp.tips!==false,coutBrut:emp.coutBrut||0,heures:emp.heures||0,extras:emp.extras||0});
    setTab('ajouter');
  };

  const handleCancelEdit=()=>{
    setEditingId(null);
    setNewEmp({...emptyEmp});
  };

  const handleDeactivate=(id)=>{
    if(confirm('Marquer comme inactif ?'))StaffRegistry.deactivate(id);
    setVer(v=>v+1);
  };

  const totalMasseS=team.reduce((s,e)=>s+(e.coutBrut||0),0);
  const totalHeures=team.reduce((s,e)=>s+(e.heures||0),0);
  const totalExtras=team.reduce((s,e)=>s+(e.extras||0),0);
  const salleCount=team.filter(e=>e.section==='salle').length;
  const cuisineCount=team.filter(e=>e.section==='cuisine').length;

  const sectionColors={salle:'var(--bordeaux)',cuisine:'var(--vert)'};

  return(<div className="fin">
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">Effectif total</div><div className="kpi-val">{team.length}</div><div className="kpi-chg neu">dont {team.filter(e=>e.contrat==='CDD').length} CDD</div></div>
      <div className="kpi"><div className="kpi-label">Salle / Cuisine</div><div className="kpi-val">{salleCount} / {cuisineCount}</div><div className="kpi-chg neu">répartition</div></div>
      <div className="kpi"><div className="kpi-label">Masse salariale</div><div className="kpi-val">{eur(totalMasseS)}</div><div className="kpi-chg neu">total brut</div></div>
      <div className="kpi"><div className="kpi-label">Bénéf. Tips</div><div className="kpi-val">{tipsTeam.length}</div><div className="kpi-chg pos">éligibles</div></div>
    </div>

    <div className="tabs">
      <div className={`tab ${tab==='equipe'?'active':''}`} onClick={()=>setTab('equipe')}>Équipe</div>
      <div className={`tab ${tab==='ajouter'?'active':''}`} onClick={()=>setTab('ajouter')}>Ajouter / Modifier</div>
      <div className={`tab ${tab==='repartition'?'active':''}`} onClick={()=>setTab('repartition')}>Répartition</div>
    </div>

    {tab==='equipe'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Équipe — Février 2026</div><div className="card-st">{team.length} collaborateurs actifs</div></div></div>
        <div className="card-b"><div className="tbl"><table>
          <thead><tr><th>Nom</th><th>Poste</th><th>Section</th><th>Catégorie Tips</th><th>Points</th><th>Contrat</th><th>Entrée</th><th style={{textAlign:'right'}}>Heures</th><th style={{textAlign:'right'}}>Extras</th><th style={{textAlign:'right'}}>Coût brut</th><th>Tips</th><th>Actions</th></tr></thead>
          <tbody>{team.map(e=><tr key={e.id}>
            <td style={{fontWeight:500}}>{e.nom}</td>
            <td><span className="badge b-ima">{e.poste}</span></td>
            <td><span className="badge" style={{background:sectionColors[e.section],color:'white',fontSize:10}}>{e.section==='salle'?'Salle':'Cuisine'}</span></td>
            <td><span className="badge" style={{background:TIP_CATEGORIES[e.section]?.[e.tipCategory]?.color||'var(--gris-300)',color:'white',fontSize:9}}>{TIP_CATEGORIES[e.section]?.[e.tipCategory]?.label||e.tipCategory}</span></td>
            <td style={{fontWeight:600}}>{e.points}</td>
            <td><span className={`badge ${e.contrat==='CDI'?'b-ok':'b-info'}`}>{e.contrat}</span></td>
            <td style={{fontSize:12}}>{e.dateEntree}</td>
            <td style={{textAlign:'right'}}>{e.heures}h</td>
            <td style={{textAlign:'right',color:e.extras>0?'var(--orange)':'var(--gris-400)'}}>{e.extras>0?e.extras+'h':'—'}</td>
            <td style={{textAlign:'right',fontWeight:600}}>{e.coutBrut>0?eur(e.coutBrut):'—'}</td>
            <td>{e.tips?<span className="badge b-ok" style={{fontSize:10}}>Oui</span>:<span className="badge" style={{background:'var(--gris-100)',color:'var(--gris-400)',fontSize:10}}>Non</span>}</td>
            <td style={{whiteSpace:'nowrap'}}><button className="btn btn-sm" style={{background:'var(--bleu-light)',color:'var(--bleu)',border:'none',padding:'4px 8px',fontSize:10,cursor:'pointer',marginRight:4}} onClick={()=>handleEditEmployee(e)}>Modifier</button><button className="btn btn-sm" style={{background:'var(--rouge-light)',color:'var(--rouge)',border:'none',padding:'4px 8px',fontSize:10,cursor:'pointer'}} onClick={()=>handleDeactivate(e.id)}>Désactiver</button></td>
          </tr>)}</tbody>
        </table></div></div>
      </div>
    </div>}

    {tab==='ajouter'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">{editingId?`Modifier — ${newEmp.nom}`:'Ajouter un employé'}</div>{editingId&&<div className="card-st">Modifiez les champs puis cliquez Sauvegarder</div>}</div>{editingId&&<span className="badge b-warn">Mode édition</span>}</div>
        <div className="card-b">
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">Nom complet</label>
              <input className="fi" value={newEmp.nom} onChange={e=>setNewEmp(p=>({...p,nom:e.target.value}))} placeholder="Prénom Nom"/>
            </div>
            <div className="fg">
              <label className="fl">Poste</label>
              <input className="fi" value={newEmp.poste} onChange={e=>setNewEmp(p=>({...p,poste:e.target.value}))} placeholder="ex: Serveur"/>
            </div>
          </div>

          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">Section</label>
              <select className="fi-select" value={newEmp.section} onChange={e=>{const s=e.target.value;const tc=Object.keys(TIP_CATEGORIES[s]||{})[0]||'FLOOR';setNewEmp(p=>({...p,section:s,tipCategory:tc}));}}>
                <option value="salle">Salle</option>
                <option value="cuisine">Cuisine</option>
              </select>
            </div>
            <div className="fg">
              <label className="fl">Catégorie Tips</label>
              <select className="fi-select" value={newEmp.tipCategory} onChange={e=>{const cat=e.target.value;const pts=TIP_CATEGORIES[newEmp.section]?.[cat]?.defaultPoints||3;setNewEmp(p=>({...p,tipCategory:cat,points:pts}));}}>
                {Object.entries(TIP_CATEGORIES[newEmp.section]||{}).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
              </select>
            </div>
            <div className="fg">
              <label className="fl">Points</label>
              <input type="number" className="fi" value={newEmp.points} onChange={e=>setNewEmp(p=>({...p,points:parseFloat(e.target.value)||0}))}/>
            </div>
            <div className="fg">
              <label className="fl">Contrat</label>
              <select className="fi-select" value={newEmp.contrat} onChange={e=>setNewEmp(p=>({...p,contrat:e.target.value}))}>
                <option value="CDI">CDI</option>
                <option value="CDD">CDD</option>
                <option value="Extra">Extra</option>
                <option value="Stage">Stage</option>
              </select>
            </div>
          </div>

          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">Téléphone</label>
              <input className="fi" value={newEmp.tel} onChange={e=>setNewEmp(p=>({...p,tel:e.target.value}))} placeholder="06 XX XX XX XX"/>
            </div>
            <div className="fg">
              <label className="fl">Date d'entrée</label>
              <input type="date" className="fi" value={newEmp.dateEntree} onChange={e=>setNewEmp(p=>({...p,dateEntree:e.target.value}))}/>
            </div>
            <div className="fg">
              <label className="fl">Coût brut mensuel (€)</label>
              <input type="number" className="fi" value={newEmp.coutBrut} onChange={e=>setNewEmp(p=>({...p,coutBrut:parseFloat(e.target.value)||0}))}/>
            </div>
          </div>

          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">Heures mensuelles</label>
              <input type="number" className="fi" value={newEmp.heures} onChange={e=>setNewEmp(p=>({...p,heures:parseFloat(e.target.value)||0}))}/>
            </div>
            <div className="fg">
              <label className="fl">Extras (h)</label>
              <input type="number" className="fi" value={newEmp.extras} onChange={e=>setNewEmp(p=>({...p,extras:parseFloat(e.target.value)||0}))}/>
            </div>
          </div>

          <div className="fg" style={{display:'flex',alignItems:'center',gap:10,marginBottom:20}}>
            <input type="checkbox" id="tips-check" checked={newEmp.tips} onChange={e=>setNewEmp(p=>({...p,tips:e.target.checked}))} style={{width:16,height:16,accentColor:'var(--bordeaux)'}}/>
            <label htmlFor="tips-check" style={{fontSize:13,fontWeight:500,cursor:'pointer'}}>Éligible aux tips</label>
          </div>

          <div style={{display:'flex',gap:10,justifyContent:'flex-end'}}>
            {editingId&&<button className="btn btn-secondary" onClick={handleCancelEdit}>Annuler</button>}
            {!editingId&&<button className="btn btn-secondary" onClick={()=>setNewEmp({...emptyEmp})}>Réinitialiser</button>}
            <button className="btn btn-primary" onClick={handleAddOrSave}>{editingId?'Sauvegarder les modifications':'Ajouter l\'employé'}</button>
          </div>
        </div>
      </div>
    </div>}

    {tab==='repartition'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Répartition par section</div></div></div>
        <div className="card-b">
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20,marginBottom:30}}>
            <div className="cost-c">
              <div className="cl" style={{color:'var(--bordeaux)'}}>Salle</div>
              <div className="cv">{salleCount}</div>
              <div className="ct">collaborateurs</div>
            </div>
            <div className="cost-c">
              <div className="cl" style={{color:'var(--vert)'}}>Cuisine</div>
              <div className="cv">{cuisineCount}</div>
              <div className="ct">collaborateurs</div>
            </div>
          </div>

          <div style={{marginTop:20}}>
            <div style={{fontSize:13,fontWeight:600,marginBottom:12,color:'var(--bordeaux)'}}>Répartition par catégorie Tips</div>
            {['salle','cuisine'].map(section=>(
              <div key={section} style={{marginBottom:20}}>
                <div style={{fontSize:11,color:'var(--gris-500)',textTransform:'uppercase',marginBottom:8}}>{section==='salle'?'Salle':'Cuisine'}</div>
                {Object.entries(TIP_CATEGORIES[section]||{}).map(([catKey,catData])=>{
                  const count=StaffRegistry.getBySectionAndCategory(section,catKey).length;
                  const totalPoints=StaffRegistry.getBySectionAndCategory(section,catKey).reduce((s,e)=>s+e.points,0);
                  return(<div key={catKey} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:10,background:'var(--gris-50)',borderRadius:6,marginBottom:8,fontSize:12}}>
                    <div style={{display:'flex',alignItems:'center',gap:10}}>
                      <div style={{width:12,height:12,borderRadius:3,background:catData.color}}/>
                      <span style={{fontWeight:500}}>{catData.label}</span>
                    </div>
                    <div style={{textAlign:'right'}}>
                      <div style={{fontWeight:600}}>{count} person{count>1?'s':''}</div>
                      <div style={{color:'var(--gris-500)',fontSize:10}}>Total: {totalPoints} pts</div>
                    </div>
                  </div>);
                })}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>}
  </div>);
}

// ===== STOCKS =====
function Stocks(){
  const[tab,setTab]=useState('ventes');
  const[filterCat,setFilterCat]=useState('Tous');
  const[showAddModal,setShowAddModal]=useState(false);
  const[newItem,setNewItem]=useState({nom:'',cat:'Viandes',unite:'kg',prixUnit:0,seuil:0});
  const[searchTerm,setSearchTerm]=useState('');
  const[achatCat,setAchatCat]=useState('Tous');
  const[achatSearch,setAchatSearch]=useState('');
  const[editingPrix,setEditingPrix]=useState(null); // {name, prix}
  const[priceVersion,setPriceVersion]=useState(0); // force re-render after price edit

  // Full inventory with counted qty, theoretical stock, Trivec sales
  const[inventory,setInventory]=useState(()=>{
    try{return JSON.parse(localStorage.getItem('ima_inventory_v1')||'[]');}catch(e){return[];}
  });

  // Save inventory to localStorage
  useEffect(()=>{
    localStorage.setItem('ima_inventory_v1',JSON.stringify(inventory));
  },[inventory]);

  // Aggregate all assortiment data from Trivec
  const trivecProducts=useMemo(()=>{
    const data=TrivecService._getData();
    const assorts=data.assortiments||{};
    const productMap={};
    for(const[dateStr,assort]of Object.entries(assorts)){
      (assort.products||[]).forEach(p=>{
        const key=p.nom;
        if(!productMap[key]){productMap[key]={nom:p.nom,categorie1:p.categorie1,categorie2:p.categorie2,categorie3:p.categorie3,totalQty:0,totalPrix:0,jours:[]};}
        productMap[key].totalQty+=p.quantite;
        productMap[key].totalPrix+=p.prix;
        productMap[key].jours.push({date:dateStr,qty:p.quantite,prix:p.prix});
      });
    }
    return Object.values(productMap).sort((a,b)=>b.totalPrix-a.totalPrix);
  },[]);

  // Map Trivec categories to stock categories
  const trivecCatToStockCat=(cat1)=>{
    if(!cat1)return'Épicerie fine';
    const c=cat1.toUpperCase();
    if(c.includes('VIN')||c.includes('CHAMPAGNE'))return'Vins';
    if(c.includes('ALCOOL')||c.includes('RHUM')||c.includes('TEQUILA')||c.includes('VODKA')||c.includes('GIN')||c.includes('WHISKY'))return'Spiritueux';
    if(c.includes('NOURRITURE')||c.includes('FOOD'))return'Épicerie fine';
    if(c.includes('BOISSON'))return'Épicerie fine';
    return'Épicerie fine';
  };

  const cats=['Tous','Viandes','Poissons','Épicerie fine','Vins','Spiritueux','Légumes','Boissons'];
  const filtered=filterCat==='Tous'?inventory:inventory.filter(i=>i.cat===filterCat);

  // Calculate theoretical stock: stockPrec + achats - ventesTrivec
  const calcTheorique=(item)=>Math.round((item.stockPrec+item.achats-item.ventesTrivec)*100)/100;
  // Ecart: compteInventaire - théorique
  const calcEcart=(item)=>Math.round((item.compteInventaire-calcTheorique(item))*100)/100;
  const calcEcartPct=(item)=>{const th=calcTheorique(item);return th!==0?Math.round((calcEcart(item)/th)*10000)/100:0;};
  const calcEcartValeur=(item)=>Math.round(calcEcart(item)*item.prixUnit*100)/100;

  const updateCompte=(id,val)=>{
    setInventory(prev=>prev.map(i=>i.id===id?{...i,compteInventaire:parseFloat(val)||0}:i));
  };

  const addItem=()=>{
    if(!newItem.nom)return;
    const id=inventory.length>0?Math.max(...inventory.map(i=>i.id))+1:1;
    setInventory(prev=>[...prev,{id,nom:newItem.nom,cat:newItem.cat,unite:newItem.unite,prixUnit:parseFloat(newItem.prixUnit)||0,seuil:parseFloat(newItem.seuil)||0,stockPrec:0,achats:0,ventesTrivec:0,compteInventaire:0}]);
    setNewItem({nom:'',cat:'Viandes',unite:'kg',prixUnit:0,seuil:0});
    setShowAddModal(false);
  };

  // Aggregated stats
  const totalEcartValeur=inventory.reduce((s,i)=>s+calcEcartValeur(i),0);
  const totalValeurStock=inventory.reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0);
  const itemsWithEcart=inventory.filter(i=>Math.abs(calcEcartPct(i))>5).length;
  const alertItems=inventory.filter(i=>i.compteInventaire<i.seuil);

  return(<div className="fin">
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">Valeur stock</div><div className="kpi-val">{eur(totalValeurStock)}</div><div className="kpi-chg neu">{inventory.length} références</div></div>
      <div className="kpi"><div className="kpi-label">Écart total</div><div className="kpi-val" style={{color:totalEcartValeur<0?'var(--rouge)':'var(--vert)'}}>{eur(totalEcartValeur)}</div><div className={`kpi-chg ${totalEcartValeur<0?'neg':'pos'}`}>{totalEcartValeur<0?'Coulage potentiel':'Excédent'}</div></div>
      <div className="kpi"><div className="kpi-label">Produits en écart (&gt;5%)</div><div className="kpi-val">{itemsWithEcart}</div><div className="kpi-chg neg">sur {inventory.length} réf.</div></div>
      <div className="kpi"><div className="kpi-label">Alertes stock bas</div><div className="kpi-val">{alertItems.length}</div><div className="kpi-chg neg">{alertItems.filter(i=>i.compteInventaire<i.seuil*0.5).length} critiques</div></div>
    </div>

    <div className="tabs">
      <div className={`tab ${tab==='ventes'?'active':''}`} onClick={()=>setTab('ventes')}>Ventes Trivec</div>
      <div className={`tab ${tab==='achats'?'active':''}`} onClick={()=>setTab('achats')}>Prix d'achat</div>
      <div className={`tab ${tab==='inventaire'?'active':''}`} onClick={()=>setTab('inventaire')}>Faire l'inventaire</div>
      <div className={`tab ${tab==='analyse'?'active':''}`} onClick={()=>setTab('analyse')}>Analyse écarts</div>
      <div className={`tab ${tab==='alertes'?'active':''}`} onClick={()=>setTab('alertes')}>Alertes stock</div>
      <div className={`tab ${tab==='valeur'?'active':''}`} onClick={()=>setTab('valeur')}>Valeur par catégorie</div>
    </div>

    {/* ===== TAB: VENTES TRIVEC ===== */}
    {tab==='ventes'&&<div>
      {trivecProducts.length===0?<div className="card">
        <div className="card-b" style={{padding:50,textAlign:'center',color:'var(--gris-400)'}}>
          <div style={{fontSize:32,marginBottom:10}}>📦</div>
          <div style={{fontWeight:500,marginBottom:4}}>Aucun produit importé depuis Trivec</div>
          <div style={{fontSize:11}}>Importez un "Rapport Assortiments de Produits" dans Administration → Import Trivec</div>
        </div>
      </div>:<div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
          <div style={{fontSize:13,color:'var(--gris-500)'}}>{trivecProducts.length} produits détectés depuis les imports Trivec</div>
          <div style={{display:'flex',gap:8,alignItems:'center'}}>
            <input className="fi" type="text" placeholder="Rechercher un produit..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} style={{width:220,fontSize:12,padding:'6px 10px'}}/>
          </div>
        </div>

        {/* Résumé par catégorie Trivec */}
        <div className="card" style={{marginBottom:16}}>
          <div className="card-h"><div><div className="card-t">Ventes par catégorie</div><div className="card-st">Cumul des imports Assortiments Trivec</div></div><span className="badge b-ok">{Object.keys(TrivecService._getData().assortiments||{}).length} jour(s)</span></div>
          <div className="card-b">
            {(()=>{
              const byCat={};
              trivecProducts.forEach(p=>{
                const cat=p.categorie1||'Autre';
                if(!byCat[cat])byCat[cat]={qty:0,total:0,count:0};
                byCat[cat].qty+=p.totalQty;
                byCat[cat].total+=p.totalPrix;
                byCat[cat].count++;
              });
              const sorted=Object.entries(byCat).sort((a,b)=>b[1].total-a[1].total);
              const maxVal=sorted.length>0?sorted[0][1].total:1;
              return<div style={{display:'grid',gap:8}}>
                {sorted.map(([cat,data])=>(
                  <div key={cat} style={{display:'flex',alignItems:'center',gap:12,fontSize:12}}>
                    <div style={{width:180,fontWeight:500,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{cat}</div>
                    <div style={{flex:1,height:20,background:'var(--gris-100)',borderRadius:4,overflow:'hidden'}}>
                      <div style={{height:'100%',width:`${(data.total/maxVal)*100}%`,background:'var(--bordeaux)',borderRadius:4,transition:'width .3s'}}/>
                    </div>
                    <div style={{width:80,textAlign:'right',fontWeight:600}}>{data.total.toLocaleString('fr-FR')}€</div>
                    <div style={{width:60,textAlign:'right',color:'var(--gris-500)'}}>{data.qty} unités</div>
                    <div style={{width:50,textAlign:'right',color:'var(--gris-400)',fontSize:10}}>{data.count} réf.</div>
                  </div>
                ))}
              </div>;
            })()}
          </div>
        </div>

        {/* Tableau détaillé des produits */}
        <div className="card">
          <div className="card-h"><div><div className="card-t">Détail produits vendus</div><div className="card-st">Cliquez sur "+ Suivre" pour ajouter un produit à l'inventaire</div></div></div>
          <div className="card-b"><div className="tbl"><table>
            <thead><tr>
              <th style={{textAlign:'left',minWidth:200}}>Produit</th>
              <th style={{textAlign:'left'}}>Catégorie</th>
              <th style={{textAlign:'left'}}>Sous-catégorie</th>
              <th style={{textAlign:'right'}}>Qté vendue</th>
              <th style={{textAlign:'right'}}>CA</th>
              <th style={{textAlign:'right'}}>Prix moyen</th>
              <th style={{textAlign:'center'}}>Jours</th>
              <th style={{textAlign:'center'}}>Suivi stock</th>
            </tr></thead>
            <tbody>
              {trivecProducts.filter(p=>!searchTerm||p.nom.toLowerCase().includes(searchTerm.toLowerCase())||p.categorie1?.toLowerCase().includes(searchTerm.toLowerCase())||p.categorie2?.toLowerCase().includes(searchTerm.toLowerCase())).map((p,i)=>{
                const inInventory=inventory.some(inv=>inv.nom===p.nom);
                const prixMoyen=p.totalQty>0?(p.totalPrix/p.totalQty):0;
                return<tr key={i}>
                  <td style={{textAlign:'left',fontWeight:500}}>{p.nom}</td>
                  <td style={{textAlign:'left'}}><span className="badge b-ima" style={{fontSize:9}}>{p.categorie1||'—'}</span></td>
                  <td style={{textAlign:'left',fontSize:11,color:'var(--gris-500)'}}>{p.categorie2||'—'}{p.categorie3?' / '+p.categorie3:''}</td>
                  <td style={{textAlign:'right',fontWeight:600}}>{p.totalQty}</td>
                  <td style={{textAlign:'right',fontWeight:600}}>{p.totalPrix.toLocaleString('fr-FR')}€</td>
                  <td style={{textAlign:'right',color:'var(--gris-500)'}}>{Math.round(prixMoyen)}€</td>
                  <td style={{textAlign:'center'}}><span className="badge" style={{background:'var(--gris-100)',fontSize:9}}>{p.jours.length}j</span></td>
                  <td style={{textAlign:'center'}}>
                    {inInventory?<span className="badge b-ok" style={{fontSize:9}}>Suivi</span>:
                    <button className="btn btn-sm btn-primary" style={{fontSize:9,padding:'2px 8px'}} onClick={()=>{
                      const cat=trivecCatToStockCat(p.categorie1);
                      const newId=inventory.length>0?Math.max(...inventory.map(x=>x.id))+1:1;
                      setInventory(prev=>[...prev,{id:newId,nom:p.nom,cat:cat,unite:'bt',prixUnit:Math.round(prixMoyen*100)/100,seuil:0,stockPrec:0,achats:0,ventesTrivec:p.totalQty,compteInventaire:0}]);
                    }}>+ Suivre</button>}
                  </td>
                </tr>;
              })}
            </tbody>
          </table></div></div>
        </div>
      </div>}
    </div>}

    {/* ===== TAB: PRIX D'ACHAT ===== */}
    {tab==='achats'&&(()=>{
      const stats=InventoryService.getStats();
      const allCats=['Tous','Food','Vin Blanc','Vin rosé','Vin rouge','Spiritueux'];
      const allProducts=achatCat==='Tous'?InventoryService.getAll():InventoryService.getByCategory(achatCat);
      const filteredProducts=achatSearch?allProducts.filter(p=>p.n.toLowerCase().includes(achatSearch.toLowerCase())||p.s.toLowerCase().includes(achatSearch.toLowerCase())):allProducts;
      const subCats=achatCat!=='Tous'?InventoryService.getSubCategories(achatCat):[];
      return<div>
        <div className="kpi-g">
          <div className="kpi"><div className="kpi-label">Produits référencés</div><div className="kpi-val">{stats.totalProducts}</div><div className="kpi-chg neu">Base prix d'achat</div></div>
          <div className="kpi"><div className="kpi-label">Food</div><div className="kpi-val">{stats.byCategory['Food']||0}</div><div className="kpi-chg neu">Légumes, Épices, Économat...</div></div>
          <div className="kpi"><div className="kpi-label">Vins</div><div className="kpi-val">{(stats.byCategory['Vin Blanc']||0)+(stats.byCategory['Vin rouge']||0)+(stats.byCategory['Vin rosé']||0)}</div><div className="kpi-chg neu">Blanc, Rouge, Rosé</div></div>
          <div className="kpi"><div className="kpi-label">Spiritueux</div><div className="kpi-val">{stats.byCategory['Spiritueux']||0}</div><div className="kpi-chg neu">Champagne, Gin, Tequila...</div></div>
        </div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
          <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
            {allCats.map(c=><button key={c} className={`btn btn-sm ${achatCat===c?'btn-primary':'btn-secondary'}`} onClick={()=>setAchatCat(c)}>{c}</button>)}
          </div>
          <input className="fi" type="text" placeholder="Rechercher..." value={achatSearch} onChange={e=>setAchatSearch(e.target.value)} style={{width:220,fontSize:12,padding:'6px 10px'}}/>
        </div>
        {subCats.length>0&&<div style={{display:'flex',gap:6,marginBottom:14,flexWrap:'wrap'}}>
          {subCats.slice(0,15).map(sc=><span key={sc} className="badge" style={{background:'var(--bordeaux-10)',color:'var(--bordeaux)',fontSize:10,cursor:'pointer'}} onClick={()=>setAchatSearch(sc)}>{sc}</span>)}
        </div>}
        <div className="card">
          <div className="card-h"><div><div className="card-t">Référentiel prix d'achat</div><div className="card-st">418 produits • Source: inventaires Janvier 2026 (Food, Vins, Spiritueux)</div></div></div>
          <div className="card-b"><div className="tbl"><table>
            <thead><tr>
              <th style={{textAlign:'left',minWidth:200}}>Produit</th>
              <th style={{textAlign:'left'}}>Catégorie</th>
              <th style={{textAlign:'left'}}>Sous-catégorie</th>
              <th style={{textAlign:'right'}}>Prix d'achat HT</th>
              <th style={{textAlign:'center'}}>Historique</th>
              <th style={{textAlign:'center'}}>Marge Trivec</th>
            </tr></thead>
            <tbody>
              {filteredProducts.slice(0,200).map((p,i)=>{
                const trivecMatch=trivecProducts.find(tp=>tp.nom.toLowerCase().includes(p.n.toLowerCase().split(' ')[0]));
                const prixVente=trivecMatch&&trivecMatch.totalQty>0?trivecMatch.totalPrix/trivecMatch.totalQty:null;
                const marge=prixVente?Math.round((1-p.x/prixVente)*100):null;
                const hist=InventoryService.getPriceHistory(p.n);
                const isEditing=editingPrix&&editingPrix.name===p.n;
                return<tr key={i+'-'+priceVersion}>
                  <td style={{textAlign:'left',fontWeight:500,fontSize:12}}>{p.n}</td>
                  <td style={{textAlign:'left'}}><span className="badge b-ima" style={{fontSize:9}}>{p.p}</span></td>
                  <td style={{textAlign:'left',fontSize:11,color:'var(--gris-500)'}}>{p.s}</td>
                  <td style={{textAlign:'right',fontWeight:600,color:'var(--bordeaux)'}}>
                    {isEditing?<form style={{display:'inline-flex',gap:4,alignItems:'center'}} onSubmit={e=>{e.preventDefault();const val=parseFloat(editingPrix.prix);if(val>0){InventoryService.updatePrixWithHistory(p.n,val,'manual');setPriceVersion(v=>v+1);}setEditingPrix(null);}}>
                      <input className="fi" type="number" step="0.01" value={editingPrix.prix} onChange={e=>setEditingPrix({...editingPrix,prix:e.target.value})} style={{width:80,fontSize:11,padding:'3px 6px',textAlign:'right'}} autoFocus/>
                      <button type="submit" className="btn btn-sm btn-primary" style={{fontSize:9,padding:'2px 6px'}}>OK</button>
                      <button type="button" className="btn btn-sm" style={{fontSize:9,padding:'2px 6px'}} onClick={()=>setEditingPrix(null)}>✕</button>
                    </form>:
                    <span style={{cursor:'pointer',borderBottom:'1px dashed var(--bordeaux)'}} onClick={()=>setEditingPrix({name:p.n,prix:p.x})} title="Cliquer pour modifier">{p.x.toLocaleString('fr-FR',{minimumFractionDigits:2})}€</span>}
                  </td>
                  <td style={{textAlign:'center'}}>{hist.length>0?<span className="badge" style={{background:'var(--bleu-light)',color:'var(--bleu)',fontSize:9,cursor:'pointer'}} title={hist.map(h=>h.date+': '+h.prix+'€ ('+h.source+')').join('\n')}>{hist.length} màj</span>:<span style={{color:'var(--gris-300)',fontSize:9}}>—</span>}</td>
                  <td style={{textAlign:'center'}}>{marge!==null?<span className={`badge ${marge>60?'b-ok':marge>30?'b-info':'b-warn'}`} style={{fontSize:10}}>{marge}%</span>:<span style={{color:'var(--gris-300)',fontSize:10}}>—</span>}</td>
                </tr>;
              })}
            </tbody>
          </table></div>
          {filteredProducts.length>200&&<div style={{padding:10,textAlign:'center',fontSize:11,color:'var(--gris-400)'}}>Affichage limité à 200 produits. Utilisez la recherche pour affiner.</div>}
          </div>
        </div>
      </div>;
    })()}

    {/* ===== TAB: INVENTAIRE ===== */}
    {tab==='inventaire'&&<div>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
        <div style={{display:'flex',gap:6}}>
          {cats.map(c=>(
            <button key={c} className={`btn btn-sm ${filterCat===c?'btn-primary':'btn-secondary'}`} onClick={()=>setFilterCat(c)}>{c}</button>
          ))}
        </div>
        <button className="btn btn-primary" onClick={()=>setShowAddModal(true)}>+ Ajouter un produit</button>
      </div>
      <div className="card">
        <div className="card-h">
          <div><div className="card-t">Inventaire — Saisie des quantités</div><div className="card-st">Renseignez les quantités comptées physiquement. L'écart avec le stock théorique (ventes Trivec) est calculé automatiquement.</div></div>
          <div style={{display:'flex',gap:8,alignItems:'center'}}>
            <span className="badge b-ima">Trivec sync</span>
            <span className="badge b-info">28/02/2026</span>
          </div>
        </div>
        <div className="card-b tips-grid"><table>
          <thead><tr>
            <th style={{textAlign:'left',minWidth:180}}>Produit</th>
            <th>Catégorie</th>
            <th>Unité</th>
            <th style={{textAlign:'right'}}>Prix unit.</th>
            <th style={{textAlign:'right',background:'var(--gris-100)'}}>Stock préc.</th>
            <th style={{textAlign:'right',background:'var(--vert-light)'}}>Achats</th>
            <th style={{textAlign:'right',background:'var(--bleu-light)'}}>Ventes Trivec</th>
            <th style={{textAlign:'right',background:'var(--orange-light)'}}>Théorique</th>
            <th style={{textAlign:'center',background:'var(--bordeaux-10)',minWidth:80}}>Compté</th>
            <th style={{textAlign:'right'}}>Écart</th>
            <th style={{textAlign:'right'}}>Écart (€)</th>
            <th>Statut</th>
          </tr></thead>
          <tbody>
            {filtered.map(item=>{
              const theo=calcTheorique(item);
              const ecart=calcEcart(item);
              const ecartPct=calcEcartPct(item);
              const ecartVal=calcEcartValeur(item);
              const isBad=Math.abs(ecartPct)>5;
              const isVeryBad=Math.abs(ecartPct)>15;
              return(<tr key={item.id} style={{background:isVeryBad?'rgba(220,38,38,.04)':isBad?'rgba(217,119,6,.03)':'transparent'}}>
                <td style={{textAlign:'left',fontWeight:500}}>{item.nom}</td>
                <td><span className="badge b-ima" style={{fontSize:9}}>{item.cat}</span></td>
                <td style={{textAlign:'center',fontSize:11,color:'var(--gris-500)'}}>{item.unite}</td>
                <td style={{textAlign:'right',fontSize:12}}>{item.prixUnit}€</td>
                <td style={{textAlign:'right',background:'var(--gris-50)'}}>{item.stockPrec}</td>
                <td style={{textAlign:'right',color:'var(--vert)',fontWeight:500}}>+{item.achats}</td>
                <td style={{textAlign:'right',color:'var(--bleu)',fontWeight:500}}>-{item.ventesTrivec}</td>
                <td style={{textAlign:'right',fontWeight:600}}>{theo}</td>
                <td style={{textAlign:'center',background:'rgba(88,21,39,.03)'}}>
                  <input type="number" step="0.1" value={item.compteInventaire} onChange={e=>updateCompte(item.id,e.target.value)}
                    style={{width:65,padding:'5px 6px',border:`2px solid ${isBad?'var(--rouge)':'var(--gris-200)'}`,borderRadius:6,fontSize:13,textAlign:'center',fontWeight:700,fontFamily:'inherit',outline:'none',background:isBad?'var(--rouge-light)':'white'}}/>
                </td>
                <td style={{textAlign:'right',fontWeight:700,color:ecart<0?'var(--rouge)':ecart>0?'var(--vert)':'var(--gris-400)'}}>
                  {ecart>0?'+':''}{ecart} {item.unite}
                  <div style={{fontSize:9,fontWeight:500}}>({ecartPct>0?'+':''}{ecartPct}%)</div>
                </td>
                <td style={{textAlign:'right',fontWeight:600,color:ecartVal<0?'var(--rouge)':ecartVal>0?'var(--vert)':'var(--gris-400)'}}>
                  {ecartVal>0?'+':''}{eur(ecartVal)}
                </td>
                <td>
                  {isVeryBad?<span className="badge b-err">Écart critique</span>:
                   isBad?<span className="badge b-warn">À vérifier</span>:
                   <span className="badge b-ok">OK</span>}
                </td>
              </tr>);
            })}
          </tbody>
          <tfoot>
            <tr style={{fontWeight:700,background:'var(--gris-50)',borderTop:'2px solid var(--gris-300)'}}>
              <td style={{textAlign:'left'}}>TOTAL ({filtered.length} réf.)</td>
              <td/><td/><td/>
              <td style={{textAlign:'right'}}>{eur(filtered.reduce((s,i)=>s+(i.stockPrec*i.prixUnit),0))}</td>
              <td style={{textAlign:'right',color:'var(--vert)'}}>{eur(filtered.reduce((s,i)=>s+(i.achats*i.prixUnit),0))}</td>
              <td style={{textAlign:'right',color:'var(--bleu)'}}>{eur(filtered.reduce((s,i)=>s+(i.ventesTrivec*i.prixUnit),0))}</td>
              <td style={{textAlign:'right'}}>{eur(filtered.reduce((s,i)=>s+(calcTheorique(i)*i.prixUnit),0))}</td>
              <td style={{textAlign:'center'}}>{eur(filtered.reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0))}</td>
              <td colSpan="2" style={{textAlign:'right',color:totalEcartValeur<0?'var(--rouge)':'var(--vert)',fontSize:15}}>
                {totalEcartValeur>0?'+':''}{eur(totalEcartValeur)}
              </td>
              <td/>
            </tr>
          </tfoot>
        </table></div>
        <div style={{marginTop:14,padding:'10px 14px',background:'var(--gris-50)',borderRadius:8,fontSize:12,color:'var(--gris-600)'}}>
          <strong>Formule :</strong> Stock théorique = Stock précédent + Achats (Pennylane) − Ventes (Trivec) · <strong>Écart</strong> = Compté − Théorique · Un écart négatif indique un <strong style={{color:'var(--rouge)'}}>coulage potentiel</strong> (vol, casse, perte non déclarée)
        </div>
      </div>
    </div>}

    {/* ===== TAB: ANALYSE ÉCARTS ===== */}
    {tab==='analyse'&&<div>
      <div className="card" style={{marginBottom:16}}>
        <div className="card-h"><div><div className="card-t">Analyse des écarts — Inventaire vs Ventes Trivec</div><div className="card-st">Produits avec un écart supérieur à 5% entre le stock compté et le stock théorique</div></div><span className="badge b-ima">Trivec × Pennylane</span></div>
        <div className="card-b">
          {(()=>{
            const problemItems=inventory.filter(i=>Math.abs(calcEcartPct(i))>5).sort((a,b)=>calcEcartValeur(a)-calcEcartValeur(b));
            const totalPerte=problemItems.reduce((s,i)=>s+calcEcartValeur(i),0);
            return(<div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14,marginBottom:20}}>
                <div className="cost-c">
                  <div className="cl">Produits en écart</div>
                  <div className="cv" style={{color:'var(--rouge)'}}>{problemItems.length}</div>
                  <div className="ct">sur {inventory.length} références</div>
                </div>
                <div className="cost-c">
                  <div className="cl">Perte estimée (coulage)</div>
                  <div className="cv" style={{color:'var(--rouge)'}}>{eur(totalPerte)}</div>
                  <div className="ct">à investiguer</div>
                </div>
                <div className="cost-c">
                  <div className="cl">Taux de coulage</div>
                  <div className="cv" style={{color:Math.abs(totalPerte/totalValeurStock*100)>3?'var(--rouge)':'var(--orange)'}}>{Math.abs(totalPerte/totalValeurStock*100).toFixed(1)}%</div>
                  <div className="ct">Seuil acceptable : 2-3%</div>
                </div>
              </div>
              <div className="tbl"><table>
                <thead><tr>
                  <th style={{textAlign:'left'}}>Produit</th><th>Catégorie</th>
                  <th style={{textAlign:'right'}}>Théorique</th><th style={{textAlign:'right'}}>Compté</th>
                  <th style={{textAlign:'right'}}>Écart (qty)</th><th style={{textAlign:'right'}}>Écart (%)</th>
                  <th style={{textAlign:'right'}}>Perte (€)</th><th>Diagnostic</th>
                </tr></thead>
                <tbody>
                  {problemItems.map(item=>{
                    const theo=calcTheorique(item);
                    const ecart=calcEcart(item);
                    const ecartPct=calcEcartPct(item);
                    const ecartVal=calcEcartValeur(item);
                    const isVeryBad=Math.abs(ecartPct)>15;
                    // Auto-diagnosis
                    let diag='';let diagColor='';
                    if(ecart<0&&Math.abs(ecartPct)>15){diag='Coulage probable';diagColor='var(--rouge)';}
                    else if(ecart<0&&Math.abs(ecartPct)>5){diag='Perte / casse ?';diagColor='var(--orange)';}
                    else if(ecart>0&&ecartPct>10){diag='Erreur saisie ?';diagColor='var(--bleu)';}
                    else{diag='À vérifier';diagColor='var(--orange)';}
                    return(<tr key={item.id} style={{background:isVeryBad?'rgba(220,38,38,.04)':'transparent'}}>
                      <td style={{textAlign:'left',fontWeight:600}}>{item.nom}</td>
                      <td><span className="badge b-ima" style={{fontSize:9}}>{item.cat}</span></td>
                      <td style={{textAlign:'right'}}>{theo} {item.unite}</td>
                      <td style={{textAlign:'right',fontWeight:600}}>{item.compteInventaire} {item.unite}</td>
                      <td style={{textAlign:'right',fontWeight:700,color:ecart<0?'var(--rouge)':'var(--vert)'}}>
                        {ecart>0?'+':''}{ecart} {item.unite}
                      </td>
                      <td style={{textAlign:'right',fontWeight:700,color:ecartPct<-5?'var(--rouge)':'var(--orange)'}}>
                        {ecartPct>0?'+':''}{ecartPct}%
                      </td>
                      <td style={{textAlign:'right',fontWeight:700,color:ecartVal<0?'var(--rouge)':'var(--vert)'}}>
                        {ecartVal>0?'+':''}{eur(ecartVal)}
                      </td>
                      <td><span style={{fontSize:12,fontWeight:600,color:diagColor}}>{diag}</span></td>
                    </tr>);
                  })}
                </tbody>
                <tfoot><tr style={{fontWeight:700,background:'var(--gris-50)',borderTop:'2px solid var(--gris-300)'}}>
                  <td style={{textAlign:'left'}}>TOTAL PERTES</td><td/><td/><td/><td/><td/>
                  <td style={{textAlign:'right',color:'var(--rouge)',fontSize:16}}>{eur(totalPerte)}</td><td/>
                </tr></tfoot>
              </table></div>
            </div>);
          })()}
        </div>
      </div>

      {/* Écarts par catégorie */}
      <div className="card">
        <div className="card-h"><div><div className="card-t">Écarts par catégorie</div><div className="card-st">Valeur des écarts agrégés par famille de produits</div></div></div>
        <div className="card-b">
          <HBar data={cats.filter(c=>c!=='Tous').map(c=>{
            const items=inventory.filter(i=>i.cat===c);
            const ecartTotal=items.reduce((s,i)=>s+calcEcartValeur(i),0);
            return{label:c,value:Math.abs(ecartTotal),display:`${ecartTotal>0?'+':''}${eur(ecartTotal)}`};
          }).sort((a,b)=>b.value-a.value)} maxVal={Math.max(...cats.filter(c=>c!=='Tous').map(c=>Math.abs(inventory.filter(i=>i.cat===c).reduce((s,i)=>s+calcEcartValeur(i),0))))} color="var(--rouge)"/>
        </div>
      </div>
    </div>}

    {/* ===== TAB: ALERTES ===== */}
    {tab==='alertes'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Alertes stock bas</div><div className="card-st">Produits sous le seuil minimum de réapprovisionnement</div></div></div>
        <div className="card-b"><div className="tbl"><table>
          <thead><tr><th style={{textAlign:'left'}}>Produit</th><th>Catégorie</th><th style={{textAlign:'right'}}>Stock actuel</th><th style={{textAlign:'right'}}>Seuil</th><th style={{width:120}}>Niveau</th><th>Urgence</th></tr></thead>
          <tbody>
            {alertItems.sort((a,b)=>(a.compteInventaire/a.seuil)-(b.compteInventaire/b.seuil)).map(item=>{
              const pct=item.compteInventaire/item.seuil;
              const critique=pct<0.5;
              return(<tr key={item.id}>
                <td style={{textAlign:'left',fontWeight:500}}>{item.nom}</td>
                <td><span className="badge b-ima" style={{fontSize:9}}>{item.cat}</span></td>
                <td style={{textAlign:'right',fontWeight:700,color:critique?'var(--rouge)':'var(--orange)'}}>{item.compteInventaire} {item.unite}</td>
                <td style={{textAlign:'right'}}>{item.seuil} {item.unite}</td>
                <td><div className="pbar"><div className="pfill" style={{width:`${Math.min(pct*100,100)}%`,background:critique?'var(--rouge)':'var(--orange)'}}/></div></td>
                <td><span className={`badge ${critique?'b-err':'b-warn'}`}>{critique?'Critique':'Alerte'}</span></td>
              </tr>);
            })}
          </tbody>
        </table></div></div>
      </div>
    </div>}

    {/* ===== TAB: VALEUR ===== */}
    {tab==='valeur'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Valeur stock par catégorie</div></div></div>
        <div className="card-b">
          <HBar data={cats.filter(c=>c!=='Tous').map(c=>{
            const v=inventory.filter(i=>i.cat===c).reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0);
            return{label:c,value:v};
          }).sort((a,b)=>b.value-a.value)} maxVal={Math.max(...cats.filter(c=>c!=='Tous').map(c=>inventory.filter(i=>i.cat===c).reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0)))}/>
        </div>
      </div>
    </div>}

    {/* ===== MODAL: AJOUTER PRODUIT ===== */}
    {showAddModal&&<div className="modal-overlay" onClick={()=>setShowAddModal(false)}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <h3>Ajouter un produit <button className="modal-close" onClick={()=>setShowAddModal(false)}>×</button></h3>
        <div className="fg"><label className="fl">Nom du produit</label><input className="fi" value={newItem.nom} onChange={e=>setNewItem(p=>({...p,nom:e.target.value}))} placeholder="Ex: Truffe noire Périgord"/></div>
        <div className="fg-row">
          <div className="fg"><label className="fl">Catégorie</label>
            <select className="fi-select" value={newItem.cat} onChange={e=>setNewItem(p=>({...p,cat:e.target.value}))}>
              {cats.filter(c=>c!=='Tous').map(c=><option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div className="fg"><label className="fl">Unité</label>
            <select className="fi-select" value={newItem.unite} onChange={e=>setNewItem(p=>({...p,unite:e.target.value}))}>
              {['kg','g','L','cl','bt','pcs','botte'].map(u=><option key={u} value={u}>{u}</option>)}
            </select>
          </div>
        </div>
        <div className="fg-row">
          <div className="fg"><label className="fl">Prix unitaire (€)</label><input className="fi" type="number" step="0.01" value={newItem.prixUnit||''} onChange={e=>setNewItem(p=>({...p,prixUnit:e.target.value}))} placeholder="0.00"/></div>
          <div className="fg"><label className="fl">Seuil d'alerte</label><input className="fi" type="number" step="0.1" value={newItem.seuil||''} onChange={e=>setNewItem(p=>({...p,seuil:e.target.value}))} placeholder="0"/></div>
        </div>
        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:20}}>
          <button className="btn btn-secondary" onClick={()=>setShowAddModal(false)}>Annuler</button>
          <button className="btn btn-primary" onClick={addItem}>Ajouter</button>
        </div>
      </div>
    </div>}
  </div>);
}

// ===== CRM =====
function CRMPage(){
  return(<div className="fin">
    <div style={{background:'var(--bleu-light)',border:'1px solid var(--bleu)',borderRadius:10,padding:16,marginBottom:20,fontSize:13,color:'var(--bleu)'}}>
      <strong>CRM & Réservations</strong> — Cette page affichera les données SevenRooms une fois le service connecté.
    </div>
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">Réservations</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>—</div><div className="kpi-chg neu">En attente SevenRooms</div></div>
      <div className="kpi"><div className="kpi-label">Taux occupation</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>—</div><div className="kpi-chg neu">En attente</div></div>
      <div className="kpi"><div className="kpi-label">Clients VIP</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>—</div><div className="kpi-chg neu">En attente</div></div>
      <div className="kpi"><div className="kpi-label">Note moyenne</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>—</div><div className="kpi-chg neu">En attente</div></div>
    </div>
    <div className="card">
      <div className="card-h"><div><div className="card-t">Réservations</div><div className="card-st">SevenRooms</div></div><span className="badge b-warn">Non connecté</span></div>
      <div className="card-b" style={{padding:50,textAlign:'center',color:'var(--gris-400)'}}>
        <div style={{fontSize:32,marginBottom:10}}>📋</div>
        <div style={{fontWeight:500,marginBottom:4}}>Connectez SevenRooms pour afficher les réservations</div>
        <div style={{fontSize:11}}>Rendez-vous dans Administration → Intégrations</div>
      </div>
    </div>
  </div>);
}

// ===== POS =====
function POSPage(){
  const hasTrivec=TrivecService.isConnected();
  const allDays=TrivecService.getAllDays();
  const[viewMode,setViewMode]=useState('jour');

  // Today's date in dd/mm/yyyy format
  const now=new Date();
  const todayStr=String(now.getDate()).padStart(2,'0')+'/'+String(now.getMonth()+1).padStart(2,'0')+'/'+now.getFullYear();

  // Filter days based on viewMode
  const filteredDays=useMemo(()=>{
    const entries=Object.entries(allDays);
    if(viewMode==='jour'){
      // Show only today — day resets at 18h so today = current date
      return entries.filter(([d])=>d===todayStr);
    }
    if(viewMode==='semaine'){
      // Current week (Mon-Sun)
      const d=new Date();
      const dayOfWeek=d.getDay()||7;
      const monday=new Date(d);monday.setDate(d.getDate()-(dayOfWeek-1));
      monday.setHours(0,0,0,0);
      return entries.filter(([dateStr])=>{
        const p=dateStr.split('/');
        const dt=new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0]));
        return dt>=monday&&dt<=d;
      });
    }
    if(viewMode==='mois'){
      const m=now.getMonth()+1,y=now.getFullYear();
      return entries.filter(([dateStr])=>{
        const p=dateStr.split('/');
        return parseInt(p[1])===m&&parseInt(p[2])===y;
      });
    }
    // année
    const y=now.getFullYear();
    return entries.filter(([dateStr])=>{
      const p=dateStr.split('/');
      return parseInt(p[2])===y;
    });
  },[allDays,viewMode,todayStr]);

  // Aggregate filtered data
  const agg=useMemo(()=>{
    let totalCA=0,totalCouverts=0,totalEspeces=0,totalCB=0,totalAmex=0,caResto=0,caClub=0,caBar=0,days=0;
    filteredDays.forEach(([,d])=>{
      totalCA+=d.ventes?.total||0;
      totalCouverts+=(d.couverts?.restaurant?.total||0)+(d.couverts?.club?.total||0)+(d.couverts?.bar?.total||0);
      totalEspeces+=d.paiements?.especes||0;
      totalCB+=d.paiements?.cb||0;
      totalAmex+=d.paiements?.amex||0;
      caResto+=d.ventes?.restaurant||0;
      caClub+=d.ventes?.club||0;
      caBar+=d.ventes?.bar||0;
      days++;
    });
    return{totalCA,totalCouverts,totalEspeces,totalCB,totalAmex,caResto,caClub,caBar,days,ticketMoyen:totalCouverts>0?totalCA/totalCouverts:0};
  },[filteredDays]);

  const viewLabels={jour:'Jour',semaine:'Semaine',mois:'Mois',annee:'Année'};
  const periodLabel=viewMode==='jour'?todayStr:viewMode==='semaine'?'Cette semaine':viewMode==='mois'?now.toLocaleDateString('fr-FR',{month:'long',year:'numeric'}):''+now.getFullYear();

  // For the detail card, show the day data if viewing a single day
  const dayDetail=viewMode==='jour'?allDays[todayStr]:null;

  return(<div className="fin">
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div><span style={{fontSize:18,fontWeight:700}}>Caisses (Trivec)</span><span style={{fontSize:13,color:'var(--gris-500)',marginLeft:10}}>{periodLabel}</span></div>
      <div style={{display:'flex',border:'1px solid var(--gris-200)',borderRadius:8,overflow:'hidden'}}>
        {['jour','semaine','mois','annee'].map(m=>(
          <button key={m} onClick={()=>setViewMode(m)} style={{padding:'6px 14px',fontSize:12,fontWeight:viewMode===m?600:400,background:viewMode===m?'var(--bordeaux)':'white',color:viewMode===m?'white':'var(--gris-600)',border:'none',cursor:'pointer',transition:'all .15s'}}>{viewLabels[m]}</button>
        ))}
      </div>
    </div>

    {!hasTrivec&&<div style={{background:'var(--bleu-light)',border:'1px solid var(--bleu)',borderRadius:10,padding:16,marginBottom:20,fontSize:13,color:'var(--bleu)'}}>
      <strong>Caisses Trivec</strong> — Importez les fichiers Excel Trivec dans Administration pour voir les données.
    </div>}

    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">CA {viewLabels[viewMode]}</div><div className="kpi-val" style={{color:agg.totalCA>0?'var(--gris-900)':'var(--gris-300)'}}>{agg.totalCA>0?agg.totalCA.toLocaleString('fr-FR')+'€':'0€'}</div><div className={`kpi-chg ${agg.days>0?'pos':'neu'}`}>{agg.days>0?`${agg.days} jour(s)`:'Aucune donnée'}</div></div>
      <div className="kpi"><div className="kpi-label">Ticket moyen</div><div className="kpi-val" style={{color:agg.ticketMoyen>0?'var(--gris-900)':'var(--gris-300)'}}>{agg.ticketMoyen>0?Math.round(agg.ticketMoyen)+'€':'0€'}</div><div className={`kpi-chg ${agg.ticketMoyen>0?'pos':'neu'}`}>{agg.ticketMoyen>0?'Restaurant':'—'}</div></div>
      <div className="kpi"><div className="kpi-label">Couverts</div><div className="kpi-val" style={{color:agg.totalCouverts>0?'var(--gris-900)':'var(--gris-300)'}}>{agg.totalCouverts>0?agg.totalCouverts.toLocaleString('fr-FR'):'0'}</div><div className={`kpi-chg ${agg.totalCouverts>0?'pos':'neu'}`}>{agg.totalCouverts>0?'Tous départements':'—'}</div></div>
      <div className="kpi"><div className="kpi-label">CB / Espèces / Amex</div><div className="kpi-val" style={{fontSize:agg.totalCA>0?14:24,color:agg.totalCA>0?'var(--gris-900)':'var(--gris-300)'}}>{agg.totalCA>0?`${Math.round(agg.totalCB).toLocaleString('fr-FR')}€ / ${Math.round(agg.totalEspeces).toLocaleString('fr-FR')}€ / ${Math.round(agg.totalAmex).toLocaleString('fr-FR')}€`:'0€'}</div><div className={`kpi-chg ${agg.totalCA>0?'pos':'neu'}`}>{agg.totalCA>0?'Paiements':'—'}</div></div>
    </div>

    {viewMode==='jour'&&!dayDetail&&hasTrivec&&<div style={{background:'var(--orange-light)',border:'1px solid var(--orange)',borderRadius:10,padding:16,marginBottom:16,fontSize:13,color:'var(--orange)'}}>
      <strong>Pas de données pour le {todayStr}.</strong> La journée n'a pas encore été clôturée ou le fichier Trivec n'a pas été importé. La clôture a lieu à 18h.
    </div>}

    {dayDetail&&<div className="card" style={{marginBottom:16}}>
      <div className="card-h"><div><div className="card-t">Détail — {todayStr}</div></div><span className="badge b-ok">Trivec</span></div>
      <div className="card-b">
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:16,marginBottom:16}}>
          {[{l:'Restaurant',v:dayDetail.ventes?.restaurant,c:dayDetail.couverts?.restaurant},{l:'Club',v:dayDetail.ventes?.club,c:dayDetail.couverts?.club},{l:'Bar',v:dayDetail.ventes?.bar,c:dayDetail.couverts?.bar}].map((dept,i)=>
            <div key={i} style={{padding:14,background:'var(--gris-50)',borderRadius:8,textAlign:'center'}}>
              <div style={{fontSize:10,color:'var(--gris-500)',textTransform:'uppercase',fontWeight:600}}>{dept.l}</div>
              <div style={{fontSize:20,fontWeight:700,color:'var(--bordeaux)'}}>{(dept.v||0).toLocaleString('fr-FR')}€</div>
              <div style={{fontSize:11,color:'var(--gris-500)'}}>{dept.c?.total||0} couverts{dept.c?.avgCover?' — TM '+Math.round(dept.c.avgCover)+'€':''}</div>
            </div>
          )}
        </div>
        <div style={{fontSize:12,fontWeight:600,marginBottom:8}}>Paiements</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8,fontSize:11}}>
          {[{l:'Espèces',v:dayDetail.paiements?.especes},{l:'CB',v:dayDetail.paiements?.cb},{l:'Amex',v:dayDetail.paiements?.amex},{l:'Aucun',v:dayDetail.paiements?.aucun},{l:'SevenRoom',v:dayDetail.paiements?.sevenroom}].map((p,i)=>
            <div key={i} style={{padding:8,background:'var(--gris-50)',borderRadius:6,textAlign:'center'}}>
              <div style={{color:'var(--gris-500)',fontSize:9}}>{p.l}</div>
              <div style={{fontWeight:600}}>{(p.v||0).toLocaleString('fr-FR')}€</div>
            </div>
          )}
        </div>
        {dayDetail.internes?.details?.length>0&&<div style={{marginTop:12}}>
          <div style={{fontSize:12,fontWeight:600,marginBottom:6}}>Comptes internes ({(dayDetail.internes?.total||0).toLocaleString('fr-FR')}€)</div>
          <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
            {dayDetail.internes.details.map((c,i)=><div key={i} style={{padding:'3px 8px',background:'var(--orange-light)',borderRadius:4,fontSize:10}}>{c.nom}: {c.montant}€</div>)}
          </div>
        </div>}
      </div>
    </div>}

    {viewMode!=='jour'&&agg.days>0&&<div className="card" style={{marginBottom:16}}>
      <div className="card-h"><div><div className="card-t">Répartition CA — {periodLabel}</div></div></div>
      <div className="card-b">
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:16}}>
          {[{l:'Restaurant',v:agg.caResto,pct:agg.totalCA>0?(agg.caResto/agg.totalCA*100):0},{l:'Club',v:agg.caClub,pct:agg.totalCA>0?(agg.caClub/agg.totalCA*100):0},{l:'Bar',v:agg.caBar,pct:agg.totalCA>0?(agg.caBar/agg.totalCA*100):0}].map((dept,i)=>
            <div key={i} style={{padding:14,background:'var(--gris-50)',borderRadius:8,textAlign:'center'}}>
              <div style={{fontSize:10,color:'var(--gris-500)',textTransform:'uppercase',fontWeight:600}}>{dept.l}</div>
              <div style={{fontSize:20,fontWeight:700,color:'var(--bordeaux)'}}>{dept.v.toLocaleString('fr-FR')}€</div>
              <div style={{fontSize:11,color:'var(--gris-500)'}}>{dept.pct.toFixed(1)}% du CA</div>
            </div>
          )}
        </div>
      </div>
    </div>}

    <div className="card">
      <div className="card-h"><div><div className="card-t">Historique journalier</div><div className="card-st">Trivec POS</div></div>{hasTrivec?<span className="badge b-ok">{filteredDays.length} jour(s)</span>:<span className="badge b-warn">Non connecté</span>}</div>
      <div className="card-b">
        {filteredDays.length>0?<table className="t-table"><thead><tr><th>Date</th><th style={{textAlign:'right'}}>CA Total</th><th style={{textAlign:'right'}}>Restaurant</th><th style={{textAlign:'right'}}>Club</th><th style={{textAlign:'right'}}>Bar</th><th style={{textAlign:'right'}}>Couverts</th><th style={{textAlign:'right'}}>TM Resto</th></tr></thead>
        <tbody>{filteredDays.sort((a,b)=>{const pa=a[0].split('/').reverse().join('');const pb=b[0].split('/').reverse().join('');return pb.localeCompare(pa);}).map(([date,d])=>
          <tr key={date}><td style={{fontWeight:500}}>{date}</td>
            <td style={{textAlign:'right',fontWeight:600}}>{(d.caTotal||0).toLocaleString('fr-FR')}€</td>
            <td style={{textAlign:'right'}}>{(d.ventes?.restaurant||0).toLocaleString('fr-FR')}€</td>
            <td style={{textAlign:'right'}}>{(d.ventes?.club||0).toLocaleString('fr-FR')}€</td>
            <td style={{textAlign:'right'}}>{(d.ventes?.bar||0).toLocaleString('fr-FR')}€</td>
            <td style={{textAlign:'right'}}>{(d.couverts?.restaurant?.total||0)+(d.couverts?.club?.total||0)+(d.couverts?.bar?.total||0)}</td>
            <td style={{textAlign:'right'}}>{Math.round(d.couverts?.restaurant?.avgCover||0)}€</td>
          </tr>
        )}</tbody></table>:
        <div style={{padding:40,textAlign:'center',color:'var(--gris-400)',fontSize:12}}>
          {hasTrivec?`Aucune donnée pour cette période (${periodLabel})`:'Importez les fichiers Trivec dans Administration'}
        </div>}
      </div>
    </div>
  </div>);
}

// ===== CLÔTURE DE CAISSE =====
function CaissePage(){
  const[tab,setTab]=useState('saisie');
  const[entries,setEntries]=useState(()=>{
    try{return JSON.parse(localStorage.getItem('ima_caisse_v2')||'[]');}catch(e){return[];}
  });
  const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];

  // Default empty entry structure
  const emptyEntry={
    date:new Date().toISOString().split('T')[0],
    dayOfWeek:new Date().getDay(),
    nom:'',responsable:'',
    caDomino:{liquide10:0,liquide20:0,solide10:0,solide20:0,tips:0,virement:0},
    caDept:{restaurant:0,club:0,bar:0},
    rapprochement:{domino:{especes:0,cb:0,amex:0,tipsCb:0,tipsAmex:0,entree:0,creditClient:0,virement:0,sevenroom:0},reel:{especes:0,cb:0,amex:0,tipsCb:0,tipsAmex:0,entree:0,creditClient:0,virement:0,sevenroom:0}},
    tipsDetails:{restoEsp:0,restoCb:0,clubEsp:0,clubCb:0},
    creditClients:[],creditClientsRembt:[],
    detailEspeces:{500:0,200:0,100:0,50:0,20:0,10:0,5:0,2:0,1:0,0.50:0,0.20:0,0.10:0,0.05:0,0.02:0,0.01:0},
    commentaires:'',teleCb:0,teleAmex:0
  };

  const[formData,setFormData]=useState(emptyEntry);

  const handleInputChange=(path,value)=>{
    const parts=path.split('.');
    setFormData(prev=>{
      const copy={...prev};
      let current=copy;
      for(let i=0;i<parts.length-1;i++){
        if(!current[parts[i]])current[parts[i]]={};
        current=current[parts[i]];
      }
      current[parts[parts.length-1]]=isNaN(value)?value:parseFloat(value)||0;
      return copy;
    });
  };

  const getCATotals=()=>{
    const d=formData.caDomino;
    const total=d.liquide10+d.liquide20+d.solide10+d.solide20+d.tips+d.virement;
    return{total,netTotal:formData.caDept.restaurant+formData.caDept.club+formData.caDept.bar};
  };

  const getRapprochTotals=()=>{
    const calc=(section)=>Object.values(section).reduce((s,v)=>s+v,0);
    const domTotal=calc(formData.rapprochement.domino);
    const realTotal=calc(formData.rapprochement.reel);
    return{domTotal,realTotal,ecart:realTotal-domTotal};
  };

  const getCashTotals=()=>{
    const details=formData.detailEspeces;
    const denoms=[500,200,100,50,20,10,5,2,1,0.50,0.20,0.10,0.05,0.02,0.01];
    let total=0;
    denoms.forEach(d=>{
      total+=(details[d]||0)*d;
    });
    return total;
  };

  const handleSaveEntry=()=>{
    const newEntry={...formData,id:Date.now(),createdAt:new Date().toISOString()};
    setEntries(prev=>{const updated=[newEntry,...prev];localStorage.setItem('ima_caisse_v2',JSON.stringify(updated));return updated;});
    setFormData(emptyEntry);
    alert('Saisie enregistrée avec succès !');
  };

  const SectionCard=({title,children})=>(
    <div style={{background:'var(--blanc)',border:'1px solid var(--gris-200)',borderRadius:12,padding:18,marginBottom:16}}>
      <div style={{fontSize:13,fontWeight:600,color:'var(--gris-800)',marginBottom:14,textTransform:'uppercase',letterSpacing:'0.5px'}}>{title}</div>
      {children}
    </div>
  );

  const NumInput=({label,value,onChange,readOnly=false})=>(
    <div className="fg" style={{marginBottom:12}}>
      <label className="fl">{label}</label>
      <input type="number" step="0.01" className="fi" value={value} onChange={e=>onChange(e.target.value)} readOnly={readOnly} style={{backgroundColor:readOnly?'var(--gris-50)':undefined}}/>
    </div>
  );

  return(<div className="fin">
    <div className="tabs">
      <div className={`tab ${tab==='saisie'?'active':''}`} onClick={()=>setTab('saisie')}>Saisie du jour</div>
      <div className={`tab ${tab==='recap'?'active':''}`} onClick={()=>setTab('recap')}>Récap semaine</div>
      <div className={`tab ${tab==='historique'?'active':''}`} onClick={()=>setTab('historique')}>Historique</div>
    </div>

    {tab==='saisie'&&<div>
      <SectionCard title="Données Domino (POS)">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
          <NumInput label="Date" value={formData.date} onChange={v=>handleInputChange('date',v)}/>
          <div className="fg">
            <label className="fl">Responsable</label>
            <select className="fi-select" value={formData.responsable} onChange={e=>handleInputChange('responsable',e.target.value)}>
              <option value="">— Sélectionner —</option>
              {StaffRegistry.getResponsables().length>0?
                StaffRegistry.getResponsables().map(emp=><option key={emp.id} value={emp.nom}>{emp.nom} — {emp.poste}</option>):
                StaffRegistry.getActive().map(emp=><option key={emp.id} value={emp.nom}>{emp.nom} — {emp.poste}</option>)
              }
            </select>
          </div>
        </div>
        <div style={{fontSize:12,fontWeight:600,color:'var(--gris-700)',marginBottom:10,marginTop:16}}>CA DOMINO Détails</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginBottom:16}}>
          <NumInput label="LIQUIDE 10%" value={formData.caDomino.liquide10} onChange={v=>handleInputChange('caDomino.liquide10',v)}/>
          <NumInput label="LIQUIDE 20%" value={formData.caDomino.liquide20} onChange={v=>handleInputChange('caDomino.liquide20',v)}/>
          <NumInput label="SOLIDE 10%" value={formData.caDomino.solide10} onChange={v=>handleInputChange('caDomino.solide10',v)}/>
          <NumInput label="SOLIDE 20%" value={formData.caDomino.solide20} onChange={v=>handleInputChange('caDomino.solide20',v)}/>
          <NumInput label="TIPS" value={formData.caDomino.tips} onChange={v=>handleInputChange('caDomino.tips',v)}/>
          <NumInput label="VIREMENT" value={formData.caDomino.virement} onChange={v=>handleInputChange('caDomino.virement',v)}/>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,marginBottom:16,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span>TOTAL CA TTC:</span><span style={{fontSize:16,color:'var(--bordeaux)'}}>{eur(getCATotals().total)}</span>
        </div>
        <div style={{fontSize:12,fontWeight:600,color:'var(--gris-700)',marginBottom:10}}>CA par Département</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
          <NumInput label="CA RESTAURANT" value={formData.caDept.restaurant} onChange={v=>handleInputChange('caDept.restaurant',v)}/>
          <NumInput label="CA CLUB" value={formData.caDept.club} onChange={v=>handleInputChange('caDept.club',v)}/>
          <NumInput label="CA BAR" value={formData.caDept.bar} onChange={v=>handleInputChange('caDept.bar',v)}/>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,marginTop:12,display:'flex',justifyContent:'space-between'}}>
          <span>TOTAL CA NET:</span><span style={{fontSize:16,color:'var(--bordeaux)'}}>{eur(getCATotals().netTotal)}</span>
        </div>
      </SectionCard>

      <SectionCard title="Rapprochement Domino vs Réel">
        <div style={{overflowX:'auto'}}>
          <table style={{width:'100%',borderCollapse:'collapse',marginBottom:12}}>
            <thead><tr style={{background:'var(--gris-50)',borderBottom:'2px solid var(--gris-200)'}}>
              <th style={{padding:'8px',textAlign:'left',fontWeight:600,fontSize:11}}>Ligne</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>DOMINO</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>RÉEL</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>ÉCART</th>
            </tr></thead>
            <tbody>
              {['especes','cb','amex','tipsCb','tipsAmex','entree','creditClient','virement','sevenroom'].map(key=>{
                const d=formData.rapprochement.domino[key]||0;
                const r=formData.rapprochement.reel[key]||0;
                const ecart=r-d;
                return(<tr key={key} style={{borderBottom:'1px solid var(--gris-100)'}}>
                  <td style={{padding:'8px',fontSize:12,fontWeight:500}}>{key.replace(/([A-Z])/g,' $1').trim().toUpperCase()}</td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12}}><input type="number" step="0.01" style={{width:'70px',padding:'4px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'right'}} value={d} onChange={e=>handleInputChange(`rapprochement.domino.${key}`,e.target.value)}/></td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12}}><input type="number" step="0.01" style={{width:'70px',padding:'4px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'right'}} value={r} onChange={e=>handleInputChange(`rapprochement.reel.${key}`,e.target.value)}/></td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12,fontWeight:600,color:ecart===0?'var(--vert)':'var(--rouge)',background:ecart===0?'var(--vert-light)':'var(--rouge-light)',borderRadius:4}}>{eur(ecart)}</td>
                </tr>);
              })}
            </tbody>
          </table>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,display:'flex',justifyContent:'space-between'}}>
          <span>TOTAL CA RECEIVED:</span><span style={{fontSize:16,color:'var(--bordeaux)'}}>{eur(getRapprochTotals().realTotal)}</span>
        </div>
      </SectionCard>

      <SectionCard title="Tips">
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
          <NumInput label="Tips Resto ESP" value={formData.tipsDetails.restoEsp} onChange={v=>handleInputChange('tipsDetails.restoEsp',v)}/>
          <NumInput label="Tips Resto CB" value={formData.tipsDetails.restoCb} onChange={v=>handleInputChange('tipsDetails.restoCb',v)}/>
          <NumInput label="Tips Club ESP" value={formData.tipsDetails.clubEsp} onChange={v=>handleInputChange('tipsDetails.clubEsp',v)}/>
          <NumInput label="Tips Club CB" value={formData.tipsDetails.clubCb} onChange={v=>handleInputChange('tipsDetails.clubCb',v)}/>
        </div>
      </SectionCard>

      <SectionCard title="Détails Espèces (Cash Counting)">
        <div style={{overflowX:'auto'}}>
          <table style={{width:'100%',borderCollapse:'collapse',marginBottom:12}}>
            <thead><tr style={{background:'var(--gris-50)',borderBottom:'2px solid var(--gris-200)'}}>
              <th style={{padding:'8px',textAlign:'left',fontWeight:600,fontSize:11}}>Dénomination</th>
              <th style={{padding:'8px',textAlign:'center',fontWeight:600,fontSize:11}}>NOMBRE</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>MONTANT</th>
            </tr></thead>
            <tbody>
              {[500,200,100,50,20,10,5,2,1,0.50,0.20,0.10,0.05,0.02,0.01].map(denom=>{
                const count=formData.detailEspeces[denom]||0;
                const amount=count*denom;
                return(<tr key={denom} style={{borderBottom:'1px solid var(--gris-100)'}}>
                  <td style={{padding:'8px',fontSize:12,fontWeight:500}}>{denom>=1?'€'+denom.toFixed(0):'€'+denom.toFixed(2)}</td>
                  <td style={{padding:'8px',textAlign:'center'}}><input type="number" style={{width:'60px',padding:'4px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'center'}} value={count} onChange={e=>handleInputChange(`detailEspeces.${denom}`,parseInt(e.target.value)||0)}/></td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12,background:'var(--gris-50)',fontWeight:500}}>{eur(amount)}</td>
                </tr>);
              })}
            </tbody>
          </table>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,display:'flex',justifyContent:'space-between'}}>
          <span>TOTAL ESPÈCES:</span><span style={{fontSize:16,color:'var(--vert)'}}>{eur(getCashTotals())}</span>
        </div>
      </SectionCard>

      <SectionCard title="Télécollecte">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <NumInput label="TELE CB" value={formData.teleCb} onChange={v=>handleInputChange('teleCb',v)}/>
          <NumInput label="TELE AMEX" value={formData.teleAmex} onChange={v=>handleInputChange('teleAmex',v)}/>
        </div>
      </SectionCard>

      <SectionCard title="Commentaires">
        <textarea className="fi" style={{fontFamily:'inherit',minHeight:80,width:'100%',resize:'vertical',padding:12}} value={formData.commentaires} onChange={e=>handleInputChange('commentaires',e.target.value)} placeholder="Notes du jour..."/>
      </SectionCard>

      <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:16}}>
        <button className="btn btn-primary" onClick={handleSaveEntry}>Enregistrer la saisie</button>
      </div>
    </div>}

    {tab==='recap'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Récapitulatif Semaine</div><div className="card-st">Synthèse de la semaine en cours</div></div></div>
        <div className="card-b"><div style={{overflowX:'auto'}}>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}>
            <thead><tr style={{background:'var(--gris-50)',borderBottom:'2px solid var(--gris-200)'}}>
              <th style={{padding:'10px',textAlign:'left',fontWeight:600,fontSize:11}}>Indicateur</th>
              {days.map(d=><th key={d} style={{padding:'10px',textAlign:'right',fontWeight:600,fontSize:11}}>{d}</th>)}
              <th style={{padding:'10px',textAlign:'right',fontWeight:600,fontSize:11,color:'var(--bordeaux)'}}>TOTAL</th>
            </tr></thead>
            <tbody>
              {['TOTAL CA TTC','TOTAL CA NET','ENCAISSEMENT REEL','ECART REEL/DOMINO','ESPECES','CB','AMEX','CREDIT CLIENT','VIREMENT','SEVENROOM','TELE CB','TELE AMEX'].map(metric=>(
                <tr key={metric} style={{borderBottom:'1px solid var(--gris-100)'}}>
                  <td style={{padding:'10px',fontWeight:500}}>{metric}</td>
                  {days.map(d=><td key={d} style={{padding:'10px',textAlign:'right',background:'var(--gris-50)'}}>—</td>)}
                  <td style={{padding:'10px',textAlign:'right',fontWeight:600,color:'var(--bordeaux)'}}>—</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div></div>
      </div>
    </div>}

    {tab==='historique'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Historique des Saisies</div><div className="card-st">{entries.length} enregistrements</div></div></div>
        <div className="card-b">
          {entries.length===0?<div style={{textAlign:'center',padding:40,color:'var(--gris-400)'}}>Aucune saisie enregistrée</div>:
          <div className="tbl"><table>
            <thead><tr><th>Date</th><th>Responsable</th><th style={{textAlign:'right'}}>CA TTC</th><th style={{textAlign:'right'}}>Total Réel</th><th style={{textAlign:'right'}}>Écart</th></tr></thead>
            <tbody>
              {entries.map(e=>{
                const totals=getRapprochTotals();
                return(<tr key={e.id} style={{cursor:'pointer'}}>
                  <td style={{fontWeight:500}}>{new Date(e.date).toLocaleDateString('fr-FR')}</td>
                  <td>{e.responsable}</td>
                  <td style={{textAlign:'right'}}>{eur(getCATotals().total)}</td>
                  <td style={{textAlign:'right'}}>{eur(totals.realTotal)}</td>
                  <td style={{textAlign:'right',fontWeight:600,color:totals.ecart===0?'var(--vert)':'var(--rouge)'}}>{eur(totals.ecart)}</td>
                </tr>);
              })}
            </tbody>
          </table></div>}
        </div>
      </div>
    </div>}
  </div>);
}

// ===== TIPS PAGE =====
function TipsPage(){
  const[tab,setTab]=useState('salle');
  const[params,setParams]=useState(()=>{
    try{return JSON.parse(localStorage.getItem('ima_tips_params')||JSON.stringify({totalTipsWeek:0,cuisineSplit:15}));}catch(e){
      return{totalTipsWeek:0,cuisineSplit:15};
    }
  });
  const[joursTravailles,setJoursTravailles]=useState(()=>{
    try{return JSON.parse(localStorage.getItem('ima_tips_period')||JSON.stringify({}));}catch(e){
      return{};
    }
  });

  const handleUpdateJours=(empId,value)=>{
    const updated={...joursTravailles,[empId]:parseFloat(value)||0};
    setJoursTravailles(updated);
    localStorage.setItem('ima_tips_period',JSON.stringify(updated));
  };

  const calculateTotalsForSection=(section)=>{
    let totalPoints=0;
    StaffRegistry.getBySection(section).forEach(emp=>{
      const days=joursTravailles[emp.id]||0;
      totalPoints+=(emp.points||0)*days;
    });
    return totalPoints;
  };

  const getSectionTips=(section)=>{
    if(section==='salle')return params.totalTipsWeek*(1-(params.cuisineSplit||15)/100);
    return params.totalTipsWeek*(params.cuisineSplit||15)/100;
  };

  const SectionTab=({section})=>{
    const employees=StaffRegistry.getBySection(section);
    const tipsEligible=employees.filter(e=>e.tips);
    const totalPtsSection=calculateTotalsForSection(section);
    const sectionTips=getSectionTips(section);
    const valPtJour=totalPtsSection>0?sectionTips/totalPtsSection:0;

    const groupedByCategory={};
    Object.keys(TIP_CATEGORIES[section]||{}).forEach(cat=>{
      groupedByCategory[cat]=tipsEligible.filter(e=>e.tipCategory===cat);
    });

    return(
      <div className="card">
        <div className="card-h"><div><div className="card-t">Distribution Tips — {section==='salle'?'SALLE':'CUISINE'}</div><div className="card-st">{section==='salle'?'Restaurant, Bar, Accueil':'Kitchen staff'}</div></div></div>
        <div className="card-b">
          {Object.entries(groupedByCategory).map(([catKey,empList])=>{
            const catData=TIP_CATEGORIES[section][catKey];
            return(<div key={catKey} style={{marginBottom:24}}>
              <div style={{background:catData.color,color:'white',padding:10,borderRadius:6,marginBottom:12,fontSize:12,fontWeight:600}}>{catData.label}</div>
              {empList.length===0?<div style={{color:'var(--gris-400)',fontSize:12,padding:10}}>Aucun employé assigné</div>:(
                <div style={{overflowX:'auto',marginBottom:12}}>
                  <table style={{width:'100%',borderCollapse:'collapse',fontSize:11}}>
                    <thead><tr style={{background:'var(--gris-100)',borderBottom:'1px solid var(--gris-300)'}}>
                      <th style={{padding:'8px',textAlign:'left',fontWeight:600}}>NOM</th>
                      <th style={{padding:'8px',textAlign:'center',fontWeight:600}}>POINTS</th>
                      <th style={{padding:'8px',textAlign:'center',fontWeight:600}}>JOURS</th>
                      <th style={{padding:'8px',textAlign:'right',fontWeight:600}}>POINTS/JOUR</th>
                      <th style={{padding:'8px',textAlign:'right',fontWeight:600}}>MONTANT TIPS</th>
                    </tr></thead>
                    <tbody>
                      {empList.map(emp=>{
                        const days=joursTravailles[emp.id]||0;
                        const ptsJour=emp.points*days;
                        const montant=ptsJour*valPtJour;
                        return(<tr key={emp.id} style={{borderBottom:'1px solid var(--gris-100)'}}>
                          <td style={{padding:'8px',fontWeight:500}}>{emp.nom}</td>
                          <td style={{padding:'8px',textAlign:'center',fontWeight:600}}>{emp.points}</td>
                          <td style={{padding:'8px',textAlign:'center'}}><input type="number" step="0.5" min="0" max="7" style={{width:'50px',padding:'4px 6px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'center',fontFamily:'inherit'}} value={days} onChange={e=>handleUpdateJours(emp.id,e.target.value)}/></td>
                          <td style={{padding:'8px',textAlign:'right',fontSize:11,fontWeight:600,background:'var(--gris-50)'}}>{ptsJour.toFixed(1)}</td>
                          <td style={{padding:'8px',textAlign:'right',fontSize:11,fontWeight:600,background:'var(--vert-light)',color:'var(--vert)'}}>{eur(montant)}</td>
                        </tr>);
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>);
          })}
          <div style={{marginTop:20,padding:'12px',background:'var(--gris-50)',borderRadius:8,fontSize:12}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
              <span style={{fontWeight:600}}>Total points-jours ({section}):</span>
              <span style={{fontWeight:700}}>{totalPtsSection.toFixed(1)}</span>
            </div>
            <div style={{display:'flex',justifyContent:'space-between'}}>
              <span style={{fontWeight:600}}>Valeur point/jour:</span>
              <span style={{fontWeight:700}}>{eur(valPtJour)}</span>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return(<div className="fin">
    <div className="card" style={{marginBottom:20}}>
      <div className="card-h"><div><div className="card-t">Synthèse Tips Semaine</div></div></div>
      <div className="card-b">
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14}}>
          <div><div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500,marginBottom:4,textTransform:'uppercase'}}>Total Tips Semaine</div><div style={{fontSize:18,fontWeight:700,color:'var(--vert)'}}>{eur(params.totalTipsWeek)}</div></div>
          <div><div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500,marginBottom:4,textTransform:'uppercase'}}>Tips Cuisine ({params.cuisineSplit}%)</div><div style={{fontSize:18,fontWeight:700,color:'var(--orange)'}}>{eur(getSectionTips('cuisine'))}</div></div>
          <div><div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500,marginBottom:4,textTransform:'uppercase'}}>Tips Salle ({100-params.cuisineSplit}%)</div><div style={{fontSize:18,fontWeight:700,color:'var(--bleu)'}}>{eur(getSectionTips('salle'))}</div></div>
        </div>
      </div>
    </div>

    <div className="tabs">
      <div className={`tab ${tab==='salle'?'active':''}`} onClick={()=>setTab('salle')}>Salle</div>
      <div className={`tab ${tab==='cuisine'?'active':''}`} onClick={()=>setTab('cuisine')}>Cuisine</div>
      <div className={`tab ${tab==='parametres'?'active':''}`} onClick={()=>setTab('parametres')}>Paramètres</div>
    </div>

    {tab==='salle'&&<SectionTab section="salle"/>}
    {tab==='cuisine'&&<SectionTab section="cuisine"/>}

    {tab==='parametres'&&<div className="card">
      <div className="card-h"><div><div className="card-t">Paramètres Tips</div></div></div>
      <div className="card-b">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20}}>
          <div className="fg">
            <label className="fl">Total Tips Semaine (€)</label>
            <input type="number" step="0.01" className="fi" value={params.totalTipsWeek} onChange={e=>{
              const val=parseFloat(e.target.value)||0;
              const newParams={...params,totalTipsWeek:val};
              setParams(newParams);
              localStorage.setItem('ima_tips_params',JSON.stringify(newParams));
            }}/>
          </div>
          <div className="fg">
            <label className="fl">Split Cuisine (%)</label>
            <input type="number" step="1" className="fi" value={params.cuisineSplit} onChange={e=>{
              const val=parseFloat(e.target.value)||15;
              const newParams={...params,cuisineSplit:val};
              setParams(newParams);
              localStorage.setItem('ima_tips_params',JSON.stringify(newParams));
            }}/>
          </div>
        </div>
      </div>
    </div>}
  </div>);
}

// ===== SETTINGS =====
function Settings(){
  const[token,setToken]=useState(PennylaneService.getToken()||'');
  const[showToken,setShowToken]=useState(false);
  const[testStatus,setTestStatus]=useState(null);
  const[testing,setTesting]=useState(false);
  const[showInviteModal,setShowInviteModal]=useState(false);
  const[inviteData,setInviteData]=useState({nom:'',email:'',role:'Directeur',password:Math.random().toString(36).slice(-8)});
  const[inviteStatus,setInviteStatus]=useState(null);
  const[trivecImporting,setTrivecImporting]=useState(false);
  const[trivecStatus,setTrivecStatus]=useState(null);
  const[trivecDays,setTrivecDays]=useState(TrivecService.getDayCount());
  const trivecFileRef=React.useRef(null);
  const trivecAssortRef=React.useRef(null);

  const handleTrivecImport=async(e,type)=>{
    const files=e.target.files;
    if(!files||files.length===0)return;
    setTrivecImporting(true);
    setTrivecStatus(null);
    let imported=0;let errors=[];
    for(const file of files){
      try{
        if(type==='suivi'){
          const result=await TrivecService.parseSuiviJournalier(file);
          imported++;
          setTrivecStatus({success:true,msg:`Import réussi : ${result.date} — CA ${result.caTotal.toLocaleString('fr-FR')}€, ${result.couverts.restaurant.total+result.couverts.club.total+result.couverts.bar.total} couverts`});
        }else{
          const result=await TrivecService.parseAssortiments(file);
          imported++;
          setTrivecStatus({success:true,msg:`Assortiment importé : ${result.date} — ${result.totalProducts} produits`});
        }
      }catch(err){
        errors.push(file.name+': '+err.message);
      }
    }
    if(errors.length>0)setTrivecStatus({success:false,msg:'Erreurs: '+errors.join(', ')});
    setTrivecDays(TrivecService.getDayCount());
    setTrivecImporting(false);
    setConnectedIntegrations(prev=>({...prev,trivec:TrivecService.isConnected()}));
    e.target.value='';
  };

  const handleInviteUser=async()=>{
    if(!inviteData.nom||!inviteData.email){setInviteStatus({success:false,msg:'Nom et email requis'});return;}
    const result=UserManager.addUser(inviteData);
    if(result.error){setInviteStatus({success:false,msg:result.error});return;}
    // Send invitation email via EmailJS
    setInviteStatus({success:true,msg:'Envoi en cours...'});
    try{
      await emailjs.send('service_0m9rogq','template_5x5loz8',{
        to_name:inviteData.nom,
        to_email:inviteData.email,
        password:inviteData.password,
        role:inviteData.role,
        from_name:UserManager.getCurrentUser()?.nom||'IMA'
      },'Q4hFBbA8dsSG7BkVQ');
      setInviteStatus({success:true,msg:`Invitation envoyée par email à ${inviteData.email}`});
      setInviteData({nom:'',email:'',role:'Directeur',password:Math.random().toString(36).slice(-8)});
      setTimeout(()=>setShowInviteModal(false),2500);
    }catch(err){
      console.error('EmailJS error:',err);
      setInviteStatus({success:false,msg:'Erreur envoi email: '+(err.text||err.message||'Vérifiez la config EmailJS')});
    }
  };

  const handleSaveToken=()=>{
    if(token){
      PennylaneService.setToken(token);
      setTestStatus({success:true,msg:'Token sauvegardé'});
    }
  };

  const[companyInfo,setCompanyInfo]=useState(null);

  const handleTestConnection=async()=>{
    if(!token){
      setTestStatus({success:false,msg:'Veuillez entrer un token d\'abord'});
      return;
    }
    PennylaneService.setToken(token);
    setTesting(true);
    const result=await PennylaneService.testConnection();
    if(result.success){
      setTestStatus({success:true,msg:'Connexion réussie !'});
      setCompanyInfo(result.company);
      setConnectedIntegrations(prev=>({...prev,pennylane:true}));
    }else{
      setTestStatus({success:false,msg:'Erreur: '+result.error});
    }
    setTesting(false);
  };

  const[connectedIntegrations,setConnectedIntegrations]=useState({
    trivec:TrivecService.isConnected(),sevenrooms:false,pennylane:!!PennylaneService.getToken()
  });

  const handleClearToken=()=>{
    PennylaneService.clearToken();
    setToken('');
    setTestStatus({success:false,msg:'Token supprimé'});
    setConnectedIntegrations({...connectedIntegrations,pennylane:false});
  };

  return(<div className="fin">
    <div className="tabs"><div className="tab active">Général</div><div className="tab">Utilisateurs</div><div className="tab">Établissements</div><div className="tab">Intégrations</div></div>
    <div className="cg">
      <div className="card">
        <div className="card-h"><div><div className="card-t">Établissements</div></div></div>
        <div className="card-b">
          <div style={{padding:'14px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div><div style={{fontWeight:600}}>IMA — Val d'Isère</div><div style={{fontSize:11,color:'var(--gris-400)'}}>Restaurant gastronomique & bar</div></div>
            <span className="badge b-ok">Actif</span>
          </div>
          <div style={{padding:'14px 0',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div><div style={{fontWeight:600,color:'var(--gris-400)'}}>IMA — Saint-Tropez</div><div style={{fontSize:11,color:'var(--gris-400)'}}>Ouverture prévue été 2026</div></div>
            <span className="badge b-warn">En préparation</span>
          </div>
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Intégrations</div></div></div>
        <div className="card-b">
          {[{n:'Trivec',d:'Caisses & POS',c:'T',bg:'var(--bordeaux-10)',co:'var(--bordeaux)',key:'trivec'},
            {n:'SevenRooms',d:'CRM & Réservations',c:'7R',bg:'var(--bleu-light)',co:'var(--bleu)',key:'sevenrooms'},
            {n:'Pennylane',d:'Comptabilité & Factures',c:'PL',bg:'var(--vert-light)',co:'var(--vert)',key:'pennylane'}
          ].map((x,i)=>(
            <div key={x.key} style={{padding:'10px 0',borderBottom:i<2?'1px solid var(--gris-100)':'none',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div style={{display:'flex',alignItems:'center',gap:10}}>
                <div style={{width:34,height:34,borderRadius:8,background:x.bg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:x.co}}>{x.c}</div>
                <div><div style={{fontWeight:500,fontSize:13}}>{x.n}</div><div style={{fontSize:10,color:'var(--gris-400)'}}>{x.d}</div></div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <div className={`status-indicator ${connectedIntegrations[x.key]?'connected':'disconnected'}`}/>
                <span className={`badge ${connectedIntegrations[x.key]?'b-ok':'b-err'}`}>{connectedIntegrations[x.key]?'Connecté':'Déconnecté'}</span>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="card">
        <div className="card-h"><div><div className="card-t">Configuration Pennylane</div><div className="card-st">API Token</div></div></div>
        <div className="card-b">
          <div className="fg">
            <label className="fl">Token API Pennylane</label>
            <div className="pw-toggle">
              <input className="fi" type={showToken?'text':'password'} value={token} onChange={(e)=>setToken(e.target.value)} placeholder="Collez votre token ici"/>
              <button className="pw-toggle-btn" onClick={()=>setShowToken(!showToken)}>{showToken?'Masquer':'Afficher'}</button>
            </div>
            <div style={{fontSize:10,color:'var(--gris-400)',marginTop:4}}>Trouvez votre token dans les paramètres de votre compte Pennylane</div>
          </div>
          <div className="input-with-btn" style={{marginBottom:8}}>
            <button className="btn btn-primary" onClick={handleSaveToken}>Enregistrer le token</button>
            <button className="btn btn-secondary" onClick={handleTestConnection} disabled={testing}>{testing?'Test en cours...':'Tester la connexion'}</button>
          </div>
          {testStatus&&<div className={testStatus.success?'success-msg':'error-msg'}>
            {testing&&<span className="spinner" style={{marginRight:6,verticalAlign:'middle'}}/>}
            {testStatus.msg}
          </div>}
          {companyInfo&&<div style={{marginTop:12,padding:14,background:'var(--vert-light)',borderRadius:8,fontSize:12}}>
            <div style={{fontWeight:600,color:'var(--vert)',marginBottom:6}}>Compte connecté</div>
            {(()=>{
              const c=companyInfo.company||companyInfo;
              const u=companyInfo.user||companyInfo;
              const nom=c.name||c.company_name||c.legal_name||'';
              const siren=c.reg_no||c.siren||c.registration_number||'';
              const email=u.email||'';
              const userName=[u.first_name,u.last_name].filter(Boolean).join(' ');
              return(<div>
                {nom?<div><strong>Société :</strong> {nom}</div>:null}
                {siren?<div><strong>SIREN :</strong> {siren}</div>:null}
                {userName?<div><strong>Utilisateur :</strong> {userName}</div>:null}
                {email?<div><strong>Email :</strong> {email}</div>:null}
                {!nom&&!userName?<div style={{color:'var(--vert)'}}>Connexion API OK</div>:null}
              </div>);
            })()}
          </div>}
          {token&&<button className="btn btn-secondary" onClick={handleClearToken} style={{marginTop:8}}>Supprimer le token</button>}
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Import Trivec</div><div className="card-st">Fichiers Excel quotidiens</div></div>
          {trivecDays>0&&<span className="badge b-ok">{trivecDays} jour(s) importé(s)</span>}
        </div>
        <div className="card-b">
          <div style={{marginBottom:16,padding:14,background:'var(--gris-50)',borderRadius:8,fontSize:12,color:'var(--gris-600)'}}>
            Importez les fichiers Excel envoyés par Trivec par email. Deux types de rapports sont supportés :
            <ul style={{margin:'8px 0 0 16px',listStyle:'disc'}}>
              <li><strong>Suivi d'activité Journalier</strong> — CA, paiements, couverts, comptes internes</li>
              <li><strong>Rapport Assortiments de Produits</strong> — Détail des ventes par produit</li>
            </ul>
          </div>
          <div style={{display:'flex',gap:10,marginBottom:12,flexWrap:'wrap'}}>
            <input ref={trivecFileRef} type="file" accept=".xlsx,.xls" multiple style={{display:'none'}} onChange={e=>handleTrivecImport(e,'suivi')}/>
            <button className="btn btn-primary" onClick={()=>trivecFileRef.current?.click()} disabled={trivecImporting}>
              {trivecImporting?'Import en cours...':'Importer Suivi Journalier'}
            </button>
            <input ref={trivecAssortRef} type="file" accept=".xlsx,.xls" multiple style={{display:'none'}} onChange={e=>handleTrivecImport(e,'assortiment')}/>
            <button className="btn btn-secondary" onClick={()=>trivecAssortRef.current?.click()} disabled={trivecImporting}>
              Importer Assortiments
            </button>
          </div>
          {trivecStatus&&<div className={trivecStatus.success?'success-msg':'error-msg'} style={{marginBottom:10}}>{trivecStatus.msg}</div>}
          {trivecDays>0&&<div style={{marginTop:8}}>
            <div style={{fontSize:12,fontWeight:600,marginBottom:8}}>Jours importés :</div>
            <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
              {Object.keys(TrivecService.getAllDays()).sort((a,b)=>{const pa=a.split('/').reverse().join('');const pb=b.split('/').reverse().join('');return pb.localeCompare(pa);}).map(d=>{
                const day=TrivecService.getDay(d);
                return<div key={d} style={{padding:'4px 10px',background:'var(--bordeaux-10)',borderRadius:6,fontSize:11,display:'flex',alignItems:'center',gap:6}}>
                  <span style={{fontWeight:600}}>{d}</span>
                  <span style={{color:'var(--gris-500)'}}>CA: {(day.caTotal||0).toLocaleString('fr-FR')}€</span>
                </div>;
              })}
            </div>
            <button className="btn btn-secondary" style={{marginTop:10,fontSize:10}} onClick={()=>{if(confirm('Supprimer toutes les données Trivec ?')){TrivecService.clearAll();setTrivecDays(0);setConnectedIntegrations(p=>({...p,trivec:false}));}}}>Réinitialiser les données Trivec</button>
          </div>}
          {TrivecService.getLastImport()&&<div style={{fontSize:10,color:'var(--gris-400)',marginTop:8}}>Dernier import : {new Date(TrivecService.getLastImport()).toLocaleString('fr-FR')}</div>}
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Utilisateurs du dashboard</div><div className="card-st">{UserManager.getAll().length} compte(s)</div></div>
          <button className="btn btn-sm btn-primary" onClick={()=>setShowInviteModal(true)}>+ Inviter</button>
        </div>
        <div className="card-b">
          {UserManager.getAll().map((u,i,arr)=>(
            <div key={u.id} style={{padding:'10px 0',borderBottom:i<arr.length-1?'1px solid var(--gris-100)':'none',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div style={{display:'flex',alignItems:'center',gap:10}}>
                <div style={{width:32,height:32,borderRadius:'50%',background:'var(--bordeaux)',color:'white',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:600}}>{u.nom?u.nom[0]:'?'}</div>
                <div>
                  <div style={{fontWeight:500,fontSize:13}}>{u.nom}</div>
                  <div style={{fontSize:10,color:'var(--gris-400)'}}>{u.email}</div>
                </div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <span className="badge b-ima">{u.role}</span>
                {u.lastLogin&&<span style={{fontSize:9,color:'var(--gris-400)'}}>Vu {new Date(u.lastLogin).toLocaleDateString('fr-FR')}</span>}
                {UserManager.getAll().length>1&&u.email!==UserManager.getCurrentUser()?.email&&
                  <button className="btn btn-sm" style={{background:'var(--rouge-light)',color:'var(--rouge)',border:'none',padding:'3px 6px',fontSize:9,cursor:'pointer'}} onClick={()=>{if(confirm(`Supprimer ${u.nom} ?`)){UserManager.removeUser(u.id);setInviteStatus({success:true,msg:'Utilisateur supprimé'});}}}>Supprimer</button>
                }
              </div>
            </div>
          ))}
        </div>
      </div>
      {showInviteModal&&<div className="modal-overlay" onClick={()=>setShowInviteModal(false)}>
        <div className="modal" onClick={e=>e.stopPropagation()}>
          <h3>Inviter un utilisateur <button className="modal-close" onClick={()=>setShowInviteModal(false)}>×</button></h3>
          <div className="fg" style={{marginBottom:12}}>
            <label className="fl">Nom complet</label>
            <input className="fi" value={inviteData.nom} onChange={e=>setInviteData(p=>({...p,nom:e.target.value}))} placeholder="Prénom Nom"/>
          </div>
          <div className="fg" style={{marginBottom:12}}>
            <label className="fl">Email</label>
            <input className="fi" type="email" value={inviteData.email} onChange={e=>setInviteData(p=>({...p,email:e.target.value}))} placeholder="email@ima-club.com"/>
          </div>
          <div className="fg-row" style={{marginBottom:12}}>
            <div className="fg">
              <label className="fl">Rôle</label>
              <select className="fi-select" value={inviteData.role} onChange={e=>setInviteData(p=>({...p,role:e.target.value}))}>
                <option value="Admin">Admin</option>
                <option value="Directeur">Directeur</option>
                <option value="Comptable">Comptable (lecture seule)</option>
                <option value="Viewer">Viewer</option>
              </select>
            </div>
            <div className="fg">
              <label className="fl">Mot de passe temporaire</label>
              <input className="fi" value={inviteData.password} onChange={e=>setInviteData(p=>({...p,password:e.target.value}))} placeholder="Généré auto"/>
            </div>
          </div>
          {inviteStatus&&<div className={inviteStatus.success?'success-msg':'error-msg'} style={{marginBottom:10}}>{inviteStatus.msg}</div>}
          <div style={{display:'flex',gap:10,justifyContent:'flex-end'}}>
            <button className="btn btn-secondary" onClick={()=>setShowInviteModal(false)}>Annuler</button>
            <button className="btn btn-primary" onClick={handleInviteUser}>Envoyer l'invitation</button>
          </div>
        </div>
      </div>}
      <div className="card">
        <div className="card-h"><div><div className="card-t">Objectifs & Seuils</div></div></div>
        <div className="card-b">
          {(()=>{
            const tm=TrivecService.getMonthData();
            const ca=tm.totalCA||0;
            const hasCa=ca>0;
            const tmVal=tm.ticketMoyen||0;
            // Aggregate Trivec products for COGS
            const data=TrivecService._getData();
            const assorts=data.assortiments||{};
            const pMap={};
            for(const[ds,assort]of Object.entries(assorts)){
              (assort.products||[]).forEach(p=>{
                const k=p.nom;
                if(!pMap[k])pMap[k]={nom:p.nom,categorie1:p.categorie1,categorie2:p.categorie2,categorie3:p.categorie3,totalQty:0,totalPrix:0,jours:[]};
                pMap[k].totalQty+=p.quantite;pMap[k].totalPrix+=p.prix;
              });
            }
            const trivecProds=Object.values(pMap);
            const cogs=InventoryService.calculateCOGS(trivecProds);
            const hasFood=cogs.foodCostPct!==null;
            const hasBar=cogs.barCostPct!==null;
            return[
              {l:'Food Cost max',o:'28%',a:hasFood?cogs.foodCostPct+'%':'—',ok:hasFood?(cogs.foodCostPct<=28?true:false):null},
              {l:'Bar Cost max',o:'20%',a:hasBar?cogs.barCostPct+'%':'—',ok:hasBar?(cogs.barCostPct<=20?true:false):null},
              {l:'Staff Cost max',o:'30%',a:hasCa?'—':'—',ok:null},
              {l:'Prime Cost max',o:'65%',a:cogs.primeCostPct!==null?cogs.primeCostPct+'%':'—',ok:cogs.primeCostPct!==null?(cogs.primeCostPct<=65?true:false):null},
              {l:'Ticket moyen min',o:'180€',a:hasCa?Math.round(tmVal)+'€':'—',ok:hasCa?(tmVal>=180?true:false):null}
            ];
          })().map((o,i)=>(
            <div key={i} style={{padding:'8px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:13}}>
              <div>{o.l}</div>
              <div style={{display:'flex',gap:14,alignItems:'center'}}>
                <span style={{color:'var(--gris-500)'}}>Obj: {o.o}</span>
                <span style={{fontWeight:600}}>Actuel: {o.a}</span>
                {o.ok!==null&&<span className={`badge ${o.ok?'b-ok':'b-warn'}`}>{o.ok?'OK':'Attention'}</span>}{o.ok===null&&<span className="badge" style={{background:'var(--gris-100)',color:'var(--gris-500)'}}>En attente</span>}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>);
}

// ===== APP =====
function App(){
  const[currentUser,setCurrentUser]=useState(()=>UserManager.getCurrentUser());
  const[page,setPage]=useState('dashboard');
  const[period,setPeriod]=useState('mois');

  const handleLogin=(user)=>{setCurrentUser({id:user.id,nom:user.nom,email:user.email,role:user.role});};
  const handleLogout=()=>{UserManager.logout();setCurrentUser(null);};

  const nav=[
    {sec:'Pilotage',items:[
      {id:'dashboard',l:'Dashboard',ic:<I.Dash/>},
      {id:'finance',l:'Finance & P&L',ic:<I.Fin/>},
      {id:'costs',l:'Food & Bar Cost',ic:<I.Cost/>},
      {id:'staff',l:'Staff & RH',ic:<I.Staff/>},
    ]},
    {sec:'Opérations',items:[
      {id:'stocks',l:'Stocks',ic:<I.Stock/>},
      {id:'crm',l:'CRM & Réservations',ic:<I.CRM/>},
      {id:'pos',l:'Caisses (Trivec)',ic:<I.POS/>},
      {id:'caisse',l:'Clôture Caisse',ic:<I.Cash/>},
      {id:'tips',l:'Tips & Pourboires',ic:<I.Tips/>},
    ]},
    {sec:'Système',items:[
      {id:'settings',l:'Administration',ic:<I.Gear/>},
    ]},
  ];

  const titles={dashboard:'Dashboard',finance:'Finance & P&L',costs:'Food & Bar Cost',staff:'Staff & RH',stocks:'Stocks & Inventaire',crm:'CRM & Réservations',pos:'Caisses (Trivec)',caisse:'Clôture de Caisse',tips:'Tips & Pourboires',settings:'Administration'};

  if(!currentUser) return <Login onLogin={handleLogin}/>;

  const P=()=>{switch(page){
    case 'dashboard':return <Dashboard/>;case 'finance':return <Finance/>;case 'costs':return <Costs/>;
    case 'staff':return <StaffPage/>;case 'stocks':return <Stocks/>;case 'crm':return <CRMPage/>;
    case 'pos':return <POSPage/>;case 'caisse':return <CaissePage/>;case 'tips':return <TipsPage/>;case 'settings':return <Settings/>;default:return <Dashboard/>;
  }};

  return(
    <div className="app">
      <aside className="sidebar">
        <div className="sidebar-logo"><h1>IMa</h1><span>Tour de contrôle</span></div>
        <nav className="sidebar-nav">
          {nav.map(s=>(
            <div className="nav-sec" key={s.sec}>
              <div className="nav-sec-title">{s.sec}</div>
              {s.items.map(it=>(
                <div key={it.id} className={`nav-item ${page===it.id?'active':''}`} onClick={()=>setPage(it.id)}>
                  {it.ic}{it.l}
                </div>
              ))}
            </div>
          ))}
        </nav>
        <div className="sidebar-foot" style={{cursor:'pointer'}} onClick={handleLogout} title="Se déconnecter">
          <div className="avatar">{currentUser.nom?currentUser.nom.split(' ').map(w=>w[0]).join(''):'?'}</div>
          <div style={{flex:1}}><div className="uname">{currentUser.nom}</div><div className="urole">{currentUser.role}</div></div>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.5)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </div>
      </aside>
      <main className="main">
        <header className="header">
          <div className="header-l"><h2>{titles[page]}</h2><span className="bc">Février 2026</span></div>
          <div className="header-r">
            <div className="per">
              {['jour','semaine','mois','année'].map(p=>(
                <button key={p} className={`per-btn ${period===p?'active':''}`} onClick={()=>setPeriod(p)}>{p[0].toUpperCase()+p.slice(1)}</button>
              ))}
            </div>
            <div className="loc"><I.Pin/><div className="loc-dot"/>Val d'Isère<I.Chev/></div>
            <div className="notif"><I.Bell/></div>
          </div>
        </header>
        <div className="page"><P/></div>
      </main>
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
