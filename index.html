<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMA Dashboard ‚Äî Tour de Contr√¥le</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bordeaux: #581527;
      --bordeaux-light: #7a2d42;
      --bordeaux-dark: #3d0e1b;
      --bordeaux-10: rgba(88,21,39,0.1);
      --bordeaux-20: rgba(88,21,39,0.2);
      --blanc: #FFFFFF;
      --gris-50: #f9fafb; --gris-100: #f3f4f6; --gris-200: #e5e7eb;
      --gris-300: #d1d5db; --gris-400: #9ca3af; --gris-500: #6b7280;
      --gris-600: #4b5563; --gris-700: #374151; --gris-800: #1f2937; --gris-900: #111827;
      --vert: #059669; --vert-light: #d1fae5;
      --rouge: #dc2626; --rouge-light: #fee2e2;
      --orange: #d97706; --orange-light: #fef3c7;
      --bleu: #2563eb; --bleu-light: #dbeafe;
      --sidebar-w: 256px;
    }
    body { font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--gris-50); color:var(--gris-900); line-height:1.5; -webkit-font-smoothing:antialiased; }
    ::-webkit-scrollbar{width:5px} ::-webkit-scrollbar-track{background:transparent} ::-webkit-scrollbar-thumb{background:var(--gris-300);border-radius:3px}

    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{width:var(--sidebar-w);background:var(--bordeaux);color:var(--blanc);position:fixed;top:0;left:0;bottom:0;display:flex;flex-direction:column;z-index:50}
    .sidebar-logo{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;gap:2px}
    .sidebar-logo h1{font-size:32px;font-weight:300;letter-spacing:6px}
    .sidebar-logo span{font-size:10px;opacity:.5;letter-spacing:2px;text-transform:uppercase}
    .sidebar-nav{flex:1;padding:16px 10px;overflow-y:auto}
    .nav-sec{margin-bottom:20px}
    .nav-sec-title{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.35);padding:0 12px;margin-bottom:6px;font-weight:600}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;transition:all .15s;font-size:13px;color:rgba(255,255,255,.65);font-weight:400;margin-bottom:1px}
    .nav-item:hover{background:rgba(255,255,255,.08);color:var(--blanc)}
    .nav-item.active{background:rgba(255,255,255,.14);color:var(--blanc);font-weight:500}
    .nav-item svg{width:17px;height:17px;opacity:.75;flex-shrink:0}
    .nav-item.active svg{opacity:1}
    .sidebar-foot{padding:14px 18px;border-top:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:10px}
    .avatar{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600}
    .uname{font-size:13px;font-weight:500}
    .urole{font-size:10px;opacity:.5}

    /* Main */
    .main{margin-left:var(--sidebar-w);flex:1;min-height:100vh}
    .header{background:var(--blanc);border-bottom:1px solid var(--gris-200);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40}
    .header-l{display:flex;align-items:center;gap:14px}
    .header-l h2{font-size:18px;font-weight:600}
    .header-l .bc{font-size:12px;color:var(--gris-400)}
    .header-r{display:flex;align-items:center;gap:14px}
    .loc{display:flex;align-items:center;gap:6px;background:var(--gris-100);padding:7px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;border:1px solid var(--gris-200)}
    .loc:hover{border-color:var(--bordeaux)}
    .loc-dot{width:7px;height:7px;border-radius:50%;background:var(--vert)}
    .per{display:flex;background:var(--gris-100);border-radius:7px;padding:2px;border:1px solid var(--gris-200)}
    .per-btn{padding:5px 12px;border-radius:5px;font-size:11px;font-weight:500;cursor:pointer;border:none;background:transparent;color:var(--gris-500);font-family:inherit}
    .per-btn.active{background:var(--blanc);color:var(--bordeaux);box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .page{padding:22px 28px}

    /* Cards */
    .card{background:var(--blanc);border-radius:12px;border:1px solid var(--gris-200);margin-bottom:16px;overflow:hidden}
    .card-h{padding:18px 22px 0;display:flex;justify-content:space-between;align-items:flex-start}
    .card-t{font-size:14px;font-weight:600;color:var(--gris-800)}
    .card-st{font-size:11px;color:var(--gris-400);margin-top:2px}
    .card-b{padding:14px 22px 18px}

    /* KPI */
    .kpi-g{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
    .kpi{background:var(--blanc);border:1px solid var(--gris-200);border-radius:12px;padding:18px;transition:all .2s}
    .kpi:hover{border-color:var(--bordeaux-20);box-shadow:0 4px 12px rgba(88,21,39,.06)}
    .kpi-label{font-size:11px;font-weight:500;color:var(--gris-500);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
    .kpi-val{font-size:26px;font-weight:700;line-height:1.2}
    .kpi-chg{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:500;margin-top:6px;padding:2px 8px;border-radius:20px}
    .kpi-chg.pos{color:var(--vert);background:var(--vert-light)}
    .kpi-chg.neg{color:var(--rouge);background:var(--rouge-light)}
    .kpi-chg.neu{color:var(--orange);background:var(--orange-light)}

    /* Charts grid */
    .cg{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:20px}
    .cg .fw{grid-column:1/-1}

    /* Bar chart CSS */
    .bars{display:flex;align-items:flex-end;gap:8px;height:180px;padding-top:10px}
    .bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
    .bar-stack{width:100%;display:flex;flex-direction:column;justify-content:flex-end;height:160px;gap:1px}
    .bar-seg{border-radius:3px 3px 0 0;transition:height .5s ease;min-height:0;position:relative}
    .bar-seg:hover{opacity:.85}
    .bar-lbl{font-size:10px;color:var(--gris-500);font-weight:500}
    .bar-val{font-size:9px;color:var(--gris-400);text-align:center}

    /* Line chart CSS */
    .line-chart{position:relative;height:180px}
    .line-chart svg{width:100%;height:100%}

    /* Donut */
    .donut-wrap{display:flex;align-items:center;justify-content:center;gap:24px;padding:10px 0}
    .donut{position:relative;width:140px;height:140px}
    .donut svg{transform:rotate(-90deg)}
    .donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .donut-center .dv{font-size:22px;font-weight:700}
    .donut-center .dl{font-size:10px;color:var(--gris-500)}
    .donut-legend{display:flex;flex-direction:column;gap:8px}
    .donut-legend-item{display:flex;align-items:center;gap:8px;font-size:12px}
    .donut-legend-dot{width:10px;height:10px;border-radius:3px}

    /* Cost cards */
    .cost-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
    .cost-c{background:var(--blanc);border:1px solid var(--gris-200);border-radius:12px;padding:20px;text-align:center}
    .cost-c .cl{font-size:12px;color:var(--gris-500);margin-bottom:6px;font-weight:500}
    .cost-c .cv{font-size:32px;font-weight:700;color:var(--bordeaux)}
    .cost-c .ct{font-size:11px;color:var(--gris-400);margin-top:4px}
    .pbar{height:6px;background:var(--gris-100);border-radius:3px;overflow:hidden;margin-top:8px}
    .pfill{height:100%;border-radius:3px;transition:width .5s ease}

    /* Tables */
    .tbl{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:10px 14px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--gris-500);border-bottom:1px solid var(--gris-200);background:var(--gris-50)}
    td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--gris-100);color:var(--gris-700)}
    tr:hover td{background:var(--gris-50)}

    /* Badges */
    .badge{display:inline-flex;align-items:center;padding:2px 9px;border-radius:20px;font-size:10px;font-weight:500}
    .b-ok{background:var(--vert-light);color:var(--vert)}
    .b-err{background:var(--rouge-light);color:var(--rouge)}
    .b-warn{background:var(--orange-light);color:var(--orange)}
    .b-info{background:var(--bleu-light);color:var(--bleu)}
    .b-ima{background:var(--bordeaux-10);color:var(--bordeaux)}

    /* Tabs */
    .tabs{display:flex;border-bottom:1px solid var(--gris-200);margin-bottom:20px}
    .tab{padding:10px 18px;font-size:13px;font-weight:500;color:var(--gris-500);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
    .tab:hover{color:var(--gris-700)}
    .tab.active{color:var(--bordeaux);border-bottom-color:var(--bordeaux)}

    /* Alert items */
    .alert-i{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-radius:8px;margin-bottom:6px;font-size:12px}
    .alert-i.a-err{background:var(--rouge-light)}
    .alert-i.a-warn{background:var(--orange-light)}
    .alert-i.a-info{background:var(--bleu-light)}
    .alert-i .at{font-weight:500;font-size:13px}
    .alert-i .as{font-size:11px;opacity:.7;margin-top:2px}

    /* Reservation item */
    .resa{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--gris-100)}
    .resa:last-child{border:none}
    .resa-l{display:flex;align-items:center;gap:10px}
    .resa-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--blanc)}
    .resa-name{font-size:13px;font-weight:500}
    .resa-det{font-size:11px;color:var(--gris-400)}
    .resa-r{text-align:right}
    .resa-time{font-size:14px;font-weight:600;color:var(--gris-700)}
    .resa-pax{font-size:11px;color:var(--gris-400)}

    /* Notif */
    .notif{position:relative;cursor:pointer;padding:6px}
    .notif::after{content:'3';position:absolute;top:0;right:0;width:15px;height:15px;border-radius:50%;background:var(--rouge);color:white;font-size:8px;display:flex;align-items:center;justify-content:center;font-weight:700}

    /* Login */
    .login{min-height:100vh;display:flex;background:var(--bordeaux)}
    .login-c{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px}
    .login-logo{font-size:64px;font-weight:300;letter-spacing:12px;color:var(--blanc);margin-bottom:6px}
    .login-tag{font-size:12px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.45);margin-bottom:40px}
    .login-form{width:100%;max-width:360px;background:var(--blanc);border-radius:14px;padding:36px}
    .login-form h3{font-size:18px;font-weight:600;margin-bottom:20px}
    .fg{margin-bottom:16px}
    .fl{display:block;font-size:11px;font-weight:500;color:var(--gris-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
    .fi{width:100%;padding:10px 14px;border:1px solid var(--gris-200);border-radius:8px;font-size:14px;font-family:inherit;outline:none;transition:all .15s}
    .fi:focus{border-color:var(--bordeaux);box-shadow:0 0 0 3px var(--bordeaux-10)}
    .login-btn{width:100%;padding:11px;background:var(--bordeaux);color:var(--blanc);border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;letter-spacing:.5px;transition:all .15s}
    .login-btn:hover{background:var(--bordeaux-light)}

    /* Anim */
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .fin{animation:fadeIn .3s ease}

    /* Modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:100}
    .modal{background:var(--blanc);border-radius:14px;padding:28px;width:480px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
    .modal h3{font-size:17px;font-weight:600;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center}
    .modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--gris-400);padding:4px 8px}
    .modal-close:hover{color:var(--gris-700)}
    .fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;border:none;transition:all .15s}
    .btn-primary{background:var(--bordeaux);color:var(--blanc)}
    .btn-primary:hover{background:var(--bordeaux-light)}
    .btn-secondary{background:var(--gris-100);color:var(--gris-700);border:1px solid var(--gris-200)}
    .btn-secondary:hover{background:var(--gris-200)}
    .btn-sm{padding:6px 12px;font-size:11px}

    /* Tips table */
    .tips-grid{overflow-x:auto}
    .tips-grid table th,.tips-grid table td{padding:8px 10px;font-size:12px;text-align:center;white-space:nowrap}
    .tips-grid table th{font-size:10px}
    .tips-grid table td input{width:55px;padding:4px 6px;border:1px solid var(--gris-200);border-radius:5px;font-size:12px;text-align:center;font-family:inherit;outline:none}
    .tips-grid table td input:focus{border-color:var(--bordeaux);box-shadow:0 0 0 2px var(--bordeaux-10)}
    .tips-grid .day-header{background:var(--bordeaux);color:white;font-weight:600;font-size:11px}
    .tips-grid .total-row td{background:var(--gris-50);font-weight:700;border-top:2px solid var(--gris-300)}
    .tips-grid .penalty-cell{color:var(--rouge);font-weight:600}
    .tips-grid .bonus-cell{color:var(--vert);font-weight:600}
    .presence-dot{width:20px;height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;font-weight:700;transition:all .15s}
    .presence-dot.present{background:var(--vert-light);color:var(--vert)}
    .presence-dot.absent{background:var(--rouge-light);color:var(--rouge)}

    /* Select */
    .fi-select{width:100%;padding:10px 14px;border:1px solid var(--gris-200);border-radius:8px;font-size:14px;font-family:inherit;outline:none;background:var(--blanc);transition:all .15s;appearance:none;cursor:pointer}
    .fi-select:focus{border-color:var(--bordeaux);box-shadow:0 0 0 3px var(--bordeaux-10)}

    /* Pennylane Integration */
    .toggle-group{display:flex;gap:8px;align-items:center}
    .toggle-btn{padding:6px 14px;border-radius:6px;border:1px solid var(--gris-200);background:var(--blanc);color:var(--gris-600);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s}
    .toggle-btn.active{background:var(--bordeaux);color:var(--blanc);border-color:var(--bordeaux)}
    .toggle-btn:hover{border-color:var(--bordeaux)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--gris-200);border-top-color:var(--bordeaux);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status-indicator{width:10px;height:10px;border-radius:50%;display:inline-block}
    .status-indicator.connected{background:var(--vert)}
    .status-indicator.disconnected{background:var(--rouge)}
    .pw-toggle{position:relative;display:inline-flex;align-items:center}
    .pw-toggle-btn{background:none;border:none;cursor:pointer;padding:4px;color:var(--gris-500);margin-left:4px}
    .pw-toggle-btn:hover{color:var(--gris-700)}
    .input-with-btn{display:flex;gap:8px}
    .input-with-btn input{flex:1}
    .input-with-btn button{min-width:120px}
    .error-msg{color:var(--rouge);font-size:11px;margin-top:4px}
    .success-msg{color:var(--vert);font-size:11px;margin-top:4px}

    @media(max-width:1100px){.cg{grid-template-columns:1fr}.kpi-g{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useMemo}=React;

// ===== SVG ICONS =====
const I={
  Dash:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>,
  Fin:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
  Cost:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
  Staff:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  Stock:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>,
  CRM:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  POS:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>,
  Gear:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
  Bell:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
  Up:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
  Down:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
  Chev:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>,
  Pin:()=><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
  Warn:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  Cash:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><circle cx="9" cy="10" r="1"/><path d="M15 10h.01"/></svg>,
  Tips:()=><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
};

// ===== FORMATTERS =====
const fmt=n=>new Intl.NumberFormat('fr-FR').format(n);
const eur=n=>new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n);

// ===== SUPPLIER MAPPING =====
// Professional restaurant cost categories with grouping
const COST_GROUPS={
  'Co√ªts Directs (Prime Cost)':{
    color:'var(--bordeaux)',cats:['Food','Bar','Staff'],
    desc:'Mati√®res premi√®res + masse salariale'
  },
  'Charges d\'Exploitation':{
    color:'var(--orange)',cats:['Hygi√®ne & Entretien','√ânergie & Fluides','Mat√©riel & √âquipement','Travaux & Maintenance','Blanchisserie'],
    desc:'Co√ªts op√©rationnels du restaurant'
  },
  'Charges G√©n√©rales (G&A)':{
    color:'var(--bleu)',cats:['Loyer & Charges','Communication & Marketing','Administratif & Juridique','Transport & V√©hicules','Assurances','IT & Logiciels','Divers'],
    desc:'Frais g√©n√©raux et administratifs'
  },
  'Hors Exploitation':{
    color:'var(--gris-500)',cats:['Compte courant associ√©','Investissements','Non class√©'],
    desc:'Op√©rations hors exploitation courante'
  }
};

const ALL_CATEGORIES=Object.values(COST_GROUPS).flatMap(g=>g.cats);
const CAT_COLORS={
  'Food':'#059669','Bar':'#581527','Staff':'#2563eb',
  'Hygi√®ne & Entretien':'#d97706','√ânergie & Fluides':'#dc2626','Mat√©riel & √âquipement':'#7c3aed',
  'Travaux & Maintenance':'#b45309','Blanchisserie':'#0891b2',
  'Loyer & Charges':'#475569','Communication & Marketing':'#c026d3','Administratif & Juridique':'#64748b',
  'Transport & V√©hicules':'#374151','Assurances':'#6b7280','IT & Logiciels':'#4f46e5','Divers':'#9ca3af',
  'Compte courant associ√©':'#374151','Investissements':'#1e293b','Non class√©':'#dc2626'
};

// Get the group name for a category
function getCatGroup(cat){
  for(const[group,info]of Object.entries(COST_GROUPS)){
    if(info.cats.includes(cat))return group;
  }
  return'Hors Exploitation';
}

const SupplierMap={
  CATEGORIES:ALL_CATEGORIES,

  _getMap(){
    try{return JSON.parse(localStorage.getItem('ima_supplier_map_v2')||'{}');}catch(e){return{};}
  },
  _saveMap(map){localStorage.setItem('ima_supplier_map_v2',JSON.stringify(map));},

  getCategory(supplierId){
    const map=this._getMap();
    return map[supplierId]||'Non class√©';
  },

  setCategory(supplierId,category){
    const map=this._getMap();
    map[supplierId]=category;
    this._saveMap(map);
  },

  getAll(){return this._getMap();},

  extractName(invoice){
    const label=invoice.label||'';
    // Try to match: "Facture SUPPLIER_NAME - INVOICE_NUMBER (label g√©n√©r√©)"
    const match=label.match(/^(?:Facture|Avoir)\s+(.+?)\s+-\s+(?:AVOIR\s+)?(?:VTE-)?[\w\/\-\.]+\s*(?:\(label|\-\s*[\d,\.]+\s*CHF)/i);
    if(match)return match[1].trim();
    // Simpler fallback
    const m2=label.match(/^(?:Facture|Avoir)\s+(.+?)\s+-\s+/i);
    if(m2)return m2[1].trim();
    return label.replace(/^(Facture|Avoir)\s+/i,'').replace(/\s*\(label.*$/,'').trim()||'Inconnu';
  },

  initDefaults(){
    const map=this._getMap();
    const defaults={
      '135128272':'Food','225921410':'Food',
      '135131297':'Bar',
      '138286809':'Travaux & Maintenance','213706779':'Travaux & Maintenance',
      '135132417':'Hygi√®ne & Entretien','150618374':'Hygi√®ne & Entretien',
      '157926754':'Transport & V√©hicules',
      '148604506':'Mat√©riel & √âquipement',
      '135731681':'Communication & Marketing',
      '138599892':'Food',
      '135731679':'Compte courant associ√©',
    };
    let changed=false;
    for(const[id,cat]of Object.entries(defaults)){
      if(!map[id]){map[id]=cat;changed=true;}
    }
    if(changed)this._saveMap(map);
    return map;
  },

  categorize(invoices){
    const result={};
    ALL_CATEGORIES.forEach(c=>{result[c]=[];});
    invoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      const cat=this.getCategory(sid);
      if(!result[cat])result[cat]=[];
      result[cat].push(inv);
    });
    return result;
  },

  getTotals(invoices){
    const totals={};
    ALL_CATEGORIES.forEach(c=>{totals[c]=0;});
    invoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      const cat=this.getCategory(sid);
      totals[cat]=(totals[cat]||0)+parseFloat(inv.amount||0);
    });
    return totals;
  },

  getGroupTotals(totals){
    const groupTotals={};
    for(const[group,info]of Object.entries(COST_GROUPS)){
      groupTotals[group]=info.cats.reduce((s,c)=>s+(totals[c]||0),0);
    }
    return groupTotals;
  }
};

SupplierMap.initDefaults();

// ===== STAFF REGISTRY =====
const TIP_CATEGORIES={
  salle:{
    MANAGERS:{label:'Managers',defaultPoints:5,color:'var(--bordeaux)'},
    FLOOR:{label:'Floor',defaultPoints:4,color:'var(--orange)'},
    COMMIS:{label:'Commis',defaultPoints:2,color:'var(--bleu)'},
    BAR:{label:'Bar',defaultPoints:4,color:'#7c3aed'},
    HOTESSE:{label:'H√¥tesse / Com',defaultPoints:1,color:'var(--gris-500)'}
  },
  cuisine:{
    CHEF:{label:'Chef & Sous-chefs',defaultPoints:2,color:'var(--vert)'}
  }
};

const StaffRegistry={
  _getAll(){
    try{return JSON.parse(localStorage.getItem('ima_staff_v1')||'[]');}catch(e){return[];}
  },
  _saveAll(list){localStorage.setItem('ima_staff_v1',JSON.stringify(list));},

  getAll(){return this._getAll();},
  getActive(){return this._getAll().filter(e=>e.active!==false);},
  getById(id){return this._getAll().find(e=>e.id===id);},

  getBySectionAndCategory(section,tipCategory){
    return this.getActive().filter(e=>e.section===section&&e.tipCategory===tipCategory);
  },
  getBySection(section){
    return this.getActive().filter(e=>e.section===section);
  },

  getTipsEligible(){return this.getActive().filter(e=>e.tips);},

  getResponsables(){return this.getActive().filter(e=>['Chef de cuisine','Resp. salle','Chef barman','Directeur','Manager'].includes(e.poste)||e.tipCategory==='MANAGERS');},

  add(employee){
    const all=this._getAll();
    const newEmp={
      id:Date.now(),
      nom:employee.nom||'',
      poste:employee.poste||'',
      section:employee.section||'salle',
      tipCategory:employee.tipCategory||'FLOOR',
      points:employee.points||TIP_CATEGORIES[employee.section||'salle']?.[employee.tipCategory||'FLOOR']?.defaultPoints||3,
      contrat:employee.contrat||'CDI',
      tel:employee.tel||'',
      dateEntree:employee.dateEntree||new Date().toLocaleDateString('fr-FR'),
      tips:employee.tips!==false,
      active:true,
      coutBrut:employee.coutBrut||0,
      heures:employee.heures||0,
      extras:employee.extras||0,
      ...employee
    };
    all.push(newEmp);
    this._saveAll(all);
    return newEmp;
  },

  update(id,updates){
    const all=this._getAll();
    const idx=all.findIndex(e=>e.id===id);
    if(idx>=0){all[idx]={...all[idx],...updates};this._saveAll(all);}
    return all[idx];
  },

  remove(id){
    const all=this._getAll().filter(e=>e.id!==id);
    this._saveAll(all);
  },

  deactivate(id){this.update(id,{active:false});},

  initDefaults(){
    // No default employees in production
  }
};

StaffRegistry.initDefaults();

// ===== PENNYLANE SERVICE =====
const PennylaneService={
  getToken:()=>localStorage.getItem('ima_pennylane_token'),
  setToken:(token)=>localStorage.setItem('ima_pennylane_token',token),
  clearToken:()=>localStorage.removeItem('ima_pennylane_token'),
  _companyInfo:null,
  _cache:{},

  async request(endpoint,params={}){
    const token=this.getToken();
    const queryString=new URLSearchParams(params).toString();
    const url=`/api/pennylane?endpoint=${encodeURIComponent(endpoint)}${queryString?'&'+queryString:''}`;

    try{
      const headers={'Accept':'application/json'};
      if(token) headers['Authorization']=`Bearer ${token}`;
      const response=await fetch(url,{method:'GET',headers});
      const data=await response.json();
      if(!response.ok){
        throw new Error(data.message||data.error||`Erreur API: ${response.status}`);
      }
      return data;
    }catch(e){
      console.error('Pennylane API error:',e);
      throw e;
    }
  },

  async testConnection(){
    try{
      const data=await this.request('/me');
      this._companyInfo=data;
      return{success:true,company:data};
    }catch(e){
      return{success:false,error:e.message};
    }
  },

  // Fetch ALL supplier invoices with pagination, optional date filter
  async getAllSupplierInvoices({dateFrom,dateTo,maxPages=10}={}){
    const cacheKey=`inv_${dateFrom}_${dateTo}`;
    if(this._cache[cacheKey]&&Date.now()-this._cache[cacheKey].ts<300000)return this._cache[cacheKey].data;

    let allInvoices=[];
    let cursor=null;
    let page=0;
    try{
      while(page<maxPages){
        const params={per_page:100};
        if(dateFrom)params['filter[date]']=`>=${dateFrom}`;
        if(dateTo)params['filter[date]']=`<=${dateTo}`;
        if(cursor)params.cursor=cursor;
        const response=await this.request('/supplier_invoices',params);
        const items=response.items||response.supplier_invoices||response.data||[];
        allInvoices=allInvoices.concat(items);
        if(!response.has_more||!response.next_cursor)break;
        cursor=response.next_cursor;
        page++;
      }
    }catch(e){console.error('Failed to fetch all invoices:',e);}
    // Discover new suppliers
    const map=SupplierMap.getAll();
    allInvoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      if(sid&&!map[sid]){
        SupplierMap.setCategory(sid,'Non class√©');
      }
    });
    this._cache[cacheKey]={data:allInvoices,ts:Date.now()};
    return allInvoices;
  },

  async getSupplierInvoices(params={}){
    try{
      const response=await this.request('/supplier_invoices',{per_page:25,...params});
      return response.items||response.supplier_invoices||response.data||[];
    }catch(e){
      console.error('Failed to fetch supplier invoices:',e);
      return[];
    }
  },

  async getCustomerInvoices(params={}){
    try{
      const response=await this.request('/customer_invoices',{per_page:25,...params});
      return response.items||response.customer_invoices||response.data||[];
    }catch(e){
      console.error('Failed to fetch customer invoices:',e);
      return[];
    }
  },

  async getCategories(){
    try{
      const response=await this.request('/categories');
      return response.categories||response.data||[];
    }catch(e){
      console.error('Failed to fetch categories:',e);
      return[];
    }
  },

  async getMe(){
    try{
      const data=await this.request('/me');
      this._companyInfo=data;
      return data;
    }catch(e){
      return null;
    }
  },

  getCompanyInfo(){return this._companyInfo;}
};

// ===== CSS BAR CHART =====
function BarChart({data,keys,colors,height=180,labels}){
  const max=Math.max(...data.map(d=>keys.reduce((s,k)=>s+(d[k]||0),0)));
  return(
    <div style={{display:'flex',alignItems:'flex-end',gap:6,height,paddingTop:10}}>
      {data.map((d,i)=>(
        <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:3}}>
          <div style={{fontSize:9,color:'var(--gris-400)',fontWeight:500}}>{eur(keys.reduce((s,k)=>s+(d[k]||0),0))}</div>
          <div style={{width:'100%',display:'flex',flexDirection:'column',justifyContent:'flex-end',height:height-30,gap:1}}>
            {keys.map((k,ki)=>{
              const h=max>0?((d[k]||0)/max)*(height-40):0;
              return <div key={ki} style={{height:h,background:colors[ki],borderRadius:ki===0?'4px 4px 0 0':'0',minHeight:d[k]?2:0}} title={`${labels?labels[ki]:k}: ${eur(d[k]||0)}`}/>;
            })}
          </div>
          <div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500}}>{d.label}</div>
        </div>
      ))}
    </div>
  );
}

// ===== CSS HORIZONTAL BAR =====
function HBar({data,maxVal,color='var(--bordeaux)'}){
  return(
    <div style={{display:'flex',flexDirection:'column',gap:10}}>
      {data.map((d,i)=>(
        <div key={i} style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:90,fontSize:12,fontWeight:500,color:'var(--gris-700)',textAlign:'right'}}>{d.label}</div>
          <div style={{flex:1,height:22,background:'var(--gris-100)',borderRadius:4,overflow:'hidden',position:'relative'}}>
            <div style={{height:'100%',width:`${(d.value/maxVal)*100}%`,background:color,borderRadius:4,transition:'width .5s ease'}}/>
          </div>
          <div style={{width:70,fontSize:12,fontWeight:600,textAlign:'right'}}>{d.display||eur(d.value)}</div>
        </div>
      ))}
    </div>
  );
}

// ===== DONUT CHART =====
function Donut({segments,size=130,thickness=20,centerLabel,centerValue}){
  const r=(size-thickness)/2;
  const c=2*Math.PI*r;
  let offset=0;
  return(
    <div className="donut" style={{width:size,height:size}}>
      <svg width={size} height={size}>
        {segments.map((s,i)=>{
          const dash=(s.value/100)*c;
          const o=offset;
          offset+=dash;
          return <circle key={i} cx={size/2} cy={size/2} r={r} fill="none" stroke={s.color} strokeWidth={thickness} strokeDasharray={`${dash} ${c-dash}`} strokeDashoffset={-o}/>;
        })}
      </svg>
      <div className="donut-center">
        <div className="dv">{centerValue}</div>
        <div className="dl">{centerLabel}</div>
      </div>
    </div>
  );
}

// ===== SPARKLINE =====
function Spark({data,color='var(--bordeaux)',w=120,h=32}){
  const max=Math.max(...data);const min=Math.min(...data);const range=max-min||1;
  const pts=data.map((v,i)=>`${(i/(data.length-1))*w},${h-((v-min)/range)*h}`).join(' ');
  return(<svg width={w} height={h}><polyline points={pts} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>);
}

// ===== DATA =====
// Real data comes from Pennylane, Trivec, SevenRooms APIs
const revData=[];
const weekData=[];
const costTrend=[];
const barTrend=[];
const staffTrend=[];
const mockPL=[];
const staff=[];
const stockAlerts=[];
const resas=[];
const posItems=[];
const suppliers=[];

// ===== USER MANAGEMENT =====
const UserManager={
  _getUsers(){
    try{return JSON.parse(localStorage.getItem('ima_users')||'[]');}catch(e){return[];}
  },
  _saveUsers(users){localStorage.setItem('ima_users',JSON.stringify(users));},
  getAll(){return this._getUsers();},

  authenticate(email,password){
    const users=this._getUsers();
    const user=users.find(u=>u.email.toLowerCase()===email.toLowerCase()&&u.password===password&&u.active!==false);
    if(user){
      user.lastLogin=new Date().toISOString();
      this._saveUsers(users);
      localStorage.setItem('ima_current_user',JSON.stringify({id:user.id,nom:user.nom,email:user.email,role:user.role}));
      return user;
    }
    return null;
  },

  getCurrentUser(){
    try{return JSON.parse(localStorage.getItem('ima_current_user')||'null');}catch(e){return null;}
  },

  logout(){localStorage.removeItem('ima_current_user');},

  addUser({nom,email,role,password}){
    const users=this._getUsers();
    if(users.find(u=>u.email.toLowerCase()===email.toLowerCase()))return{error:'Cet email existe d√©j√†'};
    const newUser={id:Date.now(),nom,email:email.toLowerCase(),role:role||'Viewer',password:password||Math.random().toString(36).slice(-8),active:true,createdAt:new Date().toISOString(),invitedBy:this.getCurrentUser()?.nom||'Syst√®me'};
    users.push(newUser);
    this._saveUsers(users);
    return{success:true,user:newUser};
  },

  removeUser(id){
    const users=this._getUsers().filter(u=>u.id!==id);
    this._saveUsers(users);
  },

  updateUser(id,updates){
    const users=this._getUsers();
    const idx=users.findIndex(u=>u.id===id);
    if(idx>=0){users[idx]={...users[idx],...updates};this._saveUsers(users);}
  },

  initDefaults(){
    if(this._getUsers().length>0)return;
    this.addUser({nom:'Nicolas Spielmann',email:'nicolas@ima-club.com',role:'Admin',password:'N39suy**93'});
  }
};
UserManager.initDefaults();

// ===== LOGIN =====
function Login({onLogin}){
  const[email,setEmail]=useState('');
  const[password,setPassword]=useState('');
  const[error,setError]=useState('');

  const handleLogin=()=>{
    if(!email||!password){setError('Veuillez remplir tous les champs');return;}
    const user=UserManager.authenticate(email,password);
    if(user){
      setError('');
      onLogin(user);
    }else{
      setError('Email ou mot de passe incorrect');
    }
  };

  const handleKeyDown=(e)=>{if(e.key==='Enter')handleLogin();};

  return(
    <div className="login">
      <div className="login-c">
        <div className="login-logo">IMa</div>
        <div className="login-tag">Tour de contr√¥le</div>
        <div className="login-form">
          <h3>Connexion</h3>
          <div className="fg"><label className="fl">Email</label><input className="fi" type="email" value={email} onChange={e=>setEmail(e.target.value)} onKeyDown={handleKeyDown} placeholder="votre@email.com"/></div>
          <div className="fg"><label className="fl">Mot de passe</label><input className="fi" type="password" value={password} onChange={e=>setPassword(e.target.value)} onKeyDown={handleKeyDown} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
          {error&&<div className="error-msg" style={{marginBottom:10}}>{error}</div>}
          <button className="login-btn" onClick={handleLogin}>Se connecter</button>
          <p style={{fontSize:10,color:'var(--gris-400)',textAlign:'center',marginTop:14}}>dashboard.ima-club.com</p>
        </div>
      </div>
    </div>
  );
}

// ===== DASHBOARD =====
function Dashboard(){
  const team=StaffRegistry.getActive();
  const tipsEligible=StaffRegistry.getTipsEligible();
  return(<div className="fin">
    <div style={{background:'var(--bleu-light)',border:'1px solid var(--bleu)',borderRadius:10,padding:16,marginBottom:20,fontSize:13,color:'var(--bleu)'}}>
      <strong>Bienvenue sur le tableau de bord IMA.</strong> Les donn√©es s'afficheront automatiquement lorsque vos services seront connect√©s. Rendez-vous dans <strong>Administration</strong> pour configurer Pennylane, Trivec et SevenRooms.
    </div>
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">CA du mois</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente Trivec</div></div>
      <div className="kpi"><div className="kpi-label">Couverts</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente Trivec</div></div>
      <div className="kpi"><div className="kpi-label">Effectif actif</div><div className="kpi-val">{team.length}</div><div className="kpi-chg neu">{tipsEligible.length} b√©n√©f. tips</div></div>
      <div className="kpi"><div className="kpi-label">Pennylane</div><div className="kpi-val" style={{fontSize:16}}>{PennylaneService.getToken()?'Connect√©':'Non configur√©'}</div><div className={`kpi-chg ${PennylaneService.getToken()?'pos':'neg'}`}>{PennylaneService.getToken()?'API active':'Voir Administration'}</div></div>
    </div>
    <div className="cg">
      <div className="card">
        <div className="card-h"><div><div className="card-t">√âvolution du CA</div><div className="card-st">Donn√©es Trivec</div></div><span className="badge b-warn">Non connect√©</span></div>
        <div className="card-b" style={{padding:40,textAlign:'center',color:'var(--gris-400)'}}>
          <div style={{fontSize:32,marginBottom:8}}>üìä</div>
          <div style={{fontWeight:500}}>Connectez Trivec pour voir l'√©volution du chiffre d'affaires</div>
          <div style={{fontSize:11,marginTop:4}}>Les graphiques s'afficheront automatiquement</div>
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">R√©servations du jour</div><div className="card-st">Donn√©es SevenRooms</div></div><span className="badge b-warn">Non connect√©</span></div>
        <div className="card-b" style={{padding:40,textAlign:'center',color:'var(--gris-400)'}}>
          <div style={{fontSize:32,marginBottom:8}}>üìã</div>
          <div style={{fontWeight:500}}>Connectez SevenRooms pour voir les r√©servations</div>
          <div style={{fontSize:11,marginTop:4}}>Les r√©servations du jour appara√Ætront ici</div>
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Co√ªts Pennylane</div><div className="card-st">Factures fournisseurs</div></div>{PennylaneService.getToken()?<span className="badge b-ok">Connect√©</span>:<span className="badge b-warn">Non connect√©</span>}</div>
        <div className="card-b" style={{padding:40,textAlign:'center',color:'var(--gris-400)'}}>
          {PennylaneService.getToken()?
            <div><div style={{fontWeight:500,color:'var(--vert)'}}>Pennylane connect√©</div><div style={{fontSize:11,marginTop:4}}>Consultez Finance & P&L et Food & Bar Cost pour les d√©tails</div></div>:
            <div><div style={{fontSize:32,marginBottom:8}}>üí∞</div><div style={{fontWeight:500}}>Configurez Pennylane dans Administration</div></div>
          }
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">√âquipe</div></div></div>
        <div className="card-b">
          {team.length>0?<div>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8,fontSize:12,color:'var(--gris-500)'}}>
              <span>Salle: {team.filter(e=>e.section==='salle').length}</span>
              <span>Cuisine: {team.filter(e=>e.section==='cuisine').length}</span>
              <span>Tips: {tipsEligible.length}</span>
            </div>
            {team.slice(0,5).map(e=>(<div key={e.id} style={{padding:'6px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:12}}>
              <span style={{fontWeight:500}}>{e.nom}</span>
              <span className="badge b-ima" style={{fontSize:9}}>{e.poste}</span>
            </div>))}
            {team.length>5&&<div style={{textAlign:'center',fontSize:11,color:'var(--gris-400)',marginTop:8}}>+{team.length-5} autres</div>}
          </div>:<div style={{textAlign:'center',padding:20,color:'var(--gris-400)',fontSize:12}}>Ajoutez votre √©quipe dans Staff & RH</div>}
        </div>
      </div>
    </div>
  </div>);
}

// ===== FINANCE =====
function Finance(){
  const[allInvoices,setAllInvoices]=useState([]);
  const[loading,setLoading]=useState(false);
  const[loaded,setLoaded]=useState(false);
  const[expandedGroup,setExpandedGroup]=useState('Co√ªts Directs (Prime Cost)');

  useEffect(()=>{
    if(PennylaneService.getToken()){
      setLoading(true);
      PennylaneService.getAllSupplierInvoices({maxPages:5})
        .then(invoices=>{
          setAllInvoices(invoices);
          setLoaded(true);
        })
        .finally(()=>setLoading(false));
    }
  },[]);

  const totals=useMemo(()=>SupplierMap.getTotals(allInvoices),[allInvoices]);
  const groupTotals=useMemo(()=>SupplierMap.getGroupTotals(totals),[totals]);
  const totalCosts=Object.values(totals).reduce((s,v)=>s+v,0);

  // Mock CA (from POS data, not real yet)
  const caFood=0;
  const caBar=0;
  const caTotal=caFood+caBar;

  // Calculate EBITDA
  const staffCosts=totals['Staff']||0;
  const primeCostTotal=(totals['Food']||0)+(totals['Bar']||0)+staffCosts;
  const primeCostPct=caTotal>0?(primeCostTotal/caTotal)*100:0;
  const ebitda=caTotal-totalCosts;

  // Build P&L table data
  const plData=[];
  plData.push({type:'revenue',label:'CA Food',amount:caFood,pct:100*(caFood/caTotal),isSubsection:false,isBold:true,color:'var(--vert)'});
  plData.push({type:'revenue',label:'CA Bar',amount:caBar,pct:100*(caBar/caTotal),isSubsection:false,isBold:true,color:'var(--vert)'});
  plData.push({type:'spacer'});

  for(const[groupName,groupInfo]of Object.entries(COST_GROUPS)){
    const groupTotal=groupTotals[groupName]||0;
    if(groupTotal===0)continue;
    plData.push({type:'group',label:groupName,amount:-groupTotal,pct:-100*(groupTotal/caTotal),groupName,color:groupInfo.color,isBold:true});
    const catsWithData=groupInfo.cats.filter(c=>(totals[c]||0)!==0);
    for(const cat of catsWithData){
      const catTotal=totals[cat]||0;
      plData.push({type:'category',label:cat,amount:-catTotal,pct:-100*(catTotal/caTotal),indent:true,color:CAT_COLORS[cat]});
    }
  }

  plData.push({type:'spacer'});
  plData.push({type:'total',label:'EBITDA',amount:ebitda,pct:100*(ebitda/caTotal),isSubsection:false,isBold:true,color:ebitda>0?'var(--vert)':'var(--rouge)'});

  // Donut data - cost proportions
  const donutSegments=[];
  const colors=['#581527','#7a2d42','#a04560','#c46880','#059669'];
  let colorIdx=0;
  for(const[groupName,groupInfo]of Object.entries(COST_GROUPS)){
    const groupTotal=groupTotals[groupName]||0;
    if(groupTotal>0){
      const pct=100*(groupTotal/totalCosts);
      donutSegments.push({value:pct,color:colors[colorIdx%colors.length]});
      colorIdx++;
    }
  }

  return(<div className="fin">
    {!PennylaneService.getToken()&&<div style={{background:'var(--orange-light)',border:'1px solid var(--orange)',borderRadius:8,padding:14,marginBottom:16,color:'var(--orange)',fontSize:13}}>
      <strong>Configuration requise :</strong> Veuillez configurer votre token Pennylane dans les param√®tres pour afficher les donn√©es r√©elles des co√ªts.
    </div>}

    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">CA Total</div><div className="kpi-val">{eur(caTotal)}</div><div className="kpi-chg pos"><I.Up/> +11.9%</div></div>
      <div className="kpi"><div className="kpi-label">Co√ªts totaux</div><div className="kpi-val">{eur(totalCosts)}</div><div className="kpi-chg neu">{allInvoices.length} factures</div></div>
      <div className="kpi"><div className="kpi-label">EBITDA</div><div className="kpi-val" style={{color:ebitda>0?'var(--vert)':'var(--rouge)'}}>{eur(ebitda)}</div><div className={`kpi-chg ${ebitda>0?'pos':'neg'}`}>{ebitda>0?'Marge positive':'D√©ficit'}</div></div>
      <div className="kpi"><div className="kpi-label">Prime Cost %</div><div className="kpi-val">{primeCostPct.toFixed(1)}%</div><div className="kpi-chg neu">Food+Bar+Staff</div></div>
    </div>

    {loading&&<div style={{textAlign:'center',padding:40}}><div className="spinner" style={{width:24,height:24}}/><div style={{marginTop:10,fontSize:13,color:'var(--gris-500)'}}>Chargement Pennylane...</div></div>}

    {!loading&&<div>
    <div className="card" style={{marginBottom:16}}>
      <div className="card-h"><div><div className="card-t">Compte de r√©sultat ‚Äî F√©vrier 2026</div><div className="card-st">CA estim√© + Co√ªts Pennylane</div></div><span className="badge b-ima">Pennylane</span></div>
      <div className="card-b"><div className="tbl"><table>
        <thead><tr><th>Poste</th><th style={{textAlign:'right'}}>Montant</th><th style={{textAlign:'right'}}>% CA</th><th style={{width:180}}>R√©partition</th></tr></thead>
        <tbody>
          {plData.map((row,i)=>{
            if(row.type==='spacer')return <tr key={`spacer-${i}`} style={{height:8}}><td colSpan={4}/></tr>;
            if(row.type==='revenue'||row.type==='group'||row.type==='category'||row.type==='total'){
              const isBold=row.isBold;
              const fontSize=row.isBold?14:13;
              return <tr key={i} style={{fontWeight:isBold?700:400,background:row.type==='total'?'var(--gris-50)':'transparent',borderTop:row.type==='total'?'2px solid var(--gris-300)':'none'}}>
                <td style={{paddingLeft:row.indent?40:14,fontSize}}>{row.label}{row.type==='revenue'&&<span className="badge b-warn" style={{marginLeft:8,fontSize:9}}>Estim√©</span>}</td>
                <td style={{textAlign:'right',color:row.color,fontSize}}>{eur(row.amount)}</td>
                <td style={{textAlign:'right'}}>{Math.abs(row.pct).toFixed(1)}%</td>
                <td><div className="pbar"><div className="pfill" style={{width:`${Math.abs(row.pct)*1.5}%`,background:row.color}}/></div></td>
              </tr>;
            }
            return null;
          })}
        </tbody>
      </table></div></div>
    </div>

    <div className="cg" style={{marginTop:16}}>
      <div className="card">
        <div className="card-h"><div><div className="card-t">R√©partition des charges</div><div className="card-st">{allInvoices.length} factures Pennylane</div></div></div>
        <div className="card-b">
          {donutSegments.length>0?<div className="donut-wrap">
            <Donut segments={donutSegments} size={150} thickness={22} centerValue={`${(totalCosts/caTotal*100).toFixed(0)}%`} centerLabel="Co√ªts"/>
            <div className="donut-legend">
              {Object.entries(COST_GROUPS).map(([groupName,groupInfo],i)=>{
                const gt=groupTotals[groupName]||0;
                if(gt===0)return null;
                return <div key={groupName} className="donut-legend-item">
                  <div className="donut-legend-dot" style={{background:colors[i%colors.length]}}/>
                  {groupName} ‚Äî {(100*(gt/totalCosts)).toFixed(1)}%
                </div>;
              })}
            </div>
          </div>:<div style={{padding:20,textAlign:'center',color:'var(--gris-400)'}}>Aucune donn√©e Pennylane</div>}
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">√âvolution CA Food vs Bar</div></div></div>
        <div className="card-b"><BarChart data={revData} keys={['food','bar']} colors={['#581527','#c46880']} labels={['Food','Bar']} height={220}/></div>
      </div>
    </div>

    <div className="card">
      <div className="card-h"><div><div className="card-t">D√©tail des charges par groupe</div><div className="card-st">Cliquez pour voir les cat√©gories d√©taill√©es</div></div></div>
      <div className="card-b">
        {Object.entries(COST_GROUPS).map(([groupName,groupInfo])=>{
          const gt=groupTotals[groupName]||0;
          if(gt===0)return null;
          const catsWithData=groupInfo.cats.filter(c=>(totals[c]||0)!==0);
          return <div key={groupName} style={{marginBottom:12}}>
            <div style={{cursor:'pointer',padding:'10px 14px',background:'var(--gris-50)',borderRadius:8,display:'flex',justifyContent:'space-between',alignItems:'center'}} onClick={()=>setExpandedGroup(expandedGroup===groupName?null:groupName)}>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <div style={{width:4,height:28,borderRadius:2,background:groupInfo.color}}/>
                <div style={{fontWeight:600,color:'var(--gris-800)'}}>{groupName}</div>
                <span className="badge b-ima" style={{fontSize:9}}>{catsWithData.length} cat.</span>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:12}}>
                <div style={{textAlign:'right'}}>
                  <div style={{fontSize:14,fontWeight:700,color:groupInfo.color}}>{eur(gt)}</div>
                  <div style={{fontSize:9,color:'var(--gris-400)'}}>{(100*(gt/totalCosts)).toFixed(1)}% des co√ªts</div>
                </div>
                <I.Chev style={{transform:expandedGroup===groupName?'rotate(180deg)':'rotate(0deg)',transition:'transform .2s'}}/>
              </div>
            </div>
            {expandedGroup===groupName&&<div style={{marginTop:8,paddingLeft:14}}>
              {catsWithData.map(cat=>{
                const ct=totals[cat]||0;
                return <div key={cat} style={{padding:'8px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <div style={{width:8,height:8,borderRadius:2,background:CAT_COLORS[cat]||'var(--gris-400)'}}/>
                    <span style={{fontWeight:500}}>{cat}</span>
                    <span className="badge b-ima" style={{fontSize:8}}>{(allInvoices.filter(inv=>{
                      const sid=String(inv.supplier?.id||'');
                      return SupplierMap.getCategory(sid)===cat;
                    })).length} fact.</span>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:14}}>
                    <span style={{fontSize:11,color:'var(--gris-500)'}}>{(100*(ct/totalCosts)).toFixed(1)}%</span>
                    <span style={{fontWeight:700,minWidth:70,textAlign:'right'}}>{eur(ct)}</span>
                  </div>
                </div>;
              })}
            </div>}
          </div>;
        })}
      </div>
    </div>
    </div>}
  </div>);
}

// ===== COSTS =====
function Costs(){
  const[tab,setTab]=useState('overview');
  const[allInvoices,setAllInvoices]=useState([]);
  const[loading,setLoading]=useState(false);
  const[loaded,setLoaded]=useState(false);
  const[supplierNames,setSupplierNames]=useState({});
  const[editingSupplier,setEditingSupplier]=useState(null);
  const[mapVersion,setMapVersion]=useState(0);
  const[expandedCat,setExpandedCat]=useState(null);
  const[filterCat,setFilterCat]=useState('Tous');

  useEffect(()=>{
    if(PennylaneService.getToken()){
      setLoading(true);
      PennylaneService.getAllSupplierInvoices({maxPages:5})
        .then(invoices=>{
          setAllInvoices(invoices);
          const names={};
          invoices.forEach(inv=>{
            const sid=String(inv.supplier?.id||'');
            if(sid&&!names[sid])names[sid]=SupplierMap.extractName(inv);
          });
          setSupplierNames(names);
          setLoaded(true);
        })
        .finally(()=>setLoading(false));
    }
  },[]);

  const categorized=useMemo(()=>SupplierMap.categorize(allInvoices),[allInvoices,mapVersion]);
  const totals=useMemo(()=>SupplierMap.getTotals(allInvoices),[allInvoices,mapVersion]);
  const groupTotals=useMemo(()=>SupplierMap.getGroupTotals(totals),[totals]);
  const totalAll=Object.values(totals).reduce((s,v)=>s+v,0);
  const foodTotal=totals['Food']||0;
  const barTotal=totals['Bar']||0;
  const primeCost=(foodTotal+barTotal+(totals['Staff']||0));

  const supplierGroups=useMemo(()=>{
    const groups={};
    allInvoices.forEach(inv=>{
      const sid=String(inv.supplier?.id||'');
      if(!sid)return;
      if(!groups[sid])groups[sid]={id:sid,name:supplierNames[sid]||'Inconnu',total:0,totalHT:0,count:0,cat:SupplierMap.getCategory(sid)};
      groups[sid].total+=parseFloat(inv.amount||0);
      groups[sid].totalHT+=parseFloat(inv.currency_amount_before_tax||0);
      groups[sid].count++;
    });
    return Object.values(groups).sort((a,b)=>Math.abs(b.total)-Math.abs(a.total));
  },[allInvoices,supplierNames,mapVersion]);

  const handleCategoryChange=(supplierId,newCat)=>{
    SupplierMap.setCategory(supplierId,newCat);
    setMapVersion(v=>v+1);
    setEditingSupplier(null);
  };

  // Helper: render invoice table for a category
  const InvoiceTable=({catName,invoices,color})=>{
    const sorted=invoices.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const totalTTC=invoices.reduce((s,i)=>s+parseFloat(i.amount||0),0);
    const totalHT=invoices.reduce((s,i)=>s+parseFloat(i.currency_amount_before_tax||0),0);
    return(<div className="card" style={{marginBottom:14}}>
      <div className="card-h">
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:4,height:28,borderRadius:2,background:color||'var(--bordeaux)'}}/>
          <div><div className="card-t">{catName}</div><div className="card-st">{invoices.length} facture{invoices.length>1?'s':''} ‚Äî Total: {eur(totalTTC)}</div></div>
        </div>
        <span className="badge b-ima">Pennylane</span>
      </div>
      <div className="card-b"><div className="tbl"><table>
        <thead><tr><th>Fournisseur</th><th>N¬∞ Facture</th><th>Date</th><th style={{textAlign:'right'}}>HT</th><th style={{textAlign:'right'}}>TTC</th><th>Statut</th></tr></thead>
        <tbody>{sorted.map((inv,i)=>(
          <tr key={inv.id||i}>
            <td style={{fontWeight:500}}>{SupplierMap.extractName(inv)}</td>
            <td style={{fontSize:12}}>{inv.invoice_number||'‚Äî'}</td>
            <td style={{fontSize:12}}>{inv.date||'‚Äî'}</td>
            <td style={{textAlign:'right'}}>{eur(parseFloat(inv.currency_amount_before_tax||0))}</td>
            <td style={{textAlign:'right',fontWeight:600}}>{eur(parseFloat(inv.amount||0))}</td>
            <td><span className={`badge ${inv.payment_status==='paid'?'b-ok':'b-warn'}`}>{inv.payment_status==='paid'?'Pay√©e':'√Ä traiter'}</span></td>
          </tr>))}</tbody>
        <tfoot><tr style={{fontWeight:700,background:'var(--gris-50)',borderTop:'2px solid var(--gris-300)'}}>
          <td>TOTAL</td><td/><td/>
          <td style={{textAlign:'right'}}>{eur(totalHT)}</td>
          <td style={{textAlign:'right',color:color||'var(--bordeaux)',fontSize:15}}>{eur(totalTTC)}</td><td/>
        </tr></tfoot>
      </table></div></div>
    </div>);
  };

  return(<div className="fin">
    <div className="tabs">
      <div className={`tab ${tab==='overview'?'active':''}`} onClick={()=>setTab('overview')}>Vue d'ensemble</div>
      <div className={`tab ${tab==='food'?'active':''}`} onClick={()=>setTab('food')}>Food</div>
      <div className={`tab ${tab==='bar'?'active':''}`} onClick={()=>setTab('bar')}>Bar</div>
      <div className={`tab ${tab==='charges'?'active':''}`} onClick={()=>setTab('charges')}>Charges</div>
      <div className={`tab ${tab==='fournisseurs'?'active':''}`} onClick={()=>setTab('fournisseurs')}>Tous les fournisseurs</div>
      <div className={`tab ${tab==='mapping'?'active':''}`} onClick={()=>setTab('mapping')}>Mapping</div>
    </div>

    {loading&&<div style={{textAlign:'center',padding:40}}><div className="spinner" style={{width:24,height:24}}/><div style={{marginTop:10,fontSize:13,color:'var(--gris-500)'}}>Chargement Pennylane...</div></div>}

    {!loading&&loaded&&<div>
    {/* KPI */}
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">Achats Food</div><div className="kpi-val" style={{color:'#059669'}}>{eur(foodTotal)}</div><div className="kpi-chg pos">{(categorized['Food']||[]).length} factures</div></div>
      <div className="kpi"><div className="kpi-label">Achats Bar</div><div className="kpi-val" style={{color:'#581527'}}>{eur(barTotal)}</div><div className="kpi-chg pos">{(categorized['Bar']||[]).length} factures</div></div>
      <div className="kpi"><div className="kpi-label">Total charges</div><div className="kpi-val">{eur(totalAll)}</div><div className="kpi-chg neu">{allInvoices.length} factures</div></div>
      <div className="kpi"><div className="kpi-label">Non class√©</div><div className="kpi-val" style={{color:(totals['Non class√©']||0)>0?'var(--rouge)':'var(--vert)'}}>{eur(totals['Non class√©']||0)}</div>
        <div className="kpi-chg neg">{supplierGroups.filter(s=>s.cat==='Non class√©').length} fournisseurs</div></div>
    </div>

    {/* ===== TAB: OVERVIEW ===== */}
    {tab==='overview'&&<div>
      {/* Cost groups summary */}
      {Object.entries(COST_GROUPS).map(([groupName,groupInfo])=>{
        const groupTotal=groupInfo.cats.reduce((s,c)=>s+(totals[c]||0),0);
        if(groupTotal===0&&groupName==='Hors Exploitation')return null;
        const catsWithData=groupInfo.cats.filter(c=>(totals[c]||0)!==0);
        return(<div className="card" key={groupName} style={{marginBottom:14}}>
          <div className="card-h" style={{cursor:'pointer'}} onClick={()=>setExpandedCat(expandedCat===groupName?null:groupName)}>
            <div style={{display:'flex',alignItems:'center',gap:10}}>
              <div style={{width:4,height:36,borderRadius:2,background:groupInfo.color}}/>
              <div>
                <div className="card-t">{groupName}</div>
                <div className="card-st">{groupInfo.desc} ‚Äî {catsWithData.length} cat√©gorie{catsWithData.length>1?'s':''}</div>
              </div>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:14}}>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:22,fontWeight:700,color:groupInfo.color}}>{eur(groupTotal)}</div>
                <div style={{fontSize:11,color:'var(--gris-400)'}}>{totalAll>0?((groupTotal/totalAll)*100).toFixed(1):0}% du total</div>
              </div>
              <I.Chev/>
            </div>
          </div>
          {(expandedCat===groupName||groupName.includes('Prime'))&&<div className="card-b" style={{paddingTop:0}}>
            {catsWithData.map(cat=>{
              const catInvoices=categorized[cat]||[];
              const catTotal=totals[cat]||0;
              const catHT=catInvoices.reduce((s,i)=>s+parseFloat(i.currency_amount_before_tax||0),0);
              return(<div key={cat} style={{padding:'10px 0',borderBottom:'1px solid var(--gris-100)'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}} onClick={()=>setExpandedCat(expandedCat===cat?groupName:cat)}>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <div style={{width:10,height:10,borderRadius:3,background:CAT_COLORS[cat]||'var(--gris-400)'}}/>
                    <div style={{fontWeight:500,fontSize:13}}>{cat}</div>
                    <span className="badge b-ima" style={{fontSize:9}}>{catInvoices.length} fact.</span>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:14}}>
                    <div style={{fontSize:11,color:'var(--gris-500)'}}>HT: {eur(catHT)}</div>
                    <div style={{fontWeight:700,fontSize:14}}>{eur(catTotal)}</div>
                    <div style={{width:100}}><div className="pbar"><div className="pfill" style={{width:`${totalAll>0?Math.min(Math.abs(catTotal/totalAll)*100*3,100):0}%`,background:CAT_COLORS[cat]||'var(--gris-400)'}}/></div></div>
                  </div>
                </div>
                {expandedCat===cat&&<div style={{marginTop:8}}><div className="tbl"><table style={{fontSize:12}}>
                  <thead><tr><th>Fournisseur</th><th>Date</th><th style={{textAlign:'right'}}>HT</th><th style={{textAlign:'right'}}>TTC</th></tr></thead>
                  <tbody>{catInvoices.sort((a,b)=>new Date(b.date)-new Date(a.date)).map((inv,i)=>(
                    <tr key={inv.id||i}><td>{SupplierMap.extractName(inv)}</td><td>{inv.date}</td>
                    <td style={{textAlign:'right'}}>{eur(parseFloat(inv.currency_amount_before_tax||0))}</td>
                    <td style={{textAlign:'right',fontWeight:600}}>{eur(parseFloat(inv.amount||0))}</td></tr>
                  ))}</tbody>
                </table></div></div>}
              </div>);
            })}
            {catsWithData.length===0&&<div style={{padding:10,color:'var(--gris-400)',fontSize:12}}>Aucune facture dans ce groupe</div>}
          </div>}
        </div>);
      })}

      {/* R√©partition bar chart */}
      <div className="card">
        <div className="card-h"><div><div className="card-t">R√©partition des charges</div></div></div>
        <div className="card-b">
          <HBar data={ALL_CATEGORIES.filter(c=>(totals[c]||0)!==0).map(c=>({
            label:c,value:Math.abs(totals[c]||0),display:eur(totals[c]||0)
          })).sort((a,b)=>b.value-a.value)}
            maxVal={Math.max(...ALL_CATEGORIES.map(c=>Math.abs(totals[c]||0)))||1}
            color="var(--bordeaux)"/>
        </div>
      </div>
    </div>}

    {/* ===== TAB: FOOD ===== */}
    {tab==='food'&&<div>
      <InvoiceTable catName="Achats Food" invoices={categorized['Food']||[]} color="#059669"/>
      {(categorized['Food']||[]).length===0&&<div className="alert-i a-warn"><I.Warn/><div><div className="at">Aucune facture Food</div><div className="as">Classez vos fournisseurs dans l'onglet Mapping</div></div></div>}
    </div>}

    {/* ===== TAB: BAR ===== */}
    {tab==='bar'&&<div>
      <InvoiceTable catName="Achats Bar" invoices={categorized['Bar']||[]} color="#581527"/>
      {(categorized['Bar']||[]).length===0&&<div className="alert-i a-warn"><I.Warn/><div><div className="at">Aucune facture Bar</div><div className="as">Classez vos fournisseurs dans l'onglet Mapping</div></div></div>}
    </div>}

    {/* ===== TAB: CHARGES ===== */}
    {tab==='charges'&&<div>
      {Object.entries(COST_GROUPS).filter(([g])=>!g.includes('Prime')).map(([groupName,groupInfo])=>{
        const catsWithData=groupInfo.cats.filter(c=>(categorized[c]||[]).length>0);
        if(catsWithData.length===0)return null;
        return catsWithData.map(cat=>(
          <InvoiceTable key={cat} catName={cat} invoices={categorized[cat]||[]} color={CAT_COLORS[cat]}/>
        ));
      })}
    </div>}

    {/* ===== TAB: ALL INVOICES ===== */}
    {tab==='fournisseurs'&&<div>
      <div style={{display:'flex',gap:6,marginBottom:14,flexWrap:'wrap'}}>
        <button className={`btn btn-sm ${filterCat==='Tous'?'btn-primary':'btn-secondary'}`} onClick={()=>setFilterCat('Tous')}>Tous ({allInvoices.length})</button>
        {ALL_CATEGORIES.filter(c=>(categorized[c]||[]).length>0).map(c=>(
          <button key={c} className={`btn btn-sm ${filterCat===c?'btn-primary':'btn-secondary'}`} onClick={()=>setFilterCat(c)}
            style={{borderLeft:`3px solid ${CAT_COLORS[c]||'var(--gris-400)'}`}}>{c} ({(categorized[c]||[]).length})</button>
        ))}
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">{filterCat==='Tous'?'Toutes les factures':filterCat}</div><div className="card-st">Donn√©es Pennylane</div></div><span className="badge b-ima">Live</span></div>
        <div className="card-b"><div className="tbl"><table>
          <thead><tr><th>Fournisseur</th><th>Cat√©gorie</th><th>N¬∞</th><th>Date</th><th style={{textAlign:'right'}}>HT</th><th style={{textAlign:'right'}}>TTC</th><th>Statut</th></tr></thead>
          <tbody>{(filterCat==='Tous'?allInvoices:(categorized[filterCat]||[])).sort((a,b)=>new Date(b.date)-new Date(a.date)).map((inv,i)=>{
            const sid=String(inv.supplier?.id||'');
            const cat=SupplierMap.getCategory(sid);
            return(<tr key={inv.id||i}>
              <td style={{fontWeight:500}}>{SupplierMap.extractName(inv)}</td>
              <td><span style={{display:'inline-block',padding:'2px 8px',borderRadius:4,fontSize:10,fontWeight:500,background:CAT_COLORS[cat]||'var(--gris-400)',color:'white'}}>{cat}</span></td>
              <td style={{fontSize:11}}>{inv.invoice_number||'‚Äî'}</td>
              <td style={{fontSize:12}}>{inv.date||'‚Äî'}</td>
              <td style={{textAlign:'right',fontSize:12}}>{eur(parseFloat(inv.currency_amount_before_tax||0))}</td>
              <td style={{textAlign:'right',fontWeight:600}}>{eur(parseFloat(inv.amount||0))}</td>
              <td><span className={`badge ${inv.payment_status==='paid'?'b-ok':'b-warn'}`}>{inv.payment_status==='paid'?'Pay√©e':'√Ä traiter'}</span></td>
            </tr>);})}</tbody>
        </table></div></div>
      </div>
    </div>}

    {/* ===== TAB: MAPPING ===== */}
    {tab==='mapping'&&<div>
      {supplierGroups.filter(s=>s.cat==='Non class√©').length>0&&<div className="alert-i a-err" style={{marginBottom:14}}><I.Warn/><div><div className="at">{supplierGroups.filter(s=>s.cat==='Non class√©').length} fournisseur(s) non class√©(s)</div><div className="as">Cliquez sur "Modifier" pour assigner une cat√©gorie. Les fournisseurs non class√©s apparaissent en haut.</div></div></div>}

      {/* Group by cost group */}
      {Object.entries(COST_GROUPS).map(([groupName,groupInfo])=>{
        const groupSuppliers=supplierGroups.filter(s=>groupInfo.cats.includes(s.cat));
        if(groupSuppliers.length===0&&groupName!=='Hors Exploitation')return null;
        const suppliersToShow=groupName==='Hors Exploitation'?
          supplierGroups.filter(s=>groupInfo.cats.includes(s.cat)):groupSuppliers;
        if(suppliersToShow.length===0)return null;
        return(<div className="card" key={groupName} style={{marginBottom:14}}>
          <div className="card-h"><div>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <div style={{width:4,height:20,borderRadius:2,background:groupInfo.color}}/>
              <div className="card-t">{groupName}</div>
            </div>
            <div className="card-st">{suppliersToShow.length} fournisseur(s)</div>
          </div></div>
          <div className="card-b"><div className="tbl"><table>
            <thead><tr><th style={{textAlign:'left'}}>Fournisseur</th><th>Cat√©gorie</th><th style={{textAlign:'right'}}>Total TTC</th><th style={{textAlign:'center'}}>Factures</th><th style={{width:200}}>Action</th></tr></thead>
            <tbody>{suppliersToShow.sort((a,b)=>a.cat==='Non class√©'?-1:b.cat==='Non class√©'?1:Math.abs(b.total)-Math.abs(a.total)).map(s=>(
              <tr key={s.id} style={{background:s.cat==='Non class√©'?'rgba(220,38,38,.04)':'transparent'}}>
                <td style={{fontWeight:500}}>{s.name}</td>
                <td><span style={{display:'inline-block',padding:'2px 8px',borderRadius:4,fontSize:10,fontWeight:600,background:CAT_COLORS[s.cat]||'var(--gris-400)',color:'white'}}>{s.cat}</span></td>
                <td style={{textAlign:'right',fontWeight:600}}>{eur(s.total)}</td>
                <td style={{textAlign:'center'}}>{s.count}</td>
                <td>
                  {editingSupplier===s.id?
                    <div style={{display:'flex',gap:3,flexWrap:'wrap'}}>
                      {ALL_CATEGORIES.map(cat=>(
                        <button key={cat} onClick={()=>handleCategoryChange(s.id,cat)}
                          style={{fontSize:9,padding:'3px 6px',borderRadius:4,border:'1px solid var(--gris-200)',background:s.cat===cat?CAT_COLORS[cat]||'var(--bordeaux)':'white',
                            color:s.cat===cat?'white':'var(--gris-700)',cursor:'pointer',fontFamily:'inherit',fontWeight:s.cat===cat?600:400}}>
                          {cat}
                        </button>
                      ))}
                    </div>
                    :<button className="btn btn-sm btn-secondary" onClick={()=>setEditingSupplier(s.id)}>Modifier</button>
                  }
                </td>
              </tr>))}</tbody>
          </table></div></div>
        </div>);
      })}
    </div>}
    </div>}

    {!loading&&!loaded&&<div className="alert-i a-warn"><I.Warn/><div><div className="at">Connexion Pennylane requise</div><div className="as">Configurez votre token API dans Administration ‚Üí Configuration Pennylane</div></div></div>}
  </div>);
}

// ===== STAFF =====
function StaffPage(){
  const[tab,setTab]=useState('equipe');
  const[showModal,setShowModal]=useState(false);
  const[editingId,setEditingId]=useState(null);
  const emptyEmp={nom:'',poste:'Serveur',section:'salle',tipCategory:'FLOOR',points:4,contrat:'CDI',tel:'',dateEntree:new Date().toLocaleDateString('fr-FR'),tips:true,coutBrut:0,heures:0,extras:0};
  const[newEmp,setNewEmp]=useState(emptyEmp);
  const[ver,setVer]=useState(0);
  const team=StaffRegistry.getActive();
  const tipsTeam=StaffRegistry.getTipsEligible();

  const handleAddOrSave=()=>{
    if(!newEmp.nom)return;
    if(editingId){
      StaffRegistry.update(editingId,newEmp);
      setEditingId(null);
    }else{
      StaffRegistry.add(newEmp);
    }
    setNewEmp({...emptyEmp});
    setVer(v=>v+1);
    setTab('equipe');
  };

  const handleEditEmployee=(emp)=>{
    setEditingId(emp.id);
    setNewEmp({nom:emp.nom,poste:emp.poste,section:emp.section||'salle',tipCategory:emp.tipCategory||'FLOOR',points:emp.points||3,contrat:emp.contrat||'CDI',tel:emp.tel||'',dateEntree:emp.dateEntree||'',tips:emp.tips!==false,coutBrut:emp.coutBrut||0,heures:emp.heures||0,extras:emp.extras||0});
    setTab('ajouter');
  };

  const handleCancelEdit=()=>{
    setEditingId(null);
    setNewEmp({...emptyEmp});
  };

  const handleDeactivate=(id)=>{
    if(confirm('Marquer comme inactif ?'))StaffRegistry.deactivate(id);
    setVer(v=>v+1);
  };

  const totalMasseS=team.reduce((s,e)=>s+(e.coutBrut||0),0);
  const totalHeures=team.reduce((s,e)=>s+(e.heures||0),0);
  const totalExtras=team.reduce((s,e)=>s+(e.extras||0),0);
  const salleCount=team.filter(e=>e.section==='salle').length;
  const cuisineCount=team.filter(e=>e.section==='cuisine').length;

  const sectionColors={salle:'var(--bordeaux)',cuisine:'var(--vert)'};

  return(<div className="fin">
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">Effectif total</div><div className="kpi-val">{team.length}</div><div className="kpi-chg neu">dont {team.filter(e=>e.contrat==='CDD').length} CDD</div></div>
      <div className="kpi"><div className="kpi-label">Salle / Cuisine</div><div className="kpi-val">{salleCount} / {cuisineCount}</div><div className="kpi-chg neu">r√©partition</div></div>
      <div className="kpi"><div className="kpi-label">Masse salariale</div><div className="kpi-val">{eur(totalMasseS)}</div><div className="kpi-chg neu">total brut</div></div>
      <div className="kpi"><div className="kpi-label">B√©n√©f. Tips</div><div className="kpi-val">{tipsTeam.length}</div><div className="kpi-chg pos">√©ligibles</div></div>
    </div>

    <div className="tabs">
      <div className={`tab ${tab==='equipe'?'active':''}`} onClick={()=>setTab('equipe')}>√âquipe</div>
      <div className={`tab ${tab==='ajouter'?'active':''}`} onClick={()=>setTab('ajouter')}>Ajouter / Modifier</div>
      <div className={`tab ${tab==='repartition'?'active':''}`} onClick={()=>setTab('repartition')}>R√©partition</div>
    </div>

    {tab==='equipe'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">√âquipe ‚Äî F√©vrier 2026</div><div className="card-st">{team.length} collaborateurs actifs</div></div></div>
        <div className="card-b"><div className="tbl"><table>
          <thead><tr><th>Nom</th><th>Poste</th><th>Section</th><th>Cat√©gorie Tips</th><th>Points</th><th>Contrat</th><th>Entr√©e</th><th style={{textAlign:'right'}}>Heures</th><th style={{textAlign:'right'}}>Extras</th><th style={{textAlign:'right'}}>Co√ªt brut</th><th>Tips</th><th>Actions</th></tr></thead>
          <tbody>{team.map(e=><tr key={e.id}>
            <td style={{fontWeight:500}}>{e.nom}</td>
            <td><span className="badge b-ima">{e.poste}</span></td>
            <td><span className="badge" style={{background:sectionColors[e.section],color:'white',fontSize:10}}>{e.section==='salle'?'Salle':'Cuisine'}</span></td>
            <td><span className="badge" style={{background:TIP_CATEGORIES[e.section]?.[e.tipCategory]?.color||'var(--gris-300)',color:'white',fontSize:9}}>{TIP_CATEGORIES[e.section]?.[e.tipCategory]?.label||e.tipCategory}</span></td>
            <td style={{fontWeight:600}}>{e.points}</td>
            <td><span className={`badge ${e.contrat==='CDI'?'b-ok':'b-info'}`}>{e.contrat}</span></td>
            <td style={{fontSize:12}}>{e.dateEntree}</td>
            <td style={{textAlign:'right'}}>{e.heures}h</td>
            <td style={{textAlign:'right',color:e.extras>0?'var(--orange)':'var(--gris-400)'}}>{e.extras>0?e.extras+'h':'‚Äî'}</td>
            <td style={{textAlign:'right',fontWeight:600}}>{e.coutBrut>0?eur(e.coutBrut):'‚Äî'}</td>
            <td>{e.tips?<span className="badge b-ok" style={{fontSize:10}}>Oui</span>:<span className="badge" style={{background:'var(--gris-100)',color:'var(--gris-400)',fontSize:10}}>Non</span>}</td>
            <td style={{whiteSpace:'nowrap'}}><button className="btn btn-sm" style={{background:'var(--bleu-light)',color:'var(--bleu)',border:'none',padding:'4px 8px',fontSize:10,cursor:'pointer',marginRight:4}} onClick={()=>handleEditEmployee(e)}>Modifier</button><button className="btn btn-sm" style={{background:'var(--rouge-light)',color:'var(--rouge)',border:'none',padding:'4px 8px',fontSize:10,cursor:'pointer'}} onClick={()=>handleDeactivate(e.id)}>D√©sactiver</button></td>
          </tr>)}</tbody>
        </table></div></div>
      </div>
    </div>}

    {tab==='ajouter'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">{editingId?`Modifier ‚Äî ${newEmp.nom}`:'Ajouter un employ√©'}</div>{editingId&&<div className="card-st">Modifiez les champs puis cliquez Sauvegarder</div>}</div>{editingId&&<span className="badge b-warn">Mode √©dition</span>}</div>
        <div className="card-b">
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">Nom complet</label>
              <input className="fi" value={newEmp.nom} onChange={e=>setNewEmp(p=>({...p,nom:e.target.value}))} placeholder="Pr√©nom Nom"/>
            </div>
            <div className="fg">
              <label className="fl">Poste</label>
              <input className="fi" value={newEmp.poste} onChange={e=>setNewEmp(p=>({...p,poste:e.target.value}))} placeholder="ex: Serveur"/>
            </div>
          </div>

          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">Section</label>
              <select className="fi-select" value={newEmp.section} onChange={e=>{const s=e.target.value;const tc=Object.keys(TIP_CATEGORIES[s]||{})[0]||'FLOOR';setNewEmp(p=>({...p,section:s,tipCategory:tc}));}}>
                <option value="salle">Salle</option>
                <option value="cuisine">Cuisine</option>
              </select>
            </div>
            <div className="fg">
              <label className="fl">Cat√©gorie Tips</label>
              <select className="fi-select" value={newEmp.tipCategory} onChange={e=>{const cat=e.target.value;const pts=TIP_CATEGORIES[newEmp.section]?.[cat]?.defaultPoints||3;setNewEmp(p=>({...p,tipCategory:cat,points:pts}));}}>
                {Object.entries(TIP_CATEGORIES[newEmp.section]||{}).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
              </select>
            </div>
            <div className="fg">
              <label className="fl">Points</label>
              <input type="number" className="fi" value={newEmp.points} onChange={e=>setNewEmp(p=>({...p,points:parseFloat(e.target.value)||0}))}/>
            </div>
            <div className="fg">
              <label className="fl">Contrat</label>
              <select className="fi-select" value={newEmp.contrat} onChange={e=>setNewEmp(p=>({...p,contrat:e.target.value}))}>
                <option value="CDI">CDI</option>
                <option value="CDD">CDD</option>
                <option value="Extra">Extra</option>
                <option value="Stage">Stage</option>
              </select>
            </div>
          </div>

          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">T√©l√©phone</label>
              <input className="fi" value={newEmp.tel} onChange={e=>setNewEmp(p=>({...p,tel:e.target.value}))} placeholder="06 XX XX XX XX"/>
            </div>
            <div className="fg">
              <label className="fl">Date d'entr√©e</label>
              <input type="date" className="fi" value={newEmp.dateEntree} onChange={e=>setNewEmp(p=>({...p,dateEntree:e.target.value}))}/>
            </div>
            <div className="fg">
              <label className="fl">Co√ªt brut mensuel (‚Ç¨)</label>
              <input type="number" className="fi" value={newEmp.coutBrut} onChange={e=>setNewEmp(p=>({...p,coutBrut:parseFloat(e.target.value)||0}))}/>
            </div>
          </div>

          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
            <div className="fg">
              <label className="fl">Heures mensuelles</label>
              <input type="number" className="fi" value={newEmp.heures} onChange={e=>setNewEmp(p=>({...p,heures:parseFloat(e.target.value)||0}))}/>
            </div>
            <div className="fg">
              <label className="fl">Extras (h)</label>
              <input type="number" className="fi" value={newEmp.extras} onChange={e=>setNewEmp(p=>({...p,extras:parseFloat(e.target.value)||0}))}/>
            </div>
          </div>

          <div className="fg" style={{display:'flex',alignItems:'center',gap:10,marginBottom:20}}>
            <input type="checkbox" id="tips-check" checked={newEmp.tips} onChange={e=>setNewEmp(p=>({...p,tips:e.target.checked}))} style={{width:16,height:16,accentColor:'var(--bordeaux)'}}/>
            <label htmlFor="tips-check" style={{fontSize:13,fontWeight:500,cursor:'pointer'}}>√âligible aux tips</label>
          </div>

          <div style={{display:'flex',gap:10,justifyContent:'flex-end'}}>
            {editingId&&<button className="btn btn-secondary" onClick={handleCancelEdit}>Annuler</button>}
            {!editingId&&<button className="btn btn-secondary" onClick={()=>setNewEmp({...emptyEmp})}>R√©initialiser</button>}
            <button className="btn btn-primary" onClick={handleAddOrSave}>{editingId?'Sauvegarder les modifications':'Ajouter l\'employ√©'}</button>
          </div>
        </div>
      </div>
    </div>}

    {tab==='repartition'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">R√©partition par section</div></div></div>
        <div className="card-b">
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20,marginBottom:30}}>
            <div className="cost-c">
              <div className="cl" style={{color:'var(--bordeaux)'}}>Salle</div>
              <div className="cv">{salleCount}</div>
              <div className="ct">collaborateurs</div>
            </div>
            <div className="cost-c">
              <div className="cl" style={{color:'var(--vert)'}}>Cuisine</div>
              <div className="cv">{cuisineCount}</div>
              <div className="ct">collaborateurs</div>
            </div>
          </div>

          <div style={{marginTop:20}}>
            <div style={{fontSize:13,fontWeight:600,marginBottom:12,color:'var(--bordeaux)'}}>R√©partition par cat√©gorie Tips</div>
            {['salle','cuisine'].map(section=>(
              <div key={section} style={{marginBottom:20}}>
                <div style={{fontSize:11,color:'var(--gris-500)',textTransform:'uppercase',marginBottom:8}}>{section==='salle'?'Salle':'Cuisine'}</div>
                {Object.entries(TIP_CATEGORIES[section]||{}).map(([catKey,catData])=>{
                  const count=StaffRegistry.getBySectionAndCategory(section,catKey).length;
                  const totalPoints=StaffRegistry.getBySectionAndCategory(section,catKey).reduce((s,e)=>s+e.points,0);
                  return(<div key={catKey} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:10,background:'var(--gris-50)',borderRadius:6,marginBottom:8,fontSize:12}}>
                    <div style={{display:'flex',alignItems:'center',gap:10}}>
                      <div style={{width:12,height:12,borderRadius:3,background:catData.color}}/>
                      <span style={{fontWeight:500}}>{catData.label}</span>
                    </div>
                    <div style={{textAlign:'right'}}>
                      <div style={{fontWeight:600}}>{count} person{count>1?'s':''}</div>
                      <div style={{color:'var(--gris-500)',fontSize:10}}>Total: {totalPoints} pts</div>
                    </div>
                  </div>);
                })}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>}
  </div>);
}

// ===== STOCKS =====
function Stocks(){
  const[tab,setTab]=useState('inventaire');
  const[filterCat,setFilterCat]=useState('Tous');
  const[showAddModal,setShowAddModal]=useState(false);
  const[newItem,setNewItem]=useState({nom:'',cat:'Viandes',unite:'kg',prixUnit:0,seuil:0});

  // Full inventory with counted qty, theoretical stock, Trivec sales
  const[inventory,setInventory]=useState([]);

  const cats=['Tous','Viandes','Poissons','√âpicerie fine','Vins','Spiritueux','L√©gumes'];
  const filtered=filterCat==='Tous'?inventory:inventory.filter(i=>i.cat===filterCat);

  // Calculate theoretical stock: stockPrec + achats - ventesTrivec
  const calcTheorique=(item)=>Math.round((item.stockPrec+item.achats-item.ventesTrivec)*100)/100;
  // Ecart: compteInventaire - th√©orique
  const calcEcart=(item)=>Math.round((item.compteInventaire-calcTheorique(item))*100)/100;
  const calcEcartPct=(item)=>{const th=calcTheorique(item);return th!==0?Math.round((calcEcart(item)/th)*10000)/100:0;};
  const calcEcartValeur=(item)=>Math.round(calcEcart(item)*item.prixUnit*100)/100;

  const updateCompte=(id,val)=>{
    setInventory(prev=>prev.map(i=>i.id===id?{...i,compteInventaire:parseFloat(val)||0}:i));
  };

  const addItem=()=>{
    if(!newItem.nom)return;
    const id=Math.max(...inventory.map(i=>i.id))+1;
    setInventory(prev=>[...prev,{id,nom:newItem.nom,cat:newItem.cat,unite:newItem.unite,prixUnit:parseFloat(newItem.prixUnit)||0,seuil:parseFloat(newItem.seuil)||0,stockPrec:0,achats:0,ventesTrivec:0,compteInventaire:0}]);
    setNewItem({nom:'',cat:'Viandes',unite:'kg',prixUnit:0,seuil:0});
    setShowAddModal(false);
  };

  // Aggregated stats
  const totalEcartValeur=inventory.reduce((s,i)=>s+calcEcartValeur(i),0);
  const totalValeurStock=inventory.reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0);
  const itemsWithEcart=inventory.filter(i=>Math.abs(calcEcartPct(i))>5).length;
  const alertItems=inventory.filter(i=>i.compteInventaire<i.seuil);

  return(<div className="fin">
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">Valeur stock</div><div className="kpi-val">{eur(totalValeurStock)}</div><div className="kpi-chg neu">{inventory.length} r√©f√©rences</div></div>
      <div className="kpi"><div className="kpi-label">√âcart total</div><div className="kpi-val" style={{color:totalEcartValeur<0?'var(--rouge)':'var(--vert)'}}>{eur(totalEcartValeur)}</div><div className={`kpi-chg ${totalEcartValeur<0?'neg':'pos'}`}>{totalEcartValeur<0?'Coulage potentiel':'Exc√©dent'}</div></div>
      <div className="kpi"><div className="kpi-label">Produits en √©cart (&gt;5%)</div><div className="kpi-val">{itemsWithEcart}</div><div className="kpi-chg neg">sur {inventory.length} r√©f.</div></div>
      <div className="kpi"><div className="kpi-label">Alertes stock bas</div><div className="kpi-val">{alertItems.length}</div><div className="kpi-chg neg">{alertItems.filter(i=>i.compteInventaire<i.seuil*0.5).length} critiques</div></div>
    </div>

    <div className="tabs">
      <div className={`tab ${tab==='inventaire'?'active':''}`} onClick={()=>setTab('inventaire')}>Faire l'inventaire</div>
      <div className={`tab ${tab==='analyse'?'active':''}`} onClick={()=>setTab('analyse')}>Analyse √©carts (Trivec)</div>
      <div className={`tab ${tab==='alertes'?'active':''}`} onClick={()=>setTab('alertes')}>Alertes stock</div>
      <div className={`tab ${tab==='valeur'?'active':''}`} onClick={()=>setTab('valeur')}>Valeur par cat√©gorie</div>
    </div>

    {/* ===== TAB: INVENTAIRE ===== */}
    {tab==='inventaire'&&<div>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
        <div style={{display:'flex',gap:6}}>
          {cats.map(c=>(
            <button key={c} className={`btn btn-sm ${filterCat===c?'btn-primary':'btn-secondary'}`} onClick={()=>setFilterCat(c)}>{c}</button>
          ))}
        </div>
        <button className="btn btn-primary" onClick={()=>setShowAddModal(true)}>+ Ajouter un produit</button>
      </div>
      <div className="card">
        <div className="card-h">
          <div><div className="card-t">Inventaire ‚Äî Saisie des quantit√©s</div><div className="card-st">Renseignez les quantit√©s compt√©es physiquement. L'√©cart avec le stock th√©orique (ventes Trivec) est calcul√© automatiquement.</div></div>
          <div style={{display:'flex',gap:8,alignItems:'center'}}>
            <span className="badge b-ima">Trivec sync</span>
            <span className="badge b-info">28/02/2026</span>
          </div>
        </div>
        <div className="card-b tips-grid"><table>
          <thead><tr>
            <th style={{textAlign:'left',minWidth:180}}>Produit</th>
            <th>Cat√©gorie</th>
            <th>Unit√©</th>
            <th style={{textAlign:'right'}}>Prix unit.</th>
            <th style={{textAlign:'right',background:'var(--gris-100)'}}>Stock pr√©c.</th>
            <th style={{textAlign:'right',background:'var(--vert-light)'}}>Achats</th>
            <th style={{textAlign:'right',background:'var(--bleu-light)'}}>Ventes Trivec</th>
            <th style={{textAlign:'right',background:'var(--orange-light)'}}>Th√©orique</th>
            <th style={{textAlign:'center',background:'var(--bordeaux-10)',minWidth:80}}>Compt√©</th>
            <th style={{textAlign:'right'}}>√âcart</th>
            <th style={{textAlign:'right'}}>√âcart (‚Ç¨)</th>
            <th>Statut</th>
          </tr></thead>
          <tbody>
            {filtered.map(item=>{
              const theo=calcTheorique(item);
              const ecart=calcEcart(item);
              const ecartPct=calcEcartPct(item);
              const ecartVal=calcEcartValeur(item);
              const isBad=Math.abs(ecartPct)>5;
              const isVeryBad=Math.abs(ecartPct)>15;
              return(<tr key={item.id} style={{background:isVeryBad?'rgba(220,38,38,.04)':isBad?'rgba(217,119,6,.03)':'transparent'}}>
                <td style={{textAlign:'left',fontWeight:500}}>{item.nom}</td>
                <td><span className="badge b-ima" style={{fontSize:9}}>{item.cat}</span></td>
                <td style={{textAlign:'center',fontSize:11,color:'var(--gris-500)'}}>{item.unite}</td>
                <td style={{textAlign:'right',fontSize:12}}>{item.prixUnit}‚Ç¨</td>
                <td style={{textAlign:'right',background:'var(--gris-50)'}}>{item.stockPrec}</td>
                <td style={{textAlign:'right',color:'var(--vert)',fontWeight:500}}>+{item.achats}</td>
                <td style={{textAlign:'right',color:'var(--bleu)',fontWeight:500}}>-{item.ventesTrivec}</td>
                <td style={{textAlign:'right',fontWeight:600}}>{theo}</td>
                <td style={{textAlign:'center',background:'rgba(88,21,39,.03)'}}>
                  <input type="number" step="0.1" value={item.compteInventaire} onChange={e=>updateCompte(item.id,e.target.value)}
                    style={{width:65,padding:'5px 6px',border:`2px solid ${isBad?'var(--rouge)':'var(--gris-200)'}`,borderRadius:6,fontSize:13,textAlign:'center',fontWeight:700,fontFamily:'inherit',outline:'none',background:isBad?'var(--rouge-light)':'white'}}/>
                </td>
                <td style={{textAlign:'right',fontWeight:700,color:ecart<0?'var(--rouge)':ecart>0?'var(--vert)':'var(--gris-400)'}}>
                  {ecart>0?'+':''}{ecart} {item.unite}
                  <div style={{fontSize:9,fontWeight:500}}>({ecartPct>0?'+':''}{ecartPct}%)</div>
                </td>
                <td style={{textAlign:'right',fontWeight:600,color:ecartVal<0?'var(--rouge)':ecartVal>0?'var(--vert)':'var(--gris-400)'}}>
                  {ecartVal>0?'+':''}{eur(ecartVal)}
                </td>
                <td>
                  {isVeryBad?<span className="badge b-err">√âcart critique</span>:
                   isBad?<span className="badge b-warn">√Ä v√©rifier</span>:
                   <span className="badge b-ok">OK</span>}
                </td>
              </tr>);
            })}
          </tbody>
          <tfoot>
            <tr style={{fontWeight:700,background:'var(--gris-50)',borderTop:'2px solid var(--gris-300)'}}>
              <td style={{textAlign:'left'}}>TOTAL ({filtered.length} r√©f.)</td>
              <td/><td/><td/>
              <td style={{textAlign:'right'}}>{eur(filtered.reduce((s,i)=>s+(i.stockPrec*i.prixUnit),0))}</td>
              <td style={{textAlign:'right',color:'var(--vert)'}}>{eur(filtered.reduce((s,i)=>s+(i.achats*i.prixUnit),0))}</td>
              <td style={{textAlign:'right',color:'var(--bleu)'}}>{eur(filtered.reduce((s,i)=>s+(i.ventesTrivec*i.prixUnit),0))}</td>
              <td style={{textAlign:'right'}}>{eur(filtered.reduce((s,i)=>s+(calcTheorique(i)*i.prixUnit),0))}</td>
              <td style={{textAlign:'center'}}>{eur(filtered.reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0))}</td>
              <td colSpan="2" style={{textAlign:'right',color:totalEcartValeur<0?'var(--rouge)':'var(--vert)',fontSize:15}}>
                {totalEcartValeur>0?'+':''}{eur(totalEcartValeur)}
              </td>
              <td/>
            </tr>
          </tfoot>
        </table></div>
        <div style={{marginTop:14,padding:'10px 14px',background:'var(--gris-50)',borderRadius:8,fontSize:12,color:'var(--gris-600)'}}>
          <strong>Formule :</strong> Stock th√©orique = Stock pr√©c√©dent + Achats (Pennylane) ‚àí Ventes (Trivec) ¬∑ <strong>√âcart</strong> = Compt√© ‚àí Th√©orique ¬∑ Un √©cart n√©gatif indique un <strong style={{color:'var(--rouge)'}}>coulage potentiel</strong> (vol, casse, perte non d√©clar√©e)
        </div>
      </div>
    </div>}

    {/* ===== TAB: ANALYSE √âCARTS ===== */}
    {tab==='analyse'&&<div>
      <div className="card" style={{marginBottom:16}}>
        <div className="card-h"><div><div className="card-t">Analyse des √©carts ‚Äî Inventaire vs Ventes Trivec</div><div className="card-st">Produits avec un √©cart sup√©rieur √† 5% entre le stock compt√© et le stock th√©orique</div></div><span className="badge b-ima">Trivec √ó Pennylane</span></div>
        <div className="card-b">
          {(()=>{
            const problemItems=inventory.filter(i=>Math.abs(calcEcartPct(i))>5).sort((a,b)=>calcEcartValeur(a)-calcEcartValeur(b));
            const totalPerte=problemItems.reduce((s,i)=>s+calcEcartValeur(i),0);
            return(<div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14,marginBottom:20}}>
                <div className="cost-c">
                  <div className="cl">Produits en √©cart</div>
                  <div className="cv" style={{color:'var(--rouge)'}}>{problemItems.length}</div>
                  <div className="ct">sur {inventory.length} r√©f√©rences</div>
                </div>
                <div className="cost-c">
                  <div className="cl">Perte estim√©e (coulage)</div>
                  <div className="cv" style={{color:'var(--rouge)'}}>{eur(totalPerte)}</div>
                  <div className="ct">√† investiguer</div>
                </div>
                <div className="cost-c">
                  <div className="cl">Taux de coulage</div>
                  <div className="cv" style={{color:Math.abs(totalPerte/totalValeurStock*100)>3?'var(--rouge)':'var(--orange)'}}>{Math.abs(totalPerte/totalValeurStock*100).toFixed(1)}%</div>
                  <div className="ct">Seuil acceptable : 2-3%</div>
                </div>
              </div>
              <div className="tbl"><table>
                <thead><tr>
                  <th style={{textAlign:'left'}}>Produit</th><th>Cat√©gorie</th>
                  <th style={{textAlign:'right'}}>Th√©orique</th><th style={{textAlign:'right'}}>Compt√©</th>
                  <th style={{textAlign:'right'}}>√âcart (qty)</th><th style={{textAlign:'right'}}>√âcart (%)</th>
                  <th style={{textAlign:'right'}}>Perte (‚Ç¨)</th><th>Diagnostic</th>
                </tr></thead>
                <tbody>
                  {problemItems.map(item=>{
                    const theo=calcTheorique(item);
                    const ecart=calcEcart(item);
                    const ecartPct=calcEcartPct(item);
                    const ecartVal=calcEcartValeur(item);
                    const isVeryBad=Math.abs(ecartPct)>15;
                    // Auto-diagnosis
                    let diag='';let diagColor='';
                    if(ecart<0&&Math.abs(ecartPct)>15){diag='Coulage probable';diagColor='var(--rouge)';}
                    else if(ecart<0&&Math.abs(ecartPct)>5){diag='Perte / casse ?';diagColor='var(--orange)';}
                    else if(ecart>0&&ecartPct>10){diag='Erreur saisie ?';diagColor='var(--bleu)';}
                    else{diag='√Ä v√©rifier';diagColor='var(--orange)';}
                    return(<tr key={item.id} style={{background:isVeryBad?'rgba(220,38,38,.04)':'transparent'}}>
                      <td style={{textAlign:'left',fontWeight:600}}>{item.nom}</td>
                      <td><span className="badge b-ima" style={{fontSize:9}}>{item.cat}</span></td>
                      <td style={{textAlign:'right'}}>{theo} {item.unite}</td>
                      <td style={{textAlign:'right',fontWeight:600}}>{item.compteInventaire} {item.unite}</td>
                      <td style={{textAlign:'right',fontWeight:700,color:ecart<0?'var(--rouge)':'var(--vert)'}}>
                        {ecart>0?'+':''}{ecart} {item.unite}
                      </td>
                      <td style={{textAlign:'right',fontWeight:700,color:ecartPct<-5?'var(--rouge)':'var(--orange)'}}>
                        {ecartPct>0?'+':''}{ecartPct}%
                      </td>
                      <td style={{textAlign:'right',fontWeight:700,color:ecartVal<0?'var(--rouge)':'var(--vert)'}}>
                        {ecartVal>0?'+':''}{eur(ecartVal)}
                      </td>
                      <td><span style={{fontSize:12,fontWeight:600,color:diagColor}}>{diag}</span></td>
                    </tr>);
                  })}
                </tbody>
                <tfoot><tr style={{fontWeight:700,background:'var(--gris-50)',borderTop:'2px solid var(--gris-300)'}}>
                  <td style={{textAlign:'left'}}>TOTAL PERTES</td><td/><td/><td/><td/><td/>
                  <td style={{textAlign:'right',color:'var(--rouge)',fontSize:16}}>{eur(totalPerte)}</td><td/>
                </tr></tfoot>
              </table></div>
            </div>);
          })()}
        </div>
      </div>

      {/* √âcarts par cat√©gorie */}
      <div className="card">
        <div className="card-h"><div><div className="card-t">√âcarts par cat√©gorie</div><div className="card-st">Valeur des √©carts agr√©g√©s par famille de produits</div></div></div>
        <div className="card-b">
          <HBar data={cats.filter(c=>c!=='Tous').map(c=>{
            const items=inventory.filter(i=>i.cat===c);
            const ecartTotal=items.reduce((s,i)=>s+calcEcartValeur(i),0);
            return{label:c,value:Math.abs(ecartTotal),display:`${ecartTotal>0?'+':''}${eur(ecartTotal)}`};
          }).sort((a,b)=>b.value-a.value)} maxVal={Math.max(...cats.filter(c=>c!=='Tous').map(c=>Math.abs(inventory.filter(i=>i.cat===c).reduce((s,i)=>s+calcEcartValeur(i),0))))} color="var(--rouge)"/>
        </div>
      </div>
    </div>}

    {/* ===== TAB: ALERTES ===== */}
    {tab==='alertes'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Alertes stock bas</div><div className="card-st">Produits sous le seuil minimum de r√©approvisionnement</div></div></div>
        <div className="card-b"><div className="tbl"><table>
          <thead><tr><th style={{textAlign:'left'}}>Produit</th><th>Cat√©gorie</th><th style={{textAlign:'right'}}>Stock actuel</th><th style={{textAlign:'right'}}>Seuil</th><th style={{width:120}}>Niveau</th><th>Urgence</th></tr></thead>
          <tbody>
            {alertItems.sort((a,b)=>(a.compteInventaire/a.seuil)-(b.compteInventaire/b.seuil)).map(item=>{
              const pct=item.compteInventaire/item.seuil;
              const critique=pct<0.5;
              return(<tr key={item.id}>
                <td style={{textAlign:'left',fontWeight:500}}>{item.nom}</td>
                <td><span className="badge b-ima" style={{fontSize:9}}>{item.cat}</span></td>
                <td style={{textAlign:'right',fontWeight:700,color:critique?'var(--rouge)':'var(--orange)'}}>{item.compteInventaire} {item.unite}</td>
                <td style={{textAlign:'right'}}>{item.seuil} {item.unite}</td>
                <td><div className="pbar"><div className="pfill" style={{width:`${Math.min(pct*100,100)}%`,background:critique?'var(--rouge)':'var(--orange)'}}/></div></td>
                <td><span className={`badge ${critique?'b-err':'b-warn'}`}>{critique?'Critique':'Alerte'}</span></td>
              </tr>);
            })}
          </tbody>
        </table></div></div>
      </div>
    </div>}

    {/* ===== TAB: VALEUR ===== */}
    {tab==='valeur'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Valeur stock par cat√©gorie</div></div></div>
        <div className="card-b">
          <HBar data={cats.filter(c=>c!=='Tous').map(c=>{
            const v=inventory.filter(i=>i.cat===c).reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0);
            return{label:c,value:v};
          }).sort((a,b)=>b.value-a.value)} maxVal={Math.max(...cats.filter(c=>c!=='Tous').map(c=>inventory.filter(i=>i.cat===c).reduce((s,i)=>s+(i.compteInventaire*i.prixUnit),0)))}/>
        </div>
      </div>
    </div>}

    {/* ===== MODAL: AJOUTER PRODUIT ===== */}
    {showAddModal&&<div className="modal-overlay" onClick={()=>setShowAddModal(false)}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <h3>Ajouter un produit <button className="modal-close" onClick={()=>setShowAddModal(false)}>√ó</button></h3>
        <div className="fg"><label className="fl">Nom du produit</label><input className="fi" value={newItem.nom} onChange={e=>setNewItem(p=>({...p,nom:e.target.value}))} placeholder="Ex: Truffe noire P√©rigord"/></div>
        <div className="fg-row">
          <div className="fg"><label className="fl">Cat√©gorie</label>
            <select className="fi-select" value={newItem.cat} onChange={e=>setNewItem(p=>({...p,cat:e.target.value}))}>
              {cats.filter(c=>c!=='Tous').map(c=><option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div className="fg"><label className="fl">Unit√©</label>
            <select className="fi-select" value={newItem.unite} onChange={e=>setNewItem(p=>({...p,unite:e.target.value}))}>
              {['kg','g','L','cl','bt','pcs','botte'].map(u=><option key={u} value={u}>{u}</option>)}
            </select>
          </div>
        </div>
        <div className="fg-row">
          <div className="fg"><label className="fl">Prix unitaire (‚Ç¨)</label><input className="fi" type="number" step="0.01" value={newItem.prixUnit||''} onChange={e=>setNewItem(p=>({...p,prixUnit:e.target.value}))} placeholder="0.00"/></div>
          <div className="fg"><label className="fl">Seuil d'alerte</label><input className="fi" type="number" step="0.1" value={newItem.seuil||''} onChange={e=>setNewItem(p=>({...p,seuil:e.target.value}))} placeholder="0"/></div>
        </div>
        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:20}}>
          <button className="btn btn-secondary" onClick={()=>setShowAddModal(false)}>Annuler</button>
          <button className="btn btn-primary" onClick={addItem}>Ajouter</button>
        </div>
      </div>
    </div>}
  </div>);
}

// ===== CRM =====
function CRMPage(){
  return(<div className="fin">
    <div style={{background:'var(--bleu-light)',border:'1px solid var(--bleu)',borderRadius:10,padding:16,marginBottom:20,fontSize:13,color:'var(--bleu)'}}>
      <strong>CRM & R√©servations</strong> ‚Äî Cette page affichera les donn√©es SevenRooms une fois le service connect√©.
    </div>
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">R√©servations</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente SevenRooms</div></div>
      <div className="kpi"><div className="kpi-label">Taux occupation</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente</div></div>
      <div className="kpi"><div className="kpi-label">Clients VIP</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente</div></div>
      <div className="kpi"><div className="kpi-label">Note moyenne</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente</div></div>
    </div>
    <div className="card">
      <div className="card-h"><div><div className="card-t">R√©servations</div><div className="card-st">SevenRooms</div></div><span className="badge b-warn">Non connect√©</span></div>
      <div className="card-b" style={{padding:50,textAlign:'center',color:'var(--gris-400)'}}>
        <div style={{fontSize:32,marginBottom:10}}>üìã</div>
        <div style={{fontWeight:500,marginBottom:4}}>Connectez SevenRooms pour afficher les r√©servations</div>
        <div style={{fontSize:11}}>Rendez-vous dans Administration ‚Üí Int√©grations</div>
      </div>
    </div>
  </div>);
}

// ===== POS =====
function POSPage(){
  return(<div className="fin">
    <div style={{background:'var(--bleu-light)',border:'1px solid var(--bleu)',borderRadius:10,padding:16,marginBottom:20,fontSize:13,color:'var(--bleu)'}}>
      <strong>Caisses Trivec</strong> ‚Äî Cette page affichera les donn√©es de vente une fois Trivec connect√©.
    </div>
    <div className="kpi-g">
      <div className="kpi"><div className="kpi-label">CA POS (mois)</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente Trivec</div></div>
      <div className="kpi"><div className="kpi-label">Ticket moyen</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente</div></div>
      <div className="kpi"><div className="kpi-label">Transactions</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente</div></div>
      <div className="kpi"><div className="kpi-label">Panier bar moy.</div><div className="kpi-val" style={{color:'var(--gris-300)'}}>‚Äî</div><div className="kpi-chg neu">En attente</div></div>
    </div>
    <div className="card">
      <div className="card-h"><div><div className="card-t">Ventes par cat√©gorie</div><div className="card-st">Trivec POS</div></div><span className="badge b-warn">Non connect√©</span></div>
      <div className="card-b" style={{padding:50,textAlign:'center',color:'var(--gris-400)'}}>
        <div style={{fontSize:32,marginBottom:10}}>üßæ</div>
        <div style={{fontWeight:500,marginBottom:4}}>Connectez Trivec pour afficher les ventes</div>
        <div style={{fontSize:11}}>Rendez-vous dans Administration ‚Üí Int√©grations</div>
      </div>
    </div>
  </div>);
}

// ===== CL√îTURE DE CAISSE =====
function CaissePage(){
  const[tab,setTab]=useState('saisie');
  const[entries,setEntries]=useState(()=>{
    try{return JSON.parse(localStorage.getItem('ima_caisse_v2')||'[]');}catch(e){return[];}
  });
  const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];

  // Default empty entry structure
  const emptyEntry={
    date:new Date().toISOString().split('T')[0],
    dayOfWeek:new Date().getDay(),
    nom:'',responsable:'',
    caDomino:{liquide10:0,liquide20:0,solide10:0,solide20:0,tips:0,virement:0},
    caDept:{restaurant:0,club:0,bar:0},
    rapprochement:{domino:{especes:0,cb:0,amex:0,tipsCb:0,tipsAmex:0,entree:0,creditClient:0,virement:0,sevenroom:0},reel:{especes:0,cb:0,amex:0,tipsCb:0,tipsAmex:0,entree:0,creditClient:0,virement:0,sevenroom:0}},
    tipsDetails:{restoEsp:0,restoCb:0,clubEsp:0,clubCb:0},
    creditClients:[],creditClientsRembt:[],
    detailEspeces:{500:0,200:0,100:0,50:0,20:0,10:0,5:0,2:0,1:0,0.50:0,0.20:0,0.10:0,0.05:0,0.02:0,0.01:0},
    commentaires:'',teleCb:0,teleAmex:0
  };

  const[formData,setFormData]=useState(emptyEntry);

  const handleInputChange=(path,value)=>{
    const parts=path.split('.');
    setFormData(prev=>{
      const copy={...prev};
      let current=copy;
      for(let i=0;i<parts.length-1;i++){
        if(!current[parts[i]])current[parts[i]]={};
        current=current[parts[i]];
      }
      current[parts[parts.length-1]]=isNaN(value)?value:parseFloat(value)||0;
      return copy;
    });
  };

  const getCATotals=()=>{
    const d=formData.caDomino;
    const total=d.liquide10+d.liquide20+d.solide10+d.solide20+d.tips+d.virement;
    return{total,netTotal:formData.caDept.restaurant+formData.caDept.club+formData.caDept.bar};
  };

  const getRapprochTotals=()=>{
    const calc=(section)=>Object.values(section).reduce((s,v)=>s+v,0);
    const domTotal=calc(formData.rapprochement.domino);
    const realTotal=calc(formData.rapprochement.reel);
    return{domTotal,realTotal,ecart:realTotal-domTotal};
  };

  const getCashTotals=()=>{
    const details=formData.detailEspeces;
    const denoms=[500,200,100,50,20,10,5,2,1,0.50,0.20,0.10,0.05,0.02,0.01];
    let total=0;
    denoms.forEach(d=>{
      total+=(details[d]||0)*d;
    });
    return total;
  };

  const handleSaveEntry=()=>{
    const newEntry={...formData,id:Date.now(),createdAt:new Date().toISOString()};
    setEntries(prev=>{const updated=[newEntry,...prev];localStorage.setItem('ima_caisse_v2',JSON.stringify(updated));return updated;});
    setFormData(emptyEntry);
    alert('Saisie enregistr√©e avec succ√®s !');
  };

  const SectionCard=({title,children})=>(
    <div style={{background:'var(--blanc)',border:'1px solid var(--gris-200)',borderRadius:12,padding:18,marginBottom:16}}>
      <div style={{fontSize:13,fontWeight:600,color:'var(--gris-800)',marginBottom:14,textTransform:'uppercase',letterSpacing:'0.5px'}}>{title}</div>
      {children}
    </div>
  );

  const NumInput=({label,value,onChange,readOnly=false})=>(
    <div className="fg" style={{marginBottom:12}}>
      <label className="fl">{label}</label>
      <input type="number" step="0.01" className="fi" value={value} onChange={e=>onChange(e.target.value)} readOnly={readOnly} style={{backgroundColor:readOnly?'var(--gris-50)':undefined}}/>
    </div>
  );

  return(<div className="fin">
    <div className="tabs">
      <div className={`tab ${tab==='saisie'?'active':''}`} onClick={()=>setTab('saisie')}>Saisie du jour</div>
      <div className={`tab ${tab==='recap'?'active':''}`} onClick={()=>setTab('recap')}>R√©cap semaine</div>
      <div className={`tab ${tab==='historique'?'active':''}`} onClick={()=>setTab('historique')}>Historique</div>
    </div>

    {tab==='saisie'&&<div>
      <SectionCard title="Donn√©es Domino (POS)">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
          <NumInput label="Date" value={formData.date} onChange={v=>handleInputChange('date',v)}/>
          <div className="fg">
            <label className="fl">Responsable</label>
            <select className="fi-select" value={formData.responsable} onChange={e=>handleInputChange('responsable',e.target.value)}>
              <option value="">‚Äî S√©lectionner ‚Äî</option>
              {StaffRegistry.getResponsables().length>0?
                StaffRegistry.getResponsables().map(emp=><option key={emp.id} value={emp.nom}>{emp.nom} ‚Äî {emp.poste}</option>):
                StaffRegistry.getActive().map(emp=><option key={emp.id} value={emp.nom}>{emp.nom} ‚Äî {emp.poste}</option>)
              }
            </select>
          </div>
        </div>
        <div style={{fontSize:12,fontWeight:600,color:'var(--gris-700)',marginBottom:10,marginTop:16}}>CA DOMINO D√©tails</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginBottom:16}}>
          <NumInput label="LIQUIDE 10%" value={formData.caDomino.liquide10} onChange={v=>handleInputChange('caDomino.liquide10',v)}/>
          <NumInput label="LIQUIDE 20%" value={formData.caDomino.liquide20} onChange={v=>handleInputChange('caDomino.liquide20',v)}/>
          <NumInput label="SOLIDE 10%" value={formData.caDomino.solide10} onChange={v=>handleInputChange('caDomino.solide10',v)}/>
          <NumInput label="SOLIDE 20%" value={formData.caDomino.solide20} onChange={v=>handleInputChange('caDomino.solide20',v)}/>
          <NumInput label="TIPS" value={formData.caDomino.tips} onChange={v=>handleInputChange('caDomino.tips',v)}/>
          <NumInput label="VIREMENT" value={formData.caDomino.virement} onChange={v=>handleInputChange('caDomino.virement',v)}/>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,marginBottom:16,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span>TOTAL CA TTC:</span><span style={{fontSize:16,color:'var(--bordeaux)'}}>{eur(getCATotals().total)}</span>
        </div>
        <div style={{fontSize:12,fontWeight:600,color:'var(--gris-700)',marginBottom:10}}>CA par D√©partement</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
          <NumInput label="CA RESTAURANT" value={formData.caDept.restaurant} onChange={v=>handleInputChange('caDept.restaurant',v)}/>
          <NumInput label="CA CLUB" value={formData.caDept.club} onChange={v=>handleInputChange('caDept.club',v)}/>
          <NumInput label="CA BAR" value={formData.caDept.bar} onChange={v=>handleInputChange('caDept.bar',v)}/>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,marginTop:12,display:'flex',justifyContent:'space-between'}}>
          <span>TOTAL CA NET:</span><span style={{fontSize:16,color:'var(--bordeaux)'}}>{eur(getCATotals().netTotal)}</span>
        </div>
      </SectionCard>

      <SectionCard title="Rapprochement Domino vs R√©el">
        <div style={{overflowX:'auto'}}>
          <table style={{width:'100%',borderCollapse:'collapse',marginBottom:12}}>
            <thead><tr style={{background:'var(--gris-50)',borderBottom:'2px solid var(--gris-200)'}}>
              <th style={{padding:'8px',textAlign:'left',fontWeight:600,fontSize:11}}>Ligne</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>DOMINO</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>R√âEL</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>√âCART</th>
            </tr></thead>
            <tbody>
              {['especes','cb','amex','tipsCb','tipsAmex','entree','creditClient','virement','sevenroom'].map(key=>{
                const d=formData.rapprochement.domino[key]||0;
                const r=formData.rapprochement.reel[key]||0;
                const ecart=r-d;
                return(<tr key={key} style={{borderBottom:'1px solid var(--gris-100)'}}>
                  <td style={{padding:'8px',fontSize:12,fontWeight:500}}>{key.replace(/([A-Z])/g,' $1').trim().toUpperCase()}</td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12}}><input type="number" step="0.01" style={{width:'70px',padding:'4px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'right'}} value={d} onChange={e=>handleInputChange(`rapprochement.domino.${key}`,e.target.value)}/></td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12}}><input type="number" step="0.01" style={{width:'70px',padding:'4px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'right'}} value={r} onChange={e=>handleInputChange(`rapprochement.reel.${key}`,e.target.value)}/></td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12,fontWeight:600,color:ecart===0?'var(--vert)':'var(--rouge)',background:ecart===0?'var(--vert-light)':'var(--rouge-light)',borderRadius:4}}>{eur(ecart)}</td>
                </tr>);
              })}
            </tbody>
          </table>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,display:'flex',justifyContent:'space-between'}}>
          <span>TOTAL CA RECEIVED:</span><span style={{fontSize:16,color:'var(--bordeaux)'}}>{eur(getRapprochTotals().realTotal)}</span>
        </div>
      </SectionCard>

      <SectionCard title="Tips">
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
          <NumInput label="Tips Resto ESP" value={formData.tipsDetails.restoEsp} onChange={v=>handleInputChange('tipsDetails.restoEsp',v)}/>
          <NumInput label="Tips Resto CB" value={formData.tipsDetails.restoCb} onChange={v=>handleInputChange('tipsDetails.restoCb',v)}/>
          <NumInput label="Tips Club ESP" value={formData.tipsDetails.clubEsp} onChange={v=>handleInputChange('tipsDetails.clubEsp',v)}/>
          <NumInput label="Tips Club CB" value={formData.tipsDetails.clubCb} onChange={v=>handleInputChange('tipsDetails.clubCb',v)}/>
        </div>
      </SectionCard>

      <SectionCard title="D√©tails Esp√®ces (Cash Counting)">
        <div style={{overflowX:'auto'}}>
          <table style={{width:'100%',borderCollapse:'collapse',marginBottom:12}}>
            <thead><tr style={{background:'var(--gris-50)',borderBottom:'2px solid var(--gris-200)'}}>
              <th style={{padding:'8px',textAlign:'left',fontWeight:600,fontSize:11}}>D√©nomination</th>
              <th style={{padding:'8px',textAlign:'center',fontWeight:600,fontSize:11}}>NOMBRE</th>
              <th style={{padding:'8px',textAlign:'right',fontWeight:600,fontSize:11}}>MONTANT</th>
            </tr></thead>
            <tbody>
              {[500,200,100,50,20,10,5,2,1,0.50,0.20,0.10,0.05,0.02,0.01].map(denom=>{
                const count=formData.detailEspeces[denom]||0;
                const amount=count*denom;
                return(<tr key={denom} style={{borderBottom:'1px solid var(--gris-100)'}}>
                  <td style={{padding:'8px',fontSize:12,fontWeight:500}}>{denom>=1?'‚Ç¨'+denom.toFixed(0):'‚Ç¨'+denom.toFixed(2)}</td>
                  <td style={{padding:'8px',textAlign:'center'}}><input type="number" style={{width:'60px',padding:'4px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'center'}} value={count} onChange={e=>handleInputChange(`detailEspeces.${denom}`,parseInt(e.target.value)||0)}/></td>
                  <td style={{padding:'8px',textAlign:'right',fontSize:12,background:'var(--gris-50)',fontWeight:500}}>{eur(amount)}</td>
                </tr>);
              })}
            </tbody>
          </table>
        </div>
        <div style={{background:'var(--gris-50)',padding:12,borderRadius:8,fontSize:13,fontWeight:600,display:'flex',justifyContent:'space-between'}}>
          <span>TOTAL ESP√àCES:</span><span style={{fontSize:16,color:'var(--vert)'}}>{eur(getCashTotals())}</span>
        </div>
      </SectionCard>

      <SectionCard title="T√©l√©collecte">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <NumInput label="TELE CB" value={formData.teleCb} onChange={v=>handleInputChange('teleCb',v)}/>
          <NumInput label="TELE AMEX" value={formData.teleAmex} onChange={v=>handleInputChange('teleAmex',v)}/>
        </div>
      </SectionCard>

      <SectionCard title="Commentaires">
        <textarea className="fi" style={{fontFamily:'inherit',minHeight:80,width:'100%',resize:'vertical',padding:12}} value={formData.commentaires} onChange={e=>handleInputChange('commentaires',e.target.value)} placeholder="Notes du jour..."/>
      </SectionCard>

      <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:16}}>
        <button className="btn btn-primary" onClick={handleSaveEntry}>Enregistrer la saisie</button>
      </div>
    </div>}

    {tab==='recap'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">R√©capitulatif Semaine</div><div className="card-st">Synth√®se de la semaine en cours</div></div></div>
        <div className="card-b"><div style={{overflowX:'auto'}}>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}>
            <thead><tr style={{background:'var(--gris-50)',borderBottom:'2px solid var(--gris-200)'}}>
              <th style={{padding:'10px',textAlign:'left',fontWeight:600,fontSize:11}}>Indicateur</th>
              {days.map(d=><th key={d} style={{padding:'10px',textAlign:'right',fontWeight:600,fontSize:11}}>{d}</th>)}
              <th style={{padding:'10px',textAlign:'right',fontWeight:600,fontSize:11,color:'var(--bordeaux)'}}>TOTAL</th>
            </tr></thead>
            <tbody>
              {['TOTAL CA TTC','TOTAL CA NET','ENCAISSEMENT REEL','ECART REEL/DOMINO','ESPECES','CB','AMEX','CREDIT CLIENT','VIREMENT','SEVENROOM','TELE CB','TELE AMEX'].map(metric=>(
                <tr key={metric} style={{borderBottom:'1px solid var(--gris-100)'}}>
                  <td style={{padding:'10px',fontWeight:500}}>{metric}</td>
                  {days.map(d=><td key={d} style={{padding:'10px',textAlign:'right',background:'var(--gris-50)'}}>‚Äî</td>)}
                  <td style={{padding:'10px',textAlign:'right',fontWeight:600,color:'var(--bordeaux)'}}>‚Äî</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div></div>
      </div>
    </div>}

    {tab==='historique'&&<div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Historique des Saisies</div><div className="card-st">{entries.length} enregistrements</div></div></div>
        <div className="card-b">
          {entries.length===0?<div style={{textAlign:'center',padding:40,color:'var(--gris-400)'}}>Aucune saisie enregistr√©e</div>:
          <div className="tbl"><table>
            <thead><tr><th>Date</th><th>Responsable</th><th style={{textAlign:'right'}}>CA TTC</th><th style={{textAlign:'right'}}>Total R√©el</th><th style={{textAlign:'right'}}>√âcart</th></tr></thead>
            <tbody>
              {entries.map(e=>{
                const totals=getRapprochTotals();
                return(<tr key={e.id} style={{cursor:'pointer'}}>
                  <td style={{fontWeight:500}}>{new Date(e.date).toLocaleDateString('fr-FR')}</td>
                  <td>{e.responsable}</td>
                  <td style={{textAlign:'right'}}>{eur(getCATotals().total)}</td>
                  <td style={{textAlign:'right'}}>{eur(totals.realTotal)}</td>
                  <td style={{textAlign:'right',fontWeight:600,color:totals.ecart===0?'var(--vert)':'var(--rouge)'}}>{eur(totals.ecart)}</td>
                </tr>);
              })}
            </tbody>
          </table></div>}
        </div>
      </div>
    </div>}
  </div>);
}

// ===== TIPS PAGE =====
function TipsPage(){
  const[tab,setTab]=useState('salle');
  const[params,setParams]=useState(()=>{
    try{return JSON.parse(localStorage.getItem('ima_tips_params')||JSON.stringify({totalTipsWeek:0,cuisineSplit:15}));}catch(e){
      return{totalTipsWeek:0,cuisineSplit:15};
    }
  });
  const[joursTravailles,setJoursTravailles]=useState(()=>{
    try{return JSON.parse(localStorage.getItem('ima_tips_period')||JSON.stringify({}));}catch(e){
      return{};
    }
  });

  const handleUpdateJours=(empId,value)=>{
    const updated={...joursTravailles,[empId]:parseFloat(value)||0};
    setJoursTravailles(updated);
    localStorage.setItem('ima_tips_period',JSON.stringify(updated));
  };

  const calculateTotalsForSection=(section)=>{
    let totalPoints=0;
    StaffRegistry.getBySection(section).forEach(emp=>{
      const days=joursTravailles[emp.id]||0;
      totalPoints+=(emp.points||0)*days;
    });
    return totalPoints;
  };

  const getSectionTips=(section)=>{
    if(section==='salle')return params.totalTipsWeek*(1-(params.cuisineSplit||15)/100);
    return params.totalTipsWeek*(params.cuisineSplit||15)/100;
  };

  const SectionTab=({section})=>{
    const employees=StaffRegistry.getBySection(section);
    const tipsEligible=employees.filter(e=>e.tips);
    const totalPtsSection=calculateTotalsForSection(section);
    const sectionTips=getSectionTips(section);
    const valPtJour=totalPtsSection>0?sectionTips/totalPtsSection:0;

    const groupedByCategory={};
    Object.keys(TIP_CATEGORIES[section]||{}).forEach(cat=>{
      groupedByCategory[cat]=tipsEligible.filter(e=>e.tipCategory===cat);
    });

    return(
      <div className="card">
        <div className="card-h"><div><div className="card-t">Distribution Tips ‚Äî {section==='salle'?'SALLE':'CUISINE'}</div><div className="card-st">{section==='salle'?'Restaurant, Bar, Accueil':'Kitchen staff'}</div></div></div>
        <div className="card-b">
          {Object.entries(groupedByCategory).map(([catKey,empList])=>{
            const catData=TIP_CATEGORIES[section][catKey];
            return(<div key={catKey} style={{marginBottom:24}}>
              <div style={{background:catData.color,color:'white',padding:10,borderRadius:6,marginBottom:12,fontSize:12,fontWeight:600}}>{catData.label}</div>
              {empList.length===0?<div style={{color:'var(--gris-400)',fontSize:12,padding:10}}>Aucun employ√© assign√©</div>:(
                <div style={{overflowX:'auto',marginBottom:12}}>
                  <table style={{width:'100%',borderCollapse:'collapse',fontSize:11}}>
                    <thead><tr style={{background:'var(--gris-100)',borderBottom:'1px solid var(--gris-300)'}}>
                      <th style={{padding:'8px',textAlign:'left',fontWeight:600}}>NOM</th>
                      <th style={{padding:'8px',textAlign:'center',fontWeight:600}}>POINTS</th>
                      <th style={{padding:'8px',textAlign:'center',fontWeight:600}}>JOURS</th>
                      <th style={{padding:'8px',textAlign:'right',fontWeight:600}}>POINTS/JOUR</th>
                      <th style={{padding:'8px',textAlign:'right',fontWeight:600}}>MONTANT TIPS</th>
                    </tr></thead>
                    <tbody>
                      {empList.map(emp=>{
                        const days=joursTravailles[emp.id]||0;
                        const ptsJour=emp.points*days;
                        const montant=ptsJour*valPtJour;
                        return(<tr key={emp.id} style={{borderBottom:'1px solid var(--gris-100)'}}>
                          <td style={{padding:'8px',fontWeight:500}}>{emp.nom}</td>
                          <td style={{padding:'8px',textAlign:'center',fontWeight:600}}>{emp.points}</td>
                          <td style={{padding:'8px',textAlign:'center'}}><input type="number" step="0.5" min="0" max="7" style={{width:'50px',padding:'4px 6px',border:'1px solid var(--gris-200)',borderRadius:4,fontSize:11,textAlign:'center',fontFamily:'inherit'}} value={days} onChange={e=>handleUpdateJours(emp.id,e.target.value)}/></td>
                          <td style={{padding:'8px',textAlign:'right',fontSize:11,fontWeight:600,background:'var(--gris-50)'}}>{ptsJour.toFixed(1)}</td>
                          <td style={{padding:'8px',textAlign:'right',fontSize:11,fontWeight:600,background:'var(--vert-light)',color:'var(--vert)'}}>{eur(montant)}</td>
                        </tr>);
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>);
          })}
          <div style={{marginTop:20,padding:'12px',background:'var(--gris-50)',borderRadius:8,fontSize:12}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
              <span style={{fontWeight:600}}>Total points-jours ({section}):</span>
              <span style={{fontWeight:700}}>{totalPtsSection.toFixed(1)}</span>
            </div>
            <div style={{display:'flex',justifyContent:'space-between'}}>
              <span style={{fontWeight:600}}>Valeur point/jour:</span>
              <span style={{fontWeight:700}}>{eur(valPtJour)}</span>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return(<div className="fin">
    <div className="card" style={{marginBottom:20}}>
      <div className="card-h"><div><div className="card-t">Synth√®se Tips Semaine</div></div></div>
      <div className="card-b">
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14}}>
          <div><div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500,marginBottom:4,textTransform:'uppercase'}}>Total Tips Semaine</div><div style={{fontSize:18,fontWeight:700,color:'var(--vert)'}}>{eur(params.totalTipsWeek)}</div></div>
          <div><div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500,marginBottom:4,textTransform:'uppercase'}}>Tips Cuisine ({params.cuisineSplit}%)</div><div style={{fontSize:18,fontWeight:700,color:'var(--orange)'}}>{eur(getSectionTips('cuisine'))}</div></div>
          <div><div style={{fontSize:10,color:'var(--gris-500)',fontWeight:500,marginBottom:4,textTransform:'uppercase'}}>Tips Salle ({100-params.cuisineSplit}%)</div><div style={{fontSize:18,fontWeight:700,color:'var(--bleu)'}}>{eur(getSectionTips('salle'))}</div></div>
        </div>
      </div>
    </div>

    <div className="tabs">
      <div className={`tab ${tab==='salle'?'active':''}`} onClick={()=>setTab('salle')}>Salle</div>
      <div className={`tab ${tab==='cuisine'?'active':''}`} onClick={()=>setTab('cuisine')}>Cuisine</div>
      <div className={`tab ${tab==='parametres'?'active':''}`} onClick={()=>setTab('parametres')}>Param√®tres</div>
    </div>

    {tab==='salle'&&<SectionTab section="salle"/>}
    {tab==='cuisine'&&<SectionTab section="cuisine"/>}

    {tab==='parametres'&&<div className="card">
      <div className="card-h"><div><div className="card-t">Param√®tres Tips</div></div></div>
      <div className="card-b">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20}}>
          <div className="fg">
            <label className="fl">Total Tips Semaine (‚Ç¨)</label>
            <input type="number" step="0.01" className="fi" value={params.totalTipsWeek} onChange={e=>{
              const val=parseFloat(e.target.value)||0;
              const newParams={...params,totalTipsWeek:val};
              setParams(newParams);
              localStorage.setItem('ima_tips_params',JSON.stringify(newParams));
            }}/>
          </div>
          <div className="fg">
            <label className="fl">Split Cuisine (%)</label>
            <input type="number" step="1" className="fi" value={params.cuisineSplit} onChange={e=>{
              const val=parseFloat(e.target.value)||15;
              const newParams={...params,cuisineSplit:val};
              setParams(newParams);
              localStorage.setItem('ima_tips_params',JSON.stringify(newParams));
            }}/>
          </div>
        </div>
      </div>
    </div>}
  </div>);
}

// ===== SETTINGS =====
function Settings(){
  const[token,setToken]=useState(PennylaneService.getToken()||'');
  const[showToken,setShowToken]=useState(false);
  const[testStatus,setTestStatus]=useState(null);
  const[testing,setTesting]=useState(false);
  const[showInviteModal,setShowInviteModal]=useState(false);
  const[inviteData,setInviteData]=useState({nom:'',email:'',role:'Directeur',password:Math.random().toString(36).slice(-8)});
  const[inviteStatus,setInviteStatus]=useState(null);

  const handleInviteUser=()=>{
    if(!inviteData.nom||!inviteData.email){setInviteStatus({success:false,msg:'Nom et email requis'});return;}
    const result=UserManager.addUser(inviteData);
    if(result.error){setInviteStatus({success:false,msg:result.error});return;}
    // Send invitation email via mailto (or EmailJS in future)
    const subject=encodeURIComponent('Invitation au Dashboard IMA');
    const body=encodeURIComponent(`Bonjour ${inviteData.nom},\n\nVous √™tes invit√©(e) √† acc√©der au Dashboard IMA ‚Äî Tour de contr√¥le.\n\nURL : https://dashboard.ima-club.com\nEmail : ${inviteData.email}\nMot de passe temporaire : ${inviteData.password}\nR√¥le : ${inviteData.role}\n\nMerci de changer votre mot de passe apr√®s votre premi√®re connexion.\n\nCordialement,\n${UserManager.getCurrentUser()?.nom||'IMA'}`);
    window.open(`mailto:${inviteData.email}?subject=${subject}&body=${body}`,'_blank');
    setInviteStatus({success:true,msg:`Invitation cr√©√©e pour ${inviteData.nom}. L'email s'ouvre dans votre messagerie.`});
    setInviteData({nom:'',email:'',role:'Directeur',password:Math.random().toString(36).slice(-8)});
    setTimeout(()=>setShowInviteModal(false),2000);
  };

  const handleSaveToken=()=>{
    if(token){
      PennylaneService.setToken(token);
      setTestStatus({success:true,msg:'Token sauvegard√©'});
    }
  };

  const[companyInfo,setCompanyInfo]=useState(null);

  const handleTestConnection=async()=>{
    if(!token){
      setTestStatus({success:false,msg:'Veuillez entrer un token d\'abord'});
      return;
    }
    PennylaneService.setToken(token);
    setTesting(true);
    const result=await PennylaneService.testConnection();
    if(result.success){
      setTestStatus({success:true,msg:'Connexion r√©ussie !'});
      setCompanyInfo(result.company);
      setConnectedIntegrations(prev=>({...prev,pennylane:true}));
    }else{
      setTestStatus({success:false,msg:'Erreur: '+result.error});
    }
    setTesting(false);
  };

  const[connectedIntegrations,setConnectedIntegrations]=useState({
    trivec:false,sevenrooms:false,pennylane:!!PennylaneService.getToken()
  });

  const handleClearToken=()=>{
    PennylaneService.clearToken();
    setToken('');
    setTestStatus({success:false,msg:'Token supprim√©'});
    setConnectedIntegrations({...connectedIntegrations,pennylane:false});
  };

  return(<div className="fin">
    <div className="tabs"><div className="tab active">G√©n√©ral</div><div className="tab">Utilisateurs</div><div className="tab">√âtablissements</div><div className="tab">Int√©grations</div></div>
    <div className="cg">
      <div className="card">
        <div className="card-h"><div><div className="card-t">√âtablissements</div></div></div>
        <div className="card-b">
          <div style={{padding:'14px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div><div style={{fontWeight:600}}>IMA ‚Äî Val d'Is√®re</div><div style={{fontSize:11,color:'var(--gris-400)'}}>Restaurant gastronomique & bar</div></div>
            <span className="badge b-ok">Actif</span>
          </div>
          <div style={{padding:'14px 0',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div><div style={{fontWeight:600,color:'var(--gris-400)'}}>IMA ‚Äî Saint-Tropez</div><div style={{fontSize:11,color:'var(--gris-400)'}}>Ouverture pr√©vue √©t√© 2026</div></div>
            <span className="badge b-warn">En pr√©paration</span>
          </div>
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Int√©grations</div></div></div>
        <div className="card-b">
          {[{n:'Trivec',d:'Caisses & POS',c:'T',bg:'var(--bordeaux-10)',co:'var(--bordeaux)',key:'trivec'},
            {n:'SevenRooms',d:'CRM & R√©servations',c:'7R',bg:'var(--bleu-light)',co:'var(--bleu)',key:'sevenrooms'},
            {n:'Pennylane',d:'Comptabilit√© & Factures',c:'PL',bg:'var(--vert-light)',co:'var(--vert)',key:'pennylane'}
          ].map((x,i)=>(
            <div key={x.key} style={{padding:'10px 0',borderBottom:i<2?'1px solid var(--gris-100)':'none',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div style={{display:'flex',alignItems:'center',gap:10}}>
                <div style={{width:34,height:34,borderRadius:8,background:x.bg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:x.co}}>{x.c}</div>
                <div><div style={{fontWeight:500,fontSize:13}}>{x.n}</div><div style={{fontSize:10,color:'var(--gris-400)'}}>{x.d}</div></div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <div className={`status-indicator ${connectedIntegrations[x.key]?'connected':'disconnected'}`}/>
                <span className={`badge ${connectedIntegrations[x.key]?'b-ok':'b-err'}`}>{connectedIntegrations[x.key]?'Connect√©':'D√©connect√©'}</span>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="card">
        <div className="card-h"><div><div className="card-t">Configuration Pennylane</div><div className="card-st">API Token</div></div></div>
        <div className="card-b">
          <div className="fg">
            <label className="fl">Token API Pennylane</label>
            <div className="pw-toggle">
              <input className="fi" type={showToken?'text':'password'} value={token} onChange={(e)=>setToken(e.target.value)} placeholder="Collez votre token ici"/>
              <button className="pw-toggle-btn" onClick={()=>setShowToken(!showToken)}>{showToken?'Masquer':'Afficher'}</button>
            </div>
            <div style={{fontSize:10,color:'var(--gris-400)',marginTop:4}}>Trouvez votre token dans les param√®tres de votre compte Pennylane</div>
          </div>
          <div className="input-with-btn" style={{marginBottom:8}}>
            <button className="btn btn-primary" onClick={handleSaveToken}>Enregistrer le token</button>
            <button className="btn btn-secondary" onClick={handleTestConnection} disabled={testing}>{testing?'Test en cours...':'Tester la connexion'}</button>
          </div>
          {testStatus&&<div className={testStatus.success?'success-msg':'error-msg'}>
            {testing&&<span className="spinner" style={{marginRight:6,verticalAlign:'middle'}}/>}
            {testStatus.msg}
          </div>}
          {companyInfo&&<div style={{marginTop:12,padding:14,background:'var(--vert-light)',borderRadius:8,fontSize:12}}>
            <div style={{fontWeight:600,color:'var(--vert)',marginBottom:6}}>Compte connect√©</div>
            {(()=>{
              const c=companyInfo.company||companyInfo;
              const u=companyInfo.user||companyInfo;
              const nom=c.name||c.company_name||c.legal_name||'';
              const siren=c.reg_no||c.siren||c.registration_number||'';
              const email=u.email||'';
              const userName=[u.first_name,u.last_name].filter(Boolean).join(' ');
              return(<div>
                {nom?<div><strong>Soci√©t√© :</strong> {nom}</div>:null}
                {siren?<div><strong>SIREN :</strong> {siren}</div>:null}
                {userName?<div><strong>Utilisateur :</strong> {userName}</div>:null}
                {email?<div><strong>Email :</strong> {email}</div>:null}
                {!nom&&!userName?<div style={{color:'var(--vert)'}}>Connexion API OK</div>:null}
              </div>);
            })()}
          </div>}
          {token&&<button className="btn btn-secondary" onClick={handleClearToken} style={{marginTop:8}}>Supprimer le token</button>}
        </div>
      </div>
      <div className="card">
        <div className="card-h"><div><div className="card-t">Utilisateurs du dashboard</div><div className="card-st">{UserManager.getAll().length} compte(s)</div></div>
          <button className="btn btn-sm btn-primary" onClick={()=>setShowInviteModal(true)}>+ Inviter</button>
        </div>
        <div className="card-b">
          {UserManager.getAll().map((u,i,arr)=>(
            <div key={u.id} style={{padding:'10px 0',borderBottom:i<arr.length-1?'1px solid var(--gris-100)':'none',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div style={{display:'flex',alignItems:'center',gap:10}}>
                <div style={{width:32,height:32,borderRadius:'50%',background:'var(--bordeaux)',color:'white',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:600}}>{u.nom?u.nom[0]:'?'}</div>
                <div>
                  <div style={{fontWeight:500,fontSize:13}}>{u.nom}</div>
                  <div style={{fontSize:10,color:'var(--gris-400)'}}>{u.email}</div>
                </div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <span className="badge b-ima">{u.role}</span>
                {u.lastLogin&&<span style={{fontSize:9,color:'var(--gris-400)'}}>Vu {new Date(u.lastLogin).toLocaleDateString('fr-FR')}</span>}
                {UserManager.getAll().length>1&&u.email!==UserManager.getCurrentUser()?.email&&
                  <button className="btn btn-sm" style={{background:'var(--rouge-light)',color:'var(--rouge)',border:'none',padding:'3px 6px',fontSize:9,cursor:'pointer'}} onClick={()=>{if(confirm(`Supprimer ${u.nom} ?`)){UserManager.removeUser(u.id);setInviteStatus({success:true,msg:'Utilisateur supprim√©'});}}}>Supprimer</button>
                }
              </div>
            </div>
          ))}
        </div>
      </div>
      {showInviteModal&&<div className="modal-overlay" onClick={()=>setShowInviteModal(false)}>
        <div className="modal" onClick={e=>e.stopPropagation()}>
          <h3>Inviter un utilisateur <button className="modal-close" onClick={()=>setShowInviteModal(false)}>√ó</button></h3>
          <div className="fg" style={{marginBottom:12}}>
            <label className="fl">Nom complet</label>
            <input className="fi" value={inviteData.nom} onChange={e=>setInviteData(p=>({...p,nom:e.target.value}))} placeholder="Pr√©nom Nom"/>
          </div>
          <div className="fg" style={{marginBottom:12}}>
            <label className="fl">Email</label>
            <input className="fi" type="email" value={inviteData.email} onChange={e=>setInviteData(p=>({...p,email:e.target.value}))} placeholder="email@ima-club.com"/>
          </div>
          <div className="fg-row" style={{marginBottom:12}}>
            <div className="fg">
              <label className="fl">R√¥le</label>
              <select className="fi-select" value={inviteData.role} onChange={e=>setInviteData(p=>({...p,role:e.target.value}))}>
                <option value="Admin">Admin</option>
                <option value="Directeur">Directeur</option>
                <option value="Comptable">Comptable (lecture seule)</option>
                <option value="Viewer">Viewer</option>
              </select>
            </div>
            <div className="fg">
              <label className="fl">Mot de passe temporaire</label>
              <input className="fi" value={inviteData.password} onChange={e=>setInviteData(p=>({...p,password:e.target.value}))} placeholder="G√©n√©r√© auto"/>
            </div>
          </div>
          {inviteStatus&&<div className={inviteStatus.success?'success-msg':'error-msg'} style={{marginBottom:10}}>{inviteStatus.msg}</div>}
          <div style={{display:'flex',gap:10,justifyContent:'flex-end'}}>
            <button className="btn btn-secondary" onClick={()=>setShowInviteModal(false)}>Annuler</button>
            <button className="btn btn-primary" onClick={handleInviteUser}>Envoyer l'invitation</button>
          </div>
        </div>
      </div>}
      <div className="card">
        <div className="card-h"><div><div className="card-t">Objectifs & Seuils</div></div></div>
        <div className="card-b">
          {[{l:'Food Cost max',o:'28%',a:'26.5%',ok:true},{l:'Bar Cost max',o:'20%',a:'17.5%',ok:true},
            {l:'Staff Cost max',o:'30%',a:'28.8%',ok:false},{l:'Prime Cost max',o:'65%',a:'55.3%',ok:true},
            {l:'Ticket moyen min',o:'180‚Ç¨',a:'214‚Ç¨',ok:true}
          ].map((o,i)=>(
            <div key={i} style={{padding:'8px 0',borderBottom:'1px solid var(--gris-100)',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:13}}>
              <div>{o.l}</div>
              <div style={{display:'flex',gap:14,alignItems:'center'}}>
                <span style={{color:'var(--gris-500)'}}>Obj: {o.o}</span>
                <span style={{fontWeight:600}}>Actuel: {o.a}</span>
                <span className={`badge ${o.ok?'b-ok':'b-warn'}`}>{o.ok?'OK':'Attention'}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>);
}

// ===== APP =====
function App(){
  const[currentUser,setCurrentUser]=useState(()=>UserManager.getCurrentUser());
  const[page,setPage]=useState('dashboard');
  const[period,setPeriod]=useState('mois');

  const handleLogin=(user)=>{setCurrentUser({id:user.id,nom:user.nom,email:user.email,role:user.role});};
  const handleLogout=()=>{UserManager.logout();setCurrentUser(null);};

  const nav=[
    {sec:'Pilotage',items:[
      {id:'dashboard',l:'Dashboard',ic:<I.Dash/>},
      {id:'finance',l:'Finance & P&L',ic:<I.Fin/>},
      {id:'costs',l:'Food & Bar Cost',ic:<I.Cost/>},
      {id:'staff',l:'Staff & RH',ic:<I.Staff/>},
    ]},
    {sec:'Op√©rations',items:[
      {id:'stocks',l:'Stocks',ic:<I.Stock/>},
      {id:'crm',l:'CRM & R√©servations',ic:<I.CRM/>},
      {id:'pos',l:'Caisses (Trivec)',ic:<I.POS/>},
      {id:'caisse',l:'Cl√¥ture Caisse',ic:<I.Cash/>},
      {id:'tips',l:'Tips & Pourboires',ic:<I.Tips/>},
    ]},
    {sec:'Syst√®me',items:[
      {id:'settings',l:'Administration',ic:<I.Gear/>},
    ]},
  ];

  const titles={dashboard:'Dashboard',finance:'Finance & P&L',costs:'Food & Bar Cost',staff:'Staff & RH',stocks:'Stocks & Inventaire',crm:'CRM & R√©servations',pos:'Caisses (Trivec)',caisse:'Cl√¥ture de Caisse',tips:'Tips & Pourboires',settings:'Administration'};

  if(!currentUser) return <Login onLogin={handleLogin}/>;

  const P=()=>{switch(page){
    case 'dashboard':return <Dashboard/>;case 'finance':return <Finance/>;case 'costs':return <Costs/>;
    case 'staff':return <StaffPage/>;case 'stocks':return <Stocks/>;case 'crm':return <CRMPage/>;
    case 'pos':return <POSPage/>;case 'caisse':return <CaissePage/>;case 'tips':return <TipsPage/>;case 'settings':return <Settings/>;default:return <Dashboard/>;
  }};

  return(
    <div className="app">
      <aside className="sidebar">
        <div className="sidebar-logo"><h1>IMa</h1><span>Tour de contr√¥le</span></div>
        <nav className="sidebar-nav">
          {nav.map(s=>(
            <div className="nav-sec" key={s.sec}>
              <div className="nav-sec-title">{s.sec}</div>
              {s.items.map(it=>(
                <div key={it.id} className={`nav-item ${page===it.id?'active':''}`} onClick={()=>setPage(it.id)}>
                  {it.ic}{it.l}
                </div>
              ))}
            </div>
          ))}
        </nav>
        <div className="sidebar-foot" style={{cursor:'pointer'}} onClick={handleLogout} title="Se d√©connecter">
          <div className="avatar">{currentUser.nom?currentUser.nom.split(' ').map(w=>w[0]).join(''):'?'}</div>
          <div style={{flex:1}}><div className="uname">{currentUser.nom}</div><div className="urole">{currentUser.role}</div></div>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.5)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </div>
      </aside>
      <main className="main">
        <header className="header">
          <div className="header-l"><h2>{titles[page]}</h2><span className="bc">F√©vrier 2026</span></div>
          <div className="header-r">
            <div className="per">
              {['jour','semaine','mois','ann√©e'].map(p=>(
                <button key={p} className={`per-btn ${period===p?'active':''}`} onClick={()=>setPeriod(p)}>{p[0].toUpperCase()+p.slice(1)}</button>
              ))}
            </div>
            <div className="loc"><I.Pin/><div className="loc-dot"/>Val d'Is√®re<I.Chev/></div>
            <div className="notif"><I.Bell/></div>
          </div>
        </header>
        <div className="page"><P/></div>
      </main>
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
